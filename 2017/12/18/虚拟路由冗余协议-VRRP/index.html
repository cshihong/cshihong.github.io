<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">



  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1.0.0/needsharebutton.min.css">



























  
  
  
  

  

  

  

  

  

  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.6.0">


  <link rel="mask-icon" href="/favicon.ico?v=6.6.0" color="#222">


  <link rel="manifest" href="/images/favicon.ico">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="VRRP简介：定义：虚拟路由冗余协议VRRP（Virtual Router Redundancy Protocol）通过把几台路由设备联合组成一台虚拟的路由设备，将虚拟路由设备的IP地址作为用户的默认网关实现与外部网络通信。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。 目的：VRRP能够在不改变组网的情况下，采用将多台路由设备组成一个虚拟路由器，通过">
<meta name="keywords" content="交换基础">
<meta property="og:type" content="article">
<meta property="og:title" content="虚拟路由冗余协议(VRRP)">
<meta property="og:url" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/index.html">
<meta property="og:site_name" content="曹世宏的博客">
<meta property="og:description" content="VRRP简介：定义：虚拟路由冗余协议VRRP（Virtual Router Redundancy Protocol）通过把几台路由设备联合组成一台虚拟的路由设备，将虚拟路由设备的IP地址作为用户的默认网关实现与外部网络通信。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。 目的：VRRP能够在不改变组网的情况下，采用将多台路由设备组成一个虚拟路由器，通过">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/VRRP报文结构.png">
<meta property="og:image" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/VRRPv3报文结构.png">
<meta property="og:image" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/VRRPv2抓包.png">
<meta property="og:image" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/VRRPv3抓包.png">
<meta property="og:image" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/VRRP综合实验拓扑.png">
<meta property="og:image" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/VRRP信息.png">
<meta property="og:updated_time" content="2019-08-25T01:47:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="虚拟路由冗余协议(VRRP)">
<meta name="twitter:description" content="VRRP简介：定义：虚拟路由冗余协议VRRP（Virtual Router Redundancy Protocol）通过把几台路由设备联合组成一台虚拟的路由设备，将虚拟路由设备的IP地址作为用户的默认网关实现与外部网络通信。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。 目的：VRRP能够在不改变组网的情况下，采用将多台路由设备组成一个虚拟路由器，通过">
<meta name="twitter:image" content="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/VRRP报文结构.png">



  <link rel="alternate" href="/atom.xml" title="曹世宏的博客" type="application/atom+xml">




  <link rel="canonical" href="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>虚拟路由冗余协议(VRRP) | 曹世宏的博客</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3d1d06c1df5d2fe94237f55bad4858bc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">曹世宏的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">记录一些学习资料</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曹世宏">
      <meta itemprop="description" content="你的责任就是你的方向，你的经历就是你的资本，你的性格就是你的命运。">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曹世宏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">虚拟路由冗余协议(VRRP)

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-18 15:29:20" itemprop="dateCreated datePublished" datetime="2017-12-18T15:29:20+08:00">2017-12-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-25 09:47:44" itemprop="dateModified" datetime="2019-08-25T09:47:44+08:00">2019-08-25</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/路由交换/" itemprop="url" rel="index"><span itemprop="name">路由交换</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
			<span class="post-meta-divider">|</span>
			<span title="post.wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span>字数： 8,396</span>
			<span class="post-meta-item-text">|</span>
			<span title="post.min2read"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span>阅读时长： 32</span>

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="VRRP简介："><a href="#VRRP简介：" class="headerlink" title="VRRP简介："></a>VRRP简介：</h1><h2 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h2><p>虚拟路由冗余协议VRRP（Virtual Router Redundancy Protocol）通过把几台路由设备联合组成一台虚拟的路由设备，将虚拟路由设备的IP地址作为用户的默认网关实现与外部网络通信。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。</p>
<h2 id="目的："><a href="#目的：" class="headerlink" title="目的："></a>目的：</h2><p>VRRP能够在不改变组网的情况下，采用将多台路由设备组成一个虚拟路由器，通过配置虚拟路由器的IP地址为默认网关，实现默认网关的备份。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。</p>
<h2 id="收益："><a href="#收益：" class="headerlink" title="收益："></a>收益：</h2><p>在具有多播或广播能力的局域网（如以太网）中，借助VRRP能在网关设备出现故障时仍然提供高可靠的缺省链路，无需修改主机及网关设备的配置信息便可有效避免单一链路发生故障后的网络中断问题。</p>
<h1 id="VRRP原理描述"><a href="#VRRP原理描述" class="headerlink" title="VRRP原理描述"></a>VRRP原理描述</h1><h2 id="VRRP概述："><a href="#VRRP概述：" class="headerlink" title="VRRP概述："></a>VRRP概述：</h2><ul>
<li>VRRP路由器（VRRP Router）：运行VRRP协议的设备，它可能属于一个或多个虚拟路由器。</li>
<li>虚拟路由器（Virtual Router）：又称VRRP备份组，由一个Master设备和多个Backup设备组成，被当作一个共享局域网内主机的缺省网关。</li>
<li>Master路由器（Virtual Router Master）：承担转发报文任务的VRRP设备。</li>
<li>Backup路由器（Virtual Router Backup）：一组没有担转发任务的VRRP设备，当Master设备出现故障时，它们将通过竞选成为新的Master设备。</li>
<li>VRID：虚拟路由器的标识。</li>
<li>虚拟IP地址(Virtual IP Address)：虚拟路由器的IP地址，一个虚拟路由器可以有一个或多个IP地址，由用户配置。</li>
<li>IP地址拥有者（IP Address Owner）：<strong>如果一个VRRP设备将虚拟路由器IP地址作为真实的接口地址，则该设备被称为IP地址拥有者。如果IP地址拥有者是可用的，通常它将成为Master。</strong></li>
<li>虚拟MAC地址（Virtual MAC Address）：虚拟路由器根据虚拟路由器ID生成的MAC地址。一个虚拟路由器拥有一个虚拟MAC地址，<strong>格式为：00-00-5E-00-01-{VRID}(VRRP for IPv4)；00-00-5E-00-02-{VRID}(VRRP for IPv6)。</strong>当虚拟路由器回应ARP请求时，使用虚拟MAC地址，而不是接口的真实MAC地址。</li>
</ul>
<h2 id="VRRP报文："><a href="#VRRP报文：" class="headerlink" title="VRRP报文："></a>VRRP报文：</h2><p>VRRP协议报文用来将Master设备的优先级和状态通告给同一备份组的所有Backup设备。</p>
<p>VRRP协议报文封装在IP报文中，发送到分配给VRRP的IP组播地址。<strong>在IP报文头中，源地址为发送报文接口的主IP地址（不是虚拟IP地址），目的地址是224.0.0.18，TTL是255，协议号是112。</strong></p>
<p>VRRP报文的IP头中，TTL必须为255。当VRRP路由器收到TTL不等于255的VRRP协议报文后，必须丢弃。</p>
<p>主IP地址（Primary IP Address）：从接口的真实IP地址中选出来的一个主用IP地址，通常选择配置的第一个IP地址。</p>
<p>目前，VRRP协议包括两个版本：VRRPv2和VRRPv3。VRRPv2仅适用于IPv4网络，VRRPv3适用于IPv4和IPv6两种网络。</p>
<p>基于不同的网络类型，VRRP可以分为VRRP for IPv4和VRRP for IPv6（简称VRRP6）。VRRP for IPv4支持VRRPv2和VRRPv3，而VRRP for IPv6仅支持VRRPv3。</p>
<h3 id="VRRP报文结构："><a href="#VRRP报文结构：" class="headerlink" title="VRRP报文结构："></a>VRRP报文结构：</h3><p><img src="/2017/12/18/虚拟路由冗余协议-VRRP/VRRP报文结构.png" alt="VRRP报文结构"></p>
<p><center>图：VRRPv2报文结构<center></center></center></p>
<p><img src="/2017/12/18/虚拟路由冗余协议-VRRP/VRRPv3报文结构.png" alt="VRRPv3报文结构"></p>
<p><center>图：VRRPv3报文结构<center></center></center></p>
<h3 id="字段解释："><a href="#字段解释：" class="headerlink" title="字段解释："></a>字段解释：</h3><table>
<thead>
<tr>
<th>字段</th>
<th>长度</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Version</td>
<td>4比特</td>
<td>指VRRP协议版本，VRRPv2此字段为2，VRRPv3此字段为3。</td>
</tr>
<tr>
<td>Type</td>
<td>4比特</td>
<td>定义了VRRP报文的类型。本版本的协议仅定义了一个报文类型：1：ADVERTISEMENT 带有未知类型的报文必须被丢弃。</td>
</tr>
<tr>
<td>Virtual Rtr ID8</td>
<td>8比特</td>
<td>虚拟路由器标识（VRID）字段标识了此报文所报告状态的虚拟路由器。可配置的范围是1–255。没有缺省值。</td>
</tr>
<tr>
<td>Priority</td>
<td>8比特</td>
<td>Priority字段申明了发送此报文的VRRP路由器的优先级。值越高优先级越高。该字段为8位无符号整型。<strong>如果VRRP路由器是虚拟路由器地址的IP地址所有者，那么其优先级必须为255。起备用作用的VRRP路由器的优先级必须在1–254之间。缺省的VRRP路由器优先级为100。优先级值0 用于指示当前虚拟路由器的主路由器停止参与VRRP组。主要用于触发备用路由器快速地迁移到主路由器，而不用等待当前主路由器超时。</strong></td>
</tr>
<tr>
<td>Count IP Addrs</td>
<td>8比特</td>
<td>在此VRRP通告中包含的IP地址的数量。</td>
</tr>
<tr>
<td>Auth Type</td>
<td>8比特</td>
<td>认证类型字段用于标识要用到的认证方法。在一个虚拟路由器组内认证类型是唯一的。认证类型字段是一个8位无符号整型。如果报文携带未知的认证类型或者该认证类型和本地配置的认证方法不匹配，那么该报文必须被丢弃。目前定义的认证方法有：0 : No Authentication 不认证该认证类型表明VRRP协议报文的交换不需要认证。在发送VRRP协议报文时，Authentication Data 字段将被置为0；而在接收协议报文时，Authentication Data 字段被忽略。 1 :   Simple Text Password，表示明文认证方式。2: IP Authentication Header，表示MD5认证方式。</td>
</tr>
<tr>
<td>Adver Int</td>
<td>8比特</td>
<td>VRRP通告间隔时间，单位为秒。缺省为1秒。这个字段主要用于错误配置路由器时的故障定位和解决。</td>
</tr>
<tr>
<td>Checksum</td>
<td>16比特</td>
<td>16位校验和，用于检测VRRP报文中的数据破坏情况。</td>
</tr>
<tr>
<td>IP Address</td>
<td>32比特</td>
<td>VRRP备份组的虚拟IPv4地址 或者虚拟IPv6地址</td>
</tr>
<tr>
<td>Authentication Data</td>
<td>32比特</td>
<td>VRRP报文的认证字。目前只有明文认证和MD5认证才用到该部分，对于其它认证方式，一律填0。</td>
</tr>
</tbody>
</table>
<h3 id="VRRP报文主要区别："><a href="#VRRP报文主要区别：" class="headerlink" title="VRRP报文主要区别："></a>VRRP报文主要区别：</h3><ul>
<li><p>支持的网络类型不同。VRRPv3适用于IPv4和IPv6两种网络，而VRRPv2仅适用于IPv4网络。</p>
</li>
<li><p>认证功能不同。VRRPv3不支持认证功能，而VRRPv2支持认证功能。</p>
<p>VRRPv2版本保留报文的认证字段，是为了兼容早期版本（RFC2338），VRRP认证并不能提高安全性。</p>
</li>
<li><p>发送通告报文的时间间隔的单位不同。VRRPv3支持的是厘秒级，而VRRPv2支持的是秒级。</p>
</li>
</ul>
<h3 id="VRRP认证："><a href="#VRRP认证：" class="headerlink" title="VRRP认证："></a>VRRP认证：</h3><ul>
<li>无认证方式：设备对要发送的VRRP通告报文不进行任何认证处理，收到通告报文的设备也不进行任何认证，认为收到的都是真实的、合法的VRRP报文。</li>
<li>简单字符（Simple）认证方式：发送VRRP通告报文的设备将认证方式和认证字填充到通告报文中，而收到通告报文的设备则会将报文中的认证方式和认证字与本端配置的认证方式和认证字进行匹配。如果相同，则认为接收到的报文是合法的VRRP通告报文；否则认为接收到的报文是一个非法报文，并丢弃这个报文。</li>
<li>MD5认证方式：发送VRRP通告报文的设备利用MD5算法对认证字进行加密，加密后保存在Authentication Data字段中。收到通告报文的设备会对报文中的认证方式和解密后的认证字进行匹配，检查该报文的合法性。</li>
</ul>
<h3 id="VRRP报文抓包示例："><a href="#VRRP报文抓包示例：" class="headerlink" title="VRRP报文抓包示例："></a>VRRP报文抓包示例：</h3><p><img src="/2017/12/18/虚拟路由冗余协议-VRRP/VRRPv2抓包.png" alt="VRRPv2抓包"></p>
<p><center>图：VRRPv2报文抓包示例<center></center></center></p>
<p><img src="/2017/12/18/虚拟路由冗余协议-VRRP/VRRPv3抓包.png" alt="VRRPv3抓包"></p>
<p><center>图：VRRPv3报文抓包示例<center></center></center></p>
<h2 id="VRRP工作原理："><a href="#VRRP工作原理：" class="headerlink" title="VRRP工作原理："></a>VRRP工作原理：</h2><h3 id="VRRP状态机："><a href="#VRRP状态机：" class="headerlink" title="VRRP状态机："></a>VRRP状态机：</h3><p>VRRP协议中定义了三种状态机：初始状态（Initialize）、活动状态（Master）、备份状态（Backup）。其中，只有处于Master状态的设备才可以转发那些发送到虚拟IP地址的报文。</p>
<h4 id="Initialize："><a href="#Initialize：" class="headerlink" title="Initialize："></a>Initialize：</h4><ul>
<li>该状态为VRRP不可用状态，在此状态时设备不会对VRRP报文做任何处理。</li>
<li>通常刚配置VRRP时或设备检测到故障时会进Initialize状态。</li>
<li>收到接口Up的消息后，如果设备的优先级为255，则直接成为Master设备；如果设备的优先级小于255，则会先切换至Backup状态。</li>
</ul>
<h4 id="Masster："><a href="#Masster：" class="headerlink" title="Masster："></a>Masster：</h4><p>当VRRP设备处于Master状态时，它将会做下列工作：</p>
<ul>
<li>定时（Advertisement Interval）发送VRRP通告报文。</li>
<li>以虚拟MAC地址响应对虚拟IP地址的ARP请求。</li>
<li>转发目的MAC地址为虚拟MAC地址的IP报文。</li>
<li>如果它是这个虚拟IP地址的拥有者，则接收目的IP地址为这个虚拟IP地址的IP报文。否则，丢弃这个IP报文。</li>
<li>如果收到比自己优先级大的报文，立即成为Backup。</li>
<li>如果收到与自己优先级相等的VRRP报文且本地接口IP地址小于对端接口IP，立即成为Backup。</li>
</ul>
<h4 id="Backup："><a href="#Backup：" class="headerlink" title="Backup："></a>Backup：</h4><ul>
<li><p>当VRRP设备处于Backup状态时，它将会做下列工作：</p>
</li>
<li><p>接收Master设备发送的VRRP通告报文，判断Master设备的状态是否正常。</p>
</li>
<li><p>对虚拟IP地址的ARP请求，不做响应。</p>
</li>
<li><p>丢弃目的IP地址为虚拟IP地址的IP报文。</p>
</li>
<li><p>如果收到优先级和自己相同或者比自己大的报文，则重置Master_Down_Interval定时器，不进一步比较IP地址。</p>
<p>Master_Down_Interval定时器：Backup设备在该定时器超时后仍未收到通告报文，则会转换为Master状态。计算公式如下：Master_Down_Interval=(3*Advertisement_Interval) + Skew_time。其中，Skew_Time=(256–Priority)/256。</p>
</li>
<li><p>如果收到比自己优先级小的报文且该报文优先级是0时，定时器时间设置为Skew_time（偏移时间），如果该报文优先级不是0，丢弃报文，立刻成为Master。</p>
</li>
</ul>
<h3 id="VRRP的工作过程："><a href="#VRRP的工作过程：" class="headerlink" title="VRRP的工作过程："></a>VRRP的工作过程：</h3><p>VRRP的工作过程如下：</p>
<ol>
<li>VRRP备份组中的设备根据优先级选举出Master。Master设备通过发送免费ARP报文，将虚拟MAC地址通知给与它连接的设备或者主机，从而承担报文转发任务。</li>
<li>Master设备周期性向备份组内所有Backup设备发送VRRP通告报文，以公布其配置信息（优先级等）和工作状况。</li>
<li>如果Master设备出现故障，VRRP备份组中的Backup设备将根据优先级重新选举新的Master。</li>
<li>VRRP备份组状态切换时，Master设备由一台设备切换为另外一台设备，新的Master设备会立即发送携带虚拟路由器的虚拟MAC地址和虚拟IP地址信息的免费ARP报文，刷新与它连接的主机或设备中的MAC表项，从而把用户流量引到新的Master设备上来，整个过程对用户完全透明。</li>
<li>原Master设备故障恢复时，若该设备为IP地址拥有者（优先级为255），将直接切换至Master状态。若该设备优先级小于255，将首先切换至Backup状态，且其优先级恢复为故障前配置的优先级。</li>
<li>Backup设备的优先级高于Master设备时，由Backup设备的工作方式（抢占方式和非抢占方式）决定是否重新选举Master。<ul>
<li>抢占模式：在抢占模式下，如果Backup设备的优先级比当前Master设备的优先级高，则主动将自己切换成Master。</li>
<li>非抢占模式：在非抢占模式下，只要Master设备没有出现故障，Backup设备即使随后被配置了更高的优先级也不会成为Master设备。</li>
</ul>
</li>
</ol>
<ul>
<li>Master设备的选举。</li>
<li>Master设备状态的通告</li>
</ul>
<p><strong>Master设备的选举</strong></p>
<p>VRRP根据优先级来确定虚拟路由器中每台设备的角色（Master设备或Backup设备）。优先级越高，则越有可能成为Master设备。</p>
<ul>
<li>如果VRRP报文中Master设备的优先级高于或等于自己的优先级，则Backup设备保持Backup状态。</li>
<li>如果VRRP报文中Master设备的优先级低于自己的优先级，采用抢占方式的Backup设备将切换至Master状态，采用非抢占方式的Backup设备仍保持Backup状态。</li>
<li>如果多个VRRP设备同时切换到Master状态，通过VRRP通告报文的交互进行协商后，优先级较低的VRRP设备将切换成Backup状态，优先级最高的VRRP设备成为最终的Master设备；优先级相同时，VRRP设备上VRRP备份组所在接口主IP地址较大的成为Master设备。</li>
<li>如果创建的VRRP设备为IP地址拥有者，收到接口Up的消息后，将会直接切换至Master状态。</li>
</ul>
<p><strong>Master设备状态的通告</strong></p>
<ul>
<li>当Master设备主动放弃Master地位（如Master设备退出备份组）时，会发送优先级为0的通告报文，用来使Backup设备快速切换成Master设备，而不用等到Master_Down_Interval定时器超时。这个切换的时间称为Skew time，计算方式为：（256－Backup设备的优先级）/256，单位为秒。</li>
<li>当Master设备发生网络故障而不能发送通告报文的时候，Backup设备并不能立即知道其工作状况。等到Master_Down_Interval定时器超时后，才会认为Master设备无法正常工作，从而将状态切换为Master。其中，Master_Down_Interval定时器取值为：3×Advertisement_Interval＋Skew_time，单位为秒。</li>
</ul>
<blockquote>
<p>在性能不稳定的网络中，网络堵塞可能导致Backup设备在Master_Down_Interval期间没有收到Master设备的报文，Backup设备则会主动切换为Master。如果此时原Master设备的报文又到达了，新Master设备将再次切换回Backup。如此则会出现VRRP备份组成员状态频繁切换的现象。为了缓解这种现象，可以配置抢占延时，使得Backup设备在等待了Master_Down_Interval后，再等待抢占延迟时间。如在此期间仍没有收到通告报文，Backup设备才会切换为Master设备。</p>
</blockquote>
<h2 id="VRRP负载分担："><a href="#VRRP负载分担：" class="headerlink" title="VRRP负载分担："></a>VRRP负载分担：</h2><p>负载分担是指多个VRRP备份组同时承担业务，VRRP负载分担与VRRP主备备份的基本原理和报文协商过程都是相同的。同样对于每一个VRRP备份组，都包含一个Master设备和若干Backup设备。与主备备份方式不同点在于：负载分担方式需要建立多个VRRP备份组，各备份组的Master设备可以不同；同一台VRRP设备可以加入多个备份组，在不同的备份组中具有不同的优先级。</p>
<h3 id="多网关负载分担："><a href="#多网关负载分担：" class="headerlink" title="多网关负载分担："></a>多网关负载分担：</h3><p>通过创建多个带虚拟IP地址的VRRP备份组，为不同的用户指定不同的VRRP备份组作为网关，实现负载分担。</p>
<h2 id="VRRP笔记："><a href="#VRRP笔记：" class="headerlink" title="VRRP笔记："></a>VRRP笔记：</h2><p>VRRP报文通告是通过组播来通告的，组播地址：224.0.0.18,组播MAC：01-00-5e-00-00-12,VRRP是三层协议，通过IP协议承载，协议号112。同时IP包中的TTL值为255。</p>
<p>VRRP需要通过VRRP报文来选举Master和Backup,只有Master才能装发数据，而backup不装发数据，收到数据帧后丢弃。</p>
<h3 id="如何选举Master和Backup？"><a href="#如何选举Master和Backup？" class="headerlink" title="如何选举Master和Backup？"></a>如何选举Master和Backup？</h3><ol>
<li><p>比较优先级，默认情况下优先级为100，最大可以配置的优先级为1-254，优先级越大越优。</p>
<p>255（V-IP = Interface ip），优先级如果为0，说明退出Master（Master离组，例如在Master的接口下删除VRRP配置）</p>
</li>
<li><p>如果优先级一样，IP地址大的一端成为Master。</p>
</li>
</ol>
<p>Master：</p>
<ol>
<li>可以装发报文。</li>
<li>应答 ARP请求。</li>
<li>通告基于VIP的免费ARP。</li>
<li>master定时通告VRRP报文。</li>
</ol>
<p>Backup：</p>
<ol>
<li>如果backup接收到目标mac为虚拟mac地址的数据帧，丢弃不转发。</li>
<li>backup被动接收vrrp报文，不通告。</li>
</ol>
<h3 id="影响VRRP协商的条件："><a href="#影响VRRP协商的条件：" class="headerlink" title="影响VRRP协商的条件："></a>影响VRRP协商的条件：</h3><ol>
<li>IP包头中的TTL值必须为255.</li>
<li>版本必须一致。</li>
<li>VRRP报文中的字段必须一致。（Authen date）</li>
<li>VRID必须一致。</li>
<li>认证类型和认证必须一致。</li>
<li>VIP（Count ip address）列表必须一致。</li>
<li>VRRP报文通告间隔必须一致（华为Backup会使用master端的通告间隔）</li>
<li>checksum必须一致。</li>
</ol>
<h1 id="VRRP应用"><a href="#VRRP应用" class="headerlink" title="VRRP应用"></a>VRRP应用</h1><h2 id="VRRP与接口状态联动监视上行接口："><a href="#VRRP与接口状态联动监视上行接口：" class="headerlink" title="VRRP与接口状态联动监视上行接口："></a>VRRP与接口状态联动监视上行接口：</h2><p>VRRP备份组只能感知其所在接口状态的变化，当VRRP设备上行接口或直连链路发生故障时，VRRP无法感知，此时会引起业务流量中断。通过部署VRRP与接口状态联动监视上行接口可以有效地解决上述问题，当Master设备的上行接口或直连链路发生故障时，通过调整自身优先级，触发主备切换，确保流量正常转发。</p>
<ul>
<li>如果VRRP设备上配置以Increased方式监视一个接口，当被监视的接口状态变成Down后，该VRRP设备的优先级增加指定值。</li>
<li>如果VRRP设备上配置以Reduced方式监视一个接口，当被监视的接口状态变为Down后，该VRRP设备的优先级降低指定值。</li>
</ul>
<h2 id="VRRP与BFD-NQA-路由联动监视上行链路："><a href="#VRRP与BFD-NQA-路由联动监视上行链路：" class="headerlink" title="VRRP与BFD/NQA/路由联动监视上行链路："></a>VRRP与BFD/NQA/路由联动监视上行链路：</h2><p>VRRP只能感知VRRP备份组之间的故障，而配置VRRP监视上行接口仅能感知Master设备上行接口或直连链路的故障，当Master设备上行非直连链路故障时，VRRP无法感知，此时会导致用户流量丢失。通过部署VRRP与BFD/NQA/路由联动监视上行链路，可以有效地解决上述问题。通过配置BFD/NQA/路由检测Master上行链路的连通状况，当Master设备的上行链路发生故障时，BFD/NQA/路由可以快速检测故障并通知Master设备调整自身优先级，触发主备切换，确保流量正常转发。</p>
<h2 id="VRRP与BFD联动实现快速切换："><a href="#VRRP与BFD联动实现快速切换：" class="headerlink" title="VRRP与BFD联动实现快速切换："></a>VRRP与BFD联动实现快速切换：</h2><p>VRRP备份组通过收发VRRP协议报文进行主备状态的协商，以实现设备的冗余备份功能。当VRRP备份组之间的链路出现故障时，Backup设备需要等待Master_Down_Interval后才能感知故障并切换为Master设备，切换时间通常在3秒以上。在等待切换期间内，业务流量仍会发往Master设备，此时会造成数据丢失。通过部署VRRP与BFD联动功能，可以有效解决上述问题。通过在Master设备和Backup设备之间建立BFD会话并与VRRP备份组进行绑定，快速检测VRRP备份组之间的连通状态，并在出现故障时及时通知VRRP备份组进行主备切换，实现了毫秒级的切换速度，减少了流量丢失。</p>
<p>VRRP支持与静态的BFD会话类型或静态标识符自协商的BFD会话类型的联动。</p>
<h1 id="VRRP配置"><a href="#VRRP配置" class="headerlink" title="VRRP配置"></a>VRRP配置</h1><h2 id="配置注意事项："><a href="#配置注意事项：" class="headerlink" title="配置注意事项："></a>配置注意事项：</h2><p>在路由器上部署VRRP功能时需注意：</p>
<ul>
<li>不同备份组之间的虚拟IP地址不能重复，并且必须和接口的IP地址在同一网段。</li>
<li>保证同一备份组的设备上配置相同的备份组号（<em>virtual-router-id</em>）。</li>
<li>不同接口上可以绑定相同<em>virtual-router-id</em>的VRRP备份组。</li>
<li>在设备上同时配置VRRP和静态ARP时，需要注意：当在Dot1q终结子接口、QinQ终结子接口或者VLANIF接口下配置VRRP时，不能将与这些接口相关的静态ARP表项对应的映射IP地址作为VRRP的虚拟地址。否则会生成错误的主机路由，影响设备之间的正常转发。</li>
<li>如果VRRP备份组内各路由器上配置的VRRP协议版本不同，可能导致VRRP报文不能互通。</li>
</ul>
<p>缺省配置：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>缺省值</th>
</tr>
</thead>
<tbody>
<tr>
<td>设备在VRRP备份组中的优先级</td>
<td>100</td>
</tr>
<tr>
<td>抢占方式</td>
<td>立即抢占</td>
</tr>
<tr>
<td>通告报文发送间隔</td>
<td>1秒</td>
</tr>
<tr>
<td>发送免费ARP报文时间间隔</td>
<td>120秒</td>
</tr>
</tbody>
</table>
<h2 id="配置基于IPv4的VRRP基本功能："><a href="#配置基于IPv4的VRRP基本功能：" class="headerlink" title="配置基于IPv4的VRRP基本功能："></a>配置基于IPv4的VRRP基本功能：</h2><h3 id="创建VRRP备份组："><a href="#创建VRRP备份组：" class="headerlink" title="创建VRRP备份组："></a>创建VRRP备份组：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[接口视图] vrrp vrid <span class="number">1</span> <span class="keyword">virtual</span>-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line"><span class="comment">//创建VRRP备份组并给备份组配置虚拟IP地址。</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>多网关负载分担</p>
<p>实现多网关负载分担，需要重复执行上述“主备备份”的操作步骤，在接口上配置两个或多个VRRP备份组，各备份组之间以备份组号（<em>virtual-router-id</em>）区分。</p>
</li>
</ul>
<h3 id="配置设备在备份组中的优先级："><a href="#配置设备在备份组中的优先级：" class="headerlink" title="配置设备在备份组中的优先级："></a>配置设备在备份组中的优先级：</h3><p>VRRP根据优先级决定设备在备份组中的地位，优先级越高，越可能成为Master设备。通过配置优先级，可以指定Master设备，以承担流量转发业务。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[接口视图] vrrp vrid <span class="number">1</span> priority <span class="number">100</span></span><br><span class="line"><span class="comment">//配置路由器在备份组中的优先级。</span></span><br><span class="line"><span class="comment">//缺省情况下，优先级的取值是100。数值越大，优先级越高。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>优先级0被系统保留作为特殊用途；优先级值255保留给IP地址拥有者。通过命令可以配置的优先级取值范围是1～254。</li>
<li>IP地址拥有者的优先级固定为255，用户不能手动修改。但是，用户可以通过<strong>vrrp vrid virtual-router-id priority priority-value</strong>为IP地址拥有者配置一个非255的优先级（该优先级不会取代255，不生效），当VRRP备份组不再是IP地址拥有者时，其优先级为配置的优先级。</li>
<li>优先级取值相同的情况下，同时竞争Master时，备份组所在接口的主IP地址较大的成为Master设备；VRRP备份组中先切换至Master状态的设备为Master设备，其余Backup设备不再进行抢占。</li>
</ul>
<h3 id="配置VRRP协议的版本："><a href="#配置VRRP协议的版本：" class="headerlink" title="配置VRRP协议的版本："></a>配置VRRP协议的版本：</h3><p>基于IPv4的VRRP支持VRRPv2和VRRPv3两个版本。如果VRRP备份组内各路由器上配置的协议版本不同，可能导致VRRP报文不能互通。</p>
<ul>
<li>配置了v2版本的备份组：只能发送和接收v2版本的VRRP通告报文。如果接收到v3版本的VRRP通告报文，则将此报文丢弃。</li>
<li>配置了v3版本的备份组：能接收v2或v3版本的VRRP通过报文，发送报文的格式可以选择配置，包括仅发送v2版本报文、仅发送v3版本报文和既发送v2版本报文也发送v3版本报文。使用时可以根据需要进行配置。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vrrp version &#123; v2 | v3 &#125;</span><br><span class="line"><span class="comment">//配置当前设备的VRRP协议版本号。 默认v2。</span></span><br><span class="line"></span><br><span class="line">vrrp version<span class="number">-3</span> send-packet-mode &#123; v2-noly | v3-only | v2v3-both &#125;</span><br><span class="line"><span class="comment">//配置VRRPv3发送通告报文的模式。</span></span><br><span class="line"><span class="comment">//缺省情况下，VRRPv3版本备份组发送通告报文的模式为v3-only。</span></span><br></pre></td></tr></table></figure>
<h3 id="配置VRRP的时间参数"><a href="#配置VRRP的时间参数" class="headerlink" title="配置VRRP的时间参数:"></a>配置VRRP的时间参数:</h3><table>
<thead>
<tr>
<th>功能</th>
<th>应用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>配置VRRP通告报文的发送间隔</td>
<td>Master设备定时（Advertisement_Interval）向组内的Backup设备发送VRRP通告报文，通告自己工作正常。如果Backup设备在Master_Down_Interval定时器超时后仍未收到VRRP通告报文，则重新选举Master。网络流量过大或设备的定时器差异等因素会导致Backup设备无法及时接收到VRRP报文而发生状态转换，当原Master发送的报文到达新Master时，新Master将再次发生状态切换。通过延长Master设备发送VRRP报文的时间间隔可以解决此类问题。</td>
</tr>
<tr>
<td>配置路由器在VRRP备份组中的抢占延时</td>
<td>在不稳定的网络中，可能存在VRRP备份组监测的BFD等状态频繁振荡或Backup设备不能及时收到VRRP通告报文的情况，导致VRRP发生频繁切换而造成网络振荡。通过调整路由器在VRRP备份组中的抢占延时，使Backup设备在指定的时间后再进行抢占，有效避免了VRRP备份组状态的频繁切换。</td>
</tr>
<tr>
<td>配置Master设备发送免费ARP报文的超时时间</td>
<td>VRRP备份组中，为了确保下游交换机的MAC表项正确，Master设备会定时发送免费ARP报文，用来刷新下游交换机上的MAC地址表项。说明： 为避免VRRP协议震荡，请不要在VRRP备用设备上把系统MAC或VRRP虚MAC等一些特殊的MAC地址配置成黑洞MAC。</td>
</tr>
<tr>
<td>配置VRRP备份组的状态恢复延迟时间</td>
<td>在不稳定的网络中，VRRP备份组监测的BFD或接口等状态频繁振荡会导致VRRP备份组状态频繁切换。通过配置VRRP备份组的状态恢复延迟时间，VRRP备份组在接收到接口或BFD会话的Up事件时不会立刻响应，而是等待配置的状态恢复的延迟时间后，再进行相应的处理，防止因接口或BFD会话的频繁震荡而导致的VRRP状态的频繁切换。</td>
</tr>
</tbody>
</table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[接口视图] vrrp vrid <span class="number">1</span> timer advertise <span class="number">1</span></span><br><span class="line">  <span class="comment">//置发送VRRP通告报文的时间间隔。 </span></span><br><span class="line">  <span class="comment">//缺省情况下，发送VRRP通告报文的时间间隔是1秒。</span></span><br><span class="line">  </span><br><span class="line"> [接口视图] vrrp vrid <span class="number">1</span> preempt-mode timer delay <span class="number">0</span></span><br><span class="line"> <span class="comment">//配置备份组中路由器的抢占延迟时间。 </span></span><br><span class="line"> <span class="comment">//缺省情况下，抢占延迟时间为0，即立即抢占。</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> preempt-mode disable</span><br><span class="line"> <span class="comment">//设置备份组中路由器采用非抢占方式。</span></span><br><span class="line"> </span><br><span class="line"> vrrp gratuitous-arp timeout <span class="number">120</span></span><br><span class="line"><span class="comment">//配置Master发送免费ARP报文的超时时间。 </span></span><br><span class="line"><span class="comment">//缺省情况下，Master每隔120秒发送一次免费ARP报文。</span></span><br><span class="line">vrrp gratutious-arp timeout disable</span><br><span class="line"><span class="comment">//禁止发送免费ARP</span></span><br><span class="line"></span><br><span class="line">vrrp recover-deley <span class="number">0</span></span><br><span class="line"><span class="comment">//配置VRRP备份组的状态恢复延迟时间。 </span></span><br><span class="line"><span class="comment">//缺省情况下，VRRP备份组状态恢复延迟时间为0秒。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在配置VRRP备份组内各路由器的延迟方式时，建议Backup设备配置为立即抢占，Master设备配置为延时抢占，指定一定的延迟时间。这样配置的目的是为了在网络环境不稳定时，为上下行链路的状态恢复一致性等待一定时间，以免出现双Master设备或由于主备双方频繁抢占导致用户设备学习到错误的Master设备地址。</li>
<li>配置的Master设备发送免费ARP报文超时时间应小于用户侧设备的MAC地址表项老化时间。</li>
</ul>
<h3 id="配置VRRP报文在Sub-VLAN中的发送方式："><a href="#配置VRRP报文在Sub-VLAN中的发送方式：" class="headerlink" title="配置VRRP报文在Sub-VLAN中的发送方式："></a>配置VRRP报文在Sub-VLAN中的发送方式：</h3><p>当VRRP备份组配置在VLAN聚合时，用户可以通过命令行配置，使VRRP报文在指定的Sub-VLAN中传输，避免VRRP通告报文在所有Sub-VLAN内广播，以节约网络带宽。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vrrp advertise send-mode &#123; sub-vlan | all&#125;</span><br><span class="line"><span class="comment">//配置VRRP通告报文在Super-VLAN中的发送方式。</span></span><br></pre></td></tr></table></figure>
<p>缺省情况下，Master设备向Super-VLAN中状态为Up且VLAN ID最小的Sub-VLAN发送VRRP通告报文。</p>
<ul>
<li>如果指定参数<em>sub-vlan-id</em>，VRRP通告报文只发送给指定ID的Sub-VLAN。</li>
<li>如果指定参数<strong>all</strong>，VRRP通告报文发送给本Super-VLAN的所有Sub-VLAN。</li>
</ul>
<h3 id="配置禁止检测VRRP报文跳数："><a href="#配置禁止检测VRRP报文跳数：" class="headerlink" title="配置禁止检测VRRP报文跳数："></a>配置禁止检测VRRP报文跳数：</h3><p>系统对收到的VRRP通告报文的TTL值进行检测，如果TTL值不等于255，则丢弃这个报文。在不同设备制造商的设备配合使用的组网环境中，检测VRRP报文的TTL值可能导致错误地丢弃合法报文，此时用户可以配置系统不检测VRRP报文的TTL值，以实现不同设备制造商设备之间的互通。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vrrp un-check ttl</span><br><span class="line"><span class="comment">//禁止检测VRRP报文的TTL值。</span></span><br></pre></td></tr></table></figure>
<h3 id="配置VRRP报文的认证方式："><a href="#配置VRRP报文的认证方式：" class="headerlink" title="配置VRRP报文的认证方式："></a>配置VRRP报文的认证方式：</h3><p>VRRPv2支持在通告报文中设定不同的认证方式和认证字。</p>
<ul>
<li>无认证方式：设备对要发送的VRRP通告报文不进行任何认证处理，收到通告报文的设备也不进行任何认证，认为收到的都是真实的、合法的VRRP报文。</li>
<li>简单字符（Simple）认证方式：发送VRRP通告报文的设备将认证方式和认证字填充到通告报文中，而收到通告报文的设备则会将报文中的认证方式和认证字与本端配置的认证方式和认证字进行匹配。如果相同，则认为接收到的报文是合法的VRRP通告报文；否则认为接收到的报文是一个非法报文，并丢弃这个报文。</li>
<li>MD5认证方式：发送VRRP通告报文的设备利用MD5算法对认证字进行加密，加密后保存在Authentication Data字段中。收到通告报文的设备会对报文中的认证方式和解密后的认证字进行匹配，检查该报文的合法性。</li>
</ul>
<blockquote>
<p>注：目前仅VRRPv2版本支持认证，VRRPv3版本不支持认证。VRRPv2版本保留报文的认证字段，是为了兼容早期版本（RFC2338），VRRP认证并不能提高安全性。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vrrp vrid <span class="number">1</span> authentication-mode &#123; simple &#123;key | plain key | cipher cipher-key&#125; | md5 md5-key&#125;</span><br><span class="line"><span class="comment">//配置VRRP报文认证方式。</span></span><br></pre></td></tr></table></figure>
<h3 id="使能虚拟IP地址Ping功能："><a href="#使能虚拟IP地址Ping功能：" class="headerlink" title="使能虚拟IP地址Ping功能："></a>使能虚拟IP地址Ping功能：</h3><p>路由器支持对虚拟IP地址的Ping功能，可用于：</p>
<ul>
<li>检测备份组中的Master设备是否起作用。</li>
<li>检测是否能通过使用某虚拟IP地址作为默认网关与外部通信。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vrrp <span class="keyword">virtual</span>-ip ping enable</span><br><span class="line"><span class="comment">//使能虚拟地址可达性功能。 </span></span><br><span class="line"><span class="comment">//缺省情况下，该功能处于使能状态，Master设备响应对本备份组虚拟IP地址的Ping报文。</span></span><br><span class="line"></span><br><span class="line">vrrp arp send-mode simple</span><br><span class="line"><span class="comment">//使能Master设备使用QinQ终结子接口下配置的外层Tag</span></span><br><span class="line"><span class="comment">//的VLAN和内层Tag段内的第一个VLAN发送免费ARP报文。</span></span><br></pre></td></tr></table></figure>
<h2 id="VRRP配置综合实验示例："><a href="#VRRP配置综合实验示例：" class="headerlink" title="VRRP配置综合实验示例："></a>VRRP配置综合实验示例：</h2><p>如下图拓扑，AR1，AR2为内网路由器，配置VRRP虚拟IP实现备份。同时在AR1与AR2之间配置了BFD，使它们之间可以快速检测链路故障。</p>
<p>AR3,4,5为外网路由器。在AR1与AR3上配置了上行接口检测，当上行接口GE1/0/0状态Down时，VRRP备份组能够及时感知并进行主备切换，由AR2接替作为网关继续承担业务转发，以减小接口状态Down对业务传输的影响。</p>
<p>在AR2和上还配置了IP检测，检测到4.4.4.4 的链路是否有故障。 配置VRRP与路由联动监视上行链路。当非直连上行链路Down时，VRRP优先级自动降低，实现主备快速切换。</p>
<p>在AR1和AR2上还配置了负载分担。现在内网流量通过不同网关走不同路由器。</p>
<p>在AR2上配置的检测到4.4.4.4网段的NQA，ICMP直连检测，当传输质量低于百分之八十时，VRRP vrid 2 优先级自动降低，实现主备快速切换。</p>
<p><img src="/2017/12/18/虚拟路由冗余协议-VRRP/VRRP综合实验拓扑.png" alt="VRRP综合实验拓扑"></p>
<p><center>图：VRRP综合实验拓扑图<center></center></center></p>
<h3 id="配置文件："><a href="#配置文件：" class="headerlink" title="配置文件："></a>配置文件：</h3><p>AR1：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;AR1&gt;dis current-configuration </span><br><span class="line">#</span><br><span class="line"> sysname AR1</span><br><span class="line">#</span><br><span class="line">vrrp gratuitous-arp timeout <span class="number">100</span></span><br><span class="line"><span class="comment">//配置免费ARP发送时间间隔为100s</span></span><br><span class="line">vrrp version v3</span><br><span class="line"><span class="comment">//VRRP选择版本v3</span></span><br><span class="line">vrrp recover-delay <span class="number">3</span></span><br><span class="line"><span class="comment">//VRRP 恢复延迟3s</span></span><br><span class="line">#</span><br><span class="line">bfd</span><br><span class="line">#</span><br><span class="line">acl number <span class="number">2000</span>  </span><br><span class="line"> rule <span class="number">5</span> permit source <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.255</span> </span><br><span class="line"> rule <span class="number">10</span> permit source <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.255</span> </span><br><span class="line"> rule <span class="number">15</span> deny </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span></span><br><span class="line"> ip address <span class="number">13.1</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line"> nat outbound <span class="number">2000</span> </span><br><span class="line">  <span class="comment">//nat ，easy IP，实现内网到外网的地址转换</span></span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span></span><br><span class="line"> ip address <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line"> vrrp vrid <span class="number">1</span> <span class="keyword">virtual</span>-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> priority <span class="number">110</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> timer advertise <span class="number">2</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> track interface GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span> reduced <span class="number">30</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> version<span class="number">-3</span> send-packet-mode v2v3-both</span><br><span class="line"> vrrp vrid <span class="number">1</span> track ip route <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> reduced <span class="number">30</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> authentication-mode md5 %$%$[U*W7Y)upJ3N*<span class="number">0</span>#HA_x~~A=<span class="number">8</span>%$%$</span><br><span class="line"> <span class="comment">//VRRP vrid 1 认证密码 huawei</span></span><br><span class="line"> vrrp vrid <span class="number">2</span> <span class="keyword">virtual</span>-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.253</span></span><br><span class="line"> vrrp vrid <span class="number">2</span> version<span class="number">-3</span> send-packet-mode v2v3-both</span><br><span class="line">#</span><br><span class="line">bfd <span class="number">1</span> bind peer-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span> source-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span> <span class="keyword">auto</span></span><br><span class="line"> commit</span><br><span class="line">#</span><br><span class="line">rip <span class="number">1</span></span><br><span class="line"> version <span class="number">2</span></span><br><span class="line"> network <span class="number">13.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>AR2：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;AR2&gt;display current-configuration </span><br><span class="line">#</span><br><span class="line"> sysname AR2</span><br><span class="line">#</span><br><span class="line">bfd</span><br><span class="line">#</span><br><span class="line">acl number <span class="number">2000</span>  </span><br><span class="line"> rule <span class="number">5</span> permit source <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.255</span> </span><br><span class="line"> rule <span class="number">10</span> permit source <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.255</span> </span><br><span class="line"> rule <span class="number">15</span> deny </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span></span><br><span class="line"> ip address <span class="number">25.1</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line"> nat outbound <span class="number">2000</span></span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span></span><br><span class="line"> ip address <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line"> vrrp vrid <span class="number">1</span> <span class="keyword">virtual</span>-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> preempt-mode timer delay <span class="number">3</span></span><br><span class="line"> vrrp vrid <span class="number">1</span> authentication-mode md5 %$%$)vYYTI4Nv=@M5_0,Yx^/~BLU%$%$</span><br><span class="line"> vrrp vrid <span class="number">2</span> <span class="keyword">virtual</span>-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.253</span></span><br><span class="line"> vrrp vrid <span class="number">2</span> track nqa vrrp test reduced <span class="number">20</span></span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span></span><br><span class="line">#</span><br><span class="line">interface NULL0</span><br><span class="line">#</span><br><span class="line">bfd <span class="number">1</span> bind peer-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span> source-ip <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span> <span class="keyword">auto</span></span><br><span class="line"> commit</span><br><span class="line">#</span><br><span class="line">rip <span class="number">1</span></span><br><span class="line"> version <span class="number">2</span></span><br><span class="line"> network <span class="number">25.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">#</span><br><span class="line">nqa test-instance vrrp test </span><br><span class="line"> test-type icmp</span><br><span class="line"> destination-address ipv4 <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span></span><br><span class="line"> fail-percent <span class="number">80</span></span><br><span class="line"> frequency <span class="number">20</span></span><br><span class="line"> probe-count <span class="number">5</span></span><br><span class="line"> start now</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>AR3：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;AR3&gt;dis current-configuration </span><br><span class="line">#</span><br><span class="line"> sysname AR3</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span></span><br><span class="line"> ip address <span class="number">13.1</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span></span><br><span class="line"> ip address <span class="number">23.1</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span></span><br><span class="line"> ip address <span class="number">34.1</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line">#</span><br><span class="line">rip <span class="number">1</span></span><br><span class="line"> version <span class="number">2</span></span><br><span class="line"> network <span class="number">34.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> network <span class="number">13.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>AR4：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;AR4&gt;dis current-configuration </span><br><span class="line">#</span><br><span class="line"> sysname AR4</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span></span><br><span class="line"> ip address <span class="number">34.1</span><span class="number">.1</span><span class="number">.4</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span></span><br><span class="line"> ip address <span class="number">45.1</span><span class="number">.1</span><span class="number">.4</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> </span><br><span class="line">#</span><br><span class="line">rip <span class="number">1</span></span><br><span class="line"> version <span class="number">2</span></span><br><span class="line"> network <span class="number">34.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> network <span class="number">45.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"> network <span class="number">4.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>AR5：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[AR5]dis current-configuration </span><br><span class="line">#</span><br><span class="line"> sysname AR5</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/0</span><br><span class="line"> ip address 45.1.1.5 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/1</span><br><span class="line"> ip address 25.1.1.5 255.255.255.128 </span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 25.0.0.0</span><br><span class="line"> network 45.0.0.0</span><br></pre></td></tr></table></figure>
<h3 id="在AR1上VRRP的信息状态："><a href="#在AR1上VRRP的信息状态：" class="headerlink" title="在AR1上VRRP的信息状态："></a>在AR1上VRRP的信息状态：</h3><p><img src="/2017/12/18/虚拟路由冗余协议-VRRP/VRRP信息.png" alt="VRRP信息"></p>
<p><center>图：AR1上的VRRP的信息<center></center></center></p>
<hr>
<blockquote>
<p>参考资料：华为HedEx文档</p>
</blockquote>
<hr>

      
    </div>

    
      


    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/微信.png" alt="曹世宏 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/支付宝.jpg" alt="曹世宏 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>曹世宏</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/" title="虚拟路由冗余协议(VRRP)">https://cshihong.github.io/2017/12/18/虚拟路由冗余协议-VRRP/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
<br>
  <li class="post-copyright-link">
    <strong>字节跳动社招内推：<a href="https://job.toutiao.com/s/Jy89E4s">https://job.toutiao.com/s/Jy89E4s</a></strong><br>
    <strong>字节跳动校招内推码：<a href="https://job.toutiao.com/s/Jy8BSv6">YYG5KEY</a></strong><br>
    <strong>字节跳动校招投递链接:<a href="https://job.toutiao.com/s/Jy8BSv6">https://job.toutiao.com/s/Jy8BSv6</a></strong><br>
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/交换基础/" rel="tag"># 交换基础</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
               <div>
                 
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>

               </div>
            
            
               <div id="needsharebutton-postbottom">
                 <span class="btn">
                    <i class="fa fa-share-alt" aria-hidden="true"></i>
                 </span>
               </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/09/DHCP-Snooping/" rel="next" title="DHCP Snooping">
                <i class="fa fa-chevron-left"></i> DHCP Snooping
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/19/双向转发检测-BFD/" rel="prev" title="双向转发检测-BFD">
                双向转发检测-BFD <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDc1NS83MzA3"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/touxiang.jpg" alt="曹世宏">
            
              <p class="site-author-name" itemprop="name">曹世宏</p>
              <p class="site-description motion-element" itemprop="description">你的责任就是你的方向，你的经历就是你的资本，你的性格就是你的命运。</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">264</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">135</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/cshihong/cshihong.github.io" title="GitHub &rarr; https://github.com/cshihong/cshihong.github.io" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:cshihong96@gmail.com" title="E-Mail &rarr; mailto:cshihong96@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://user.qzone.qq.com/731507579?ptlang=2052&source=friendlist" title="qq &rarr; https://user.qzone.qq.com/731507579?ptlang=2052&source=friendlist" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>qq</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="http://blog.csdn.net/qq_38265137" title="CSDN &rarr; http://blog.csdn.net/qq_38265137" rel="noopener" target="_blank"><i class="fa fa-fw fa-meh-o"></i>CSDN</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/qq_38265137" title="http://blog.csdn.net/qq_38265137" rel="noopener" target="_blank">我的CSDN</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://support.huawei.com/learning/NavigationAction!createNavi?navId=MW000001_term1000025144&lang=zh" title="http://support.huawei.com/learning/NavigationAction!createNavi?navId=MW000001_term1000025144&lang=zh" rel="noopener" target="_blank">华为培训认证</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://bbs.hh010.com/" title="http://bbs.hh010.com/" rel="noopener" target="_blank">鸿鹄论坛</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://m.blog.csdn.net/home/index" title="http://m.blog.csdn.net/home/index" rel="noopener" target="_blank">CSDN博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/" title="https://www.cnblogs.com/" rel="noopener" target="_blank">博客园</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.w3school.com.cn/index.html" title="http://www.w3school.com.cn/index.html" rel="noopener" target="_blank">w3cshool</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.51cto.com" title="http://www.51cto.com" rel="noopener" target="_blank">51cto</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#VRRP简介："><span class="nav-number">1.</span> <span class="nav-text">VRRP简介：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义："><span class="nav-number">1.1.</span> <span class="nav-text">定义：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目的："><span class="nav-number">1.2.</span> <span class="nav-text">目的：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#收益："><span class="nav-number">1.3.</span> <span class="nav-text">收益：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VRRP原理描述"><span class="nav-number">2.</span> <span class="nav-text">VRRP原理描述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP概述："><span class="nav-number">2.1.</span> <span class="nav-text">VRRP概述：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP报文："><span class="nav-number">2.2.</span> <span class="nav-text">VRRP报文：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRP报文结构："><span class="nav-number">2.2.1.</span> <span class="nav-text">VRRP报文结构：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段解释："><span class="nav-number">2.2.2.</span> <span class="nav-text">字段解释：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRP报文主要区别："><span class="nav-number">2.2.3.</span> <span class="nav-text">VRRP报文主要区别：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRP认证："><span class="nav-number">2.2.4.</span> <span class="nav-text">VRRP认证：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRP报文抓包示例："><span class="nav-number">2.2.5.</span> <span class="nav-text">VRRP报文抓包示例：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP工作原理："><span class="nav-number">2.3.</span> <span class="nav-text">VRRP工作原理：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRP状态机："><span class="nav-number">2.3.1.</span> <span class="nav-text">VRRP状态机：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Initialize："><span class="nav-number">2.3.1.1.</span> <span class="nav-text">Initialize：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Masster："><span class="nav-number">2.3.1.2.</span> <span class="nav-text">Masster：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Backup："><span class="nav-number">2.3.1.3.</span> <span class="nav-text">Backup：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRP的工作过程："><span class="nav-number">2.3.2.</span> <span class="nav-text">VRRP的工作过程：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP负载分担："><span class="nav-number">2.4.</span> <span class="nav-text">VRRP负载分担：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多网关负载分担："><span class="nav-number">2.4.1.</span> <span class="nav-text">多网关负载分担：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP笔记："><span class="nav-number">2.5.</span> <span class="nav-text">VRRP笔记：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#如何选举Master和Backup？"><span class="nav-number">2.5.1.</span> <span class="nav-text">如何选举Master和Backup？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#影响VRRP协商的条件："><span class="nav-number">2.5.2.</span> <span class="nav-text">影响VRRP协商的条件：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VRRP应用"><span class="nav-number">3.</span> <span class="nav-text">VRRP应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP与接口状态联动监视上行接口："><span class="nav-number">3.1.</span> <span class="nav-text">VRRP与接口状态联动监视上行接口：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP与BFD-NQA-路由联动监视上行链路："><span class="nav-number">3.2.</span> <span class="nav-text">VRRP与BFD/NQA/路由联动监视上行链路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP与BFD联动实现快速切换："><span class="nav-number">3.3.</span> <span class="nav-text">VRRP与BFD联动实现快速切换：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VRRP配置"><span class="nav-number">4.</span> <span class="nav-text">VRRP配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置注意事项："><span class="nav-number">4.1.</span> <span class="nav-text">配置注意事项：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置基于IPv4的VRRP基本功能："><span class="nav-number">4.2.</span> <span class="nav-text">配置基于IPv4的VRRP基本功能：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建VRRP备份组："><span class="nav-number">4.2.1.</span> <span class="nav-text">创建VRRP备份组：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置设备在备份组中的优先级："><span class="nav-number">4.2.2.</span> <span class="nav-text">配置设备在备份组中的优先级：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置VRRP协议的版本："><span class="nav-number">4.2.3.</span> <span class="nav-text">配置VRRP协议的版本：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置VRRP的时间参数"><span class="nav-number">4.2.4.</span> <span class="nav-text">配置VRRP的时间参数:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置VRRP报文在Sub-VLAN中的发送方式："><span class="nav-number">4.2.5.</span> <span class="nav-text">配置VRRP报文在Sub-VLAN中的发送方式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置禁止检测VRRP报文跳数："><span class="nav-number">4.2.6.</span> <span class="nav-text">配置禁止检测VRRP报文跳数：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置VRRP报文的认证方式："><span class="nav-number">4.2.7.</span> <span class="nav-text">配置VRRP报文的认证方式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使能虚拟IP地址Ping功能："><span class="nav-number">4.2.8.</span> <span class="nav-text">使能虚拟IP地址Ping功能：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP配置综合实验示例："><span class="nav-number">4.3.</span> <span class="nav-text">VRRP配置综合实验示例：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件："><span class="nav-number">4.3.1.</span> <span class="nav-text">配置文件：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在AR1上VRRP的信息状态："><span class="nav-number">4.3.2.</span> <span class="nav-text">在AR1上VRRP的信息状态：</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">曹世宏</span>

  

  
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">全站共 1.1m 字</span>
</div>











        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>






  <script>
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=66140664";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script src="//cdn.jsdelivr.net/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script src="//cdn.jsdelivr.net/velocity/1.2.1/velocity.ui.min.js"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.6.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.6.0"></script>
<script src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  
    <script>
      window.livereOptions = {
        refer: '2017/12/18/虚拟路由冗余协议-VRRP/'
      };
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  
  
    
  
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1.0.0/needsharebutton.min.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook,Mailto";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook,";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  
  <script src="/js/src/js.cookie.js?v=6.6.0"></script>
  <script src="/js/src/scroll-cookie.js?v=6.6.0"></script>


  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  
  

  
  

  


</body>
</html>
