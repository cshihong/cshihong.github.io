<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">



  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1.0.0/needsharebutton.min.css">



























  
  
  
  

  

  

  

  

  

  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.6.0">


  <link rel="mask-icon" href="/favicon.ico?v=6.6.0" color="#222">


  <link rel="manifest" href="/images/favicon.ico">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="备注：以下资料整理自以下三个网站，有华为，华三，思科三个厂商官网的BGP相关资料。放这里是为了自己查看方便。同时，有需要的可以参考参考。   官方文档BGP相关资料： 华为：https://support.huawei.com/hedex/hdx.do?docid=EDOC1100101225&amp;amp;lang=zh&amp;amp;idPath=24030814%7C21782165%7C217822">
<meta name="keywords" content="BGP">
<meta property="og:type" content="article">
<meta property="og:title" content="BGP知识手册(华为,华三,思科)">
<meta property="og:url" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/index.html">
<meta property="og:site_name" content="曹世宏的博客">
<meta property="og:description" content="备注：以下资料整理自以下三个网站，有华为，华三，思科三个厂商官网的BGP相关资料。放这里是为了自己查看方便。同时，有需要的可以参考参考。   官方文档BGP相关资料： 华为：https://support.huawei.com/hedex/hdx.do?docid=EDOC1100101225&amp;amp;lang=zh&amp;amp;idPath=24030814%7C21782165%7C217822">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/BGP状态机.png">
<meta property="og:image" content="file:///C:/Users/cao/AppData/Local/Temp/msohtmlclip1/01/clip_image002.gif">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/反射器.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/备份.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/分级.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/同级.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/联盟.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/惩罚值.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/bmp.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/bfd.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/ying.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/ying2.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/ying3.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/c1.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/c2.png">
<meta property="og:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/c3.png">
<meta property="og:image" content="file:///C:/Users/cao/AppData/Local/Temp/msohtmlclip1/01/clip_image002.gif">
<meta property="og:updated_time" content="2020-11-25T09:19:07.391Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BGP知识手册(华为,华三,思科)">
<meta name="twitter:description" content="备注：以下资料整理自以下三个网站，有华为，华三，思科三个厂商官网的BGP相关资料。放这里是为了自己查看方便。同时，有需要的可以参考参考。   官方文档BGP相关资料： 华为：https://support.huawei.com/hedex/hdx.do?docid=EDOC1100101225&amp;amp;lang=zh&amp;amp;idPath=24030814%7C21782165%7C217822">
<meta name="twitter:image" content="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/BGP状态机.png">



  <link rel="alternate" href="/atom.xml" title="曹世宏的博客" type="application/atom+xml">




  <link rel="canonical" href="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>BGP知识手册(华为,华三,思科) | 曹世宏的博客</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3d1d06c1df5d2fe94237f55bad4858bc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">曹世宏的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">记录一些学习资料</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曹世宏">
      <meta itemprop="description" content="你的责任就是你的方向，你的经历就是你的资本，你的性格就是你的命运。">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曹世宏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">BGP知识手册(华为,华三,思科)

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-04-18 12:20:38" itemprop="dateCreated datePublished" datetime="2020-04-18T12:20:38+08:00">2020-04-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-11-25 17:19:07" itemprop="dateModified" datetime="2020-11-25T17:19:07+08:00">2020-11-25</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/数据中心/" itemprop="url" rel="index"><span itemprop="name">数据中心</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
			<span class="post-meta-divider">|</span>
			<span title="post.wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span>字数： 36,457</span>
			<span class="post-meta-item-text">|</span>
			<span title="post.min2read"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span>阅读时长： 137</span>

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>备注：以下资料整理自以下三个网站，有华为，华三，思科三个厂商官网的BGP相关资料。放这里是为了自己查看方便。同时，有需要的可以参考参考。</p>
</blockquote>
<blockquote>
<p>官方文档BGP相关资料：</p>
<p>华为：<a href="https://support.huawei.com/hedex/hdx.do?docid=EDOC1100101225&amp;lang=zh&amp;idPath=24030814%7C21782165%7C21782236%7C22318638%7C7542409" target="_blank" rel="noopener">https://support.huawei.com/hedex/hdx.do?docid=EDOC1100101225&amp;lang=zh&amp;idPath=24030814%7C21782165%7C21782236%7C22318638%7C7542409</a></p>
<p>华三：<a href="http://www.h3c.com/cn/d_201601/909969_30005_0.htm" target="_blank" rel="noopener">http://www.h3c.com/cn/d_201601/909969_30005_0.htm</a></p>
<p>思科：<a href="https://www.cisco.com/c/en/us/tech/ip/ip-routing/index.html" target="_blank" rel="noopener">https://www.cisco.com/c/en/us/tech/ip/ip-routing/index.html</a></p>
</blockquote>
<h1 id="BGP介绍"><a href="#BGP介绍" class="headerlink" title="BGP介绍"></a>BGP介绍</h1><h2 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h2><p>边界网关协议BGP（Border Gateway Protocol）是一种实现自治系统AS（Autonomous System）之间的路由可达，并选择最佳路由的距离矢量路由协议。早期发布的三个版本分别是BGP-1（RFC1105）、BGP-2（RFC1163）和BGP-3（RFC1267），1994年开始使用BGP-4（RFC1771），2006年之后单播IPv4网络使用的版本是BGP-4（RFC4271），其他网络（如IPv6等）使用的版本是<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0018.html" target="_blank" rel="noopener">MP-BGP</a>（RFC4760）。</p>
<p>MP-BGP是对BGP-4进行了扩展，来达到在不同网络中应用的目的，BGP-4原有的消息机制和路由机制并没有改变。MP-BGP在IPv6单播网络上的应用称为BGP4+，在IPv4组播网络上的应用称为MBGP（Multicast BGP）。</p>
<h2 id="目的："><a href="#目的：" class="headerlink" title="目的："></a>目的：</h2><p>为方便管理规模不断扩大的网络，网络被分成了不同的自治系统。1982年，外部网关协议EGP（Exterior Gateway Protocol）被用于实现在AS之间动态交换路由信息。但是EGP设计得比较简单，只发布网络可达的路由信息，而不对路由信息进行优选，同时也没有考虑环路避免等问题，很快就无法满足网络管理的要求。</p>
<p>BGP是为取代最初的EGP而设计的另一种外部网关协议。不同于最初的EGP，BGP能够进行路由优选、避免路由环路、更高效率的传递路由和维护大量的路由信息。</p>
<p>虽然BGP用于在AS之间传递路由信息，但并不是所有AS之间传递路由信息都需要运行BGP。比如在数据中心上行的连入Internet的出口上，为了避免Internet海量路由对数据中心内部网络的影响，设备采用静态路由代替BGP与外部网络通信。</p>
<h2 id="受益："><a href="#受益：" class="headerlink" title="受益："></a>受益：</h2><p>BGP从多方面保证了网络的安全性、灵活性、稳定性、可靠性和高效性：</p>
<ul>
<li>BGP采用认证和GTSM的方式，保证了<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0006.html" target="_blank" rel="noopener">网络的安全性</a>。</li>
<li>BGP提供了丰富的路由策略，能够灵活的进行<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0007.html" target="_blank" rel="noopener">路由选路</a>。</li>
<li>BGP提供了<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0010.html" target="_blank" rel="noopener">路由聚合</a>和<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0011.html" target="_blank" rel="noopener">路由衰减</a>功能用于防止路由振荡，有效提高了网络的稳定性。</li>
<li>BGP使用TCP作为其传输层协议（端口号为179），并支持<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0012.html" target="_blank" rel="noopener">BGP与BFD联动</a>、<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0014.html" target="_blank" rel="noopener">BGP Auto FRR</a>和<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0015.html" target="_blank" rel="noopener">BGP GR和NSR</a>，提高了网络的可靠性。</li>
</ul>
<h2 id="BGP特点"><a href="#BGP特点" class="headerlink" title="BGP特点"></a>BGP特点</h2><p>BGP具有如下特点：</p>
<ul>
<li>BGP是一种EGP（Exterior Gateway Protocol，外部网关协议），与OSPF、RIP等IGP（Interior Gateway Protocol，内部网关协议）不同，其着眼点不在于发现和计算路由，而在于控制路由的传播和选择最佳路由。</li>
<li>BGP使用TCP作为其传输层协议（端口号179），提高了协议的可靠性。</li>
<li>BGP是一种路径矢量（Path-Vector）路由协议，它采用到达目的地址所经过的AS列表来衡量到达目的地址的距离。</li>
<li>BGP支持CIDR（Classless Inter-Domain Routing，无类域间路由）。</li>
<li>路由更新时，BGP只发送更新的路由，大大减少了BGP传播路由所占用的带宽，适用于在Internet上传播大量的路由信息。</li>
<li>BGP路由通过携带AS路径信息彻底解决路由环路问题。</li>
<li>BGP提供了丰富的路由策略，能够对路由实现灵活的过滤和选择。</li>
<li>BGP易于扩展，能够适应网络新的发展。</li>
</ul>
<h1 id="BGP原理描述"><a href="#BGP原理描述" class="headerlink" title="BGP原理描述"></a>BGP原理描述</h1><h2 id="BGP基本概念"><a href="#BGP基本概念" class="headerlink" title="BGP基本概念"></a>BGP基本概念</h2><h3 id="自治系统AS（Autonomous-System）"><a href="#自治系统AS（Autonomous-System）" class="headerlink" title="自治系统AS（Autonomous System）"></a>自治系统AS（Autonomous System）</h3><p>AS是指在一个实体管辖下的拥有相同选路策略的IP网络。BGP网络中的每个AS都被分配一个唯一的AS号，用于区分不同的AS。AS号分为2字节AS号和4字节AS号，其中2字节AS号的范围为1至65535，4字节AS号的范围为1至4294967295。支持4字节AS号的设备能够与支持2字节AS号的设备兼容。</p>
<h2 id="AS号规划："><a href="#AS号规划：" class="headerlink" title="AS号规划："></a>AS号规划：</h2><p>As号分配情况：<a href="https://www.iana.org/assignments/as-numbers/as-numbers.xhtml" target="_blank" rel="noopener">https://www.iana.org/assignments/as-numbers/as-numbers.xhtml</a></p>
<p>BGP的RFC1771里留给AS的范围是2个字节，所以AS的取值范围为1-65535，其中64512-65534为私有AS。在RFC4893里定义了一个BGP的新功能——4字节AS（BGP Support for Four-octet AS Number，一般用M.N来描述）。但是鉴于IPv4地址空间不够这个前车之鉴，</p>
<p>4字节AS号有两种表达方式,点分形式和整数形式,转换关系为:X<em>65536+Y=X.Y, 其中(X</em>65536+Y)为整数形式四字节AS号;X.Y即为点分形式的四字节AS号;</p>
<p>设备支持4字节的AS号，即AS号取值占用4字节，取值范围为1～4294967295。</p>
<p><strong>四字节的私有AS号为：4200000000-4294967294。</strong></p>
<h3 id="BGP分类"><a href="#BGP分类" class="headerlink" title="BGP分类"></a>BGP分类</h3><p>BGP按照运行方式分为EBGP（External/Exterior BGP）和IBGP（Internal/Interior BGP）。</p>
<ul>
<li>EBGP：运行于不同AS之间的BGP称为EBGP。为了防止AS间产生环路，当BGP设备接收EBGP对等体发送的路由时，会将带有本地AS号的路由丢弃。</li>
<li>IBGP：运行于同一AS内部的BGP称为IBGP。为了防止AS内产生环路，BGP设备不将从IBGP对等体学到的路由通告给其他IBGP对等体，并与所有IBGP对等体建立全连接。为了解决IBGP对等体的连接数量太多的问题，BGP设计了<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0008.html" target="_blank" rel="noopener">路由反射器</a>和<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0009.html" target="_blank" rel="noopener">BGP联盟</a>。</li>
</ul>
<h3 id="BGP报文交互中的角色"><a href="#BGP报文交互中的角色" class="headerlink" title="BGP报文交互中的角色"></a>BGP报文交互中的角色</h3><p>BGP报文交互中分为Speaker和Peer两种角色。</p>
<ul>
<li>Speaker：发送BGP报文的设备称为BGP发言者（Speaker），它接收或产生新的报文信息，并发布（Advertise）给其它BGP Speaker。</li>
<li>Peer：相互交换报文的Speaker之间互称对等体（Peer）。若干相关的对等体可以构成对等体组（Peer Group）。</li>
</ul>
<h3 id="BGP的路由器号（Router-ID）"><a href="#BGP的路由器号（Router-ID）" class="headerlink" title="BGP的路由器号（Router ID）"></a>BGP的路由器号（Router ID）</h3><p>BGP的Router ID是一个用于标识BGP设备的32位值，通常是IPv4地址的形式，在BGP会话建立时发送的Open报文中携带。对等体之间建立BGP会话时，<strong>每个BGP设备都必须有唯一的Router ID</strong>，否则对等体之间不能建立BGP连接。</p>
<p>BGP的Router ID在BGP网络中必须是唯一的，可以采用手工配置，也可以让设备自动选取。缺省情况下，BGP选择设备上的Loopback接口的IPv4地址作为BGP的Router ID。如果设备上没有配置Loopback接口，系统会选择接口中最大的IPv4地址作为BGP的Router ID。一旦选出Router ID，除非发生接口地址删除等事件，否则即使配置了更大的地址，也保持原来的Router ID。</p>
<h2 id="BGP工作原理"><a href="#BGP工作原理" class="headerlink" title="BGP工作原理"></a>BGP工作原理</h2><p>BGP对等体的建立、更新和删除等交互过程主要有5种报文、6种状态机和5个原则。</p>
<h3 id="BGP的报文"><a href="#BGP的报文" class="headerlink" title="BGP的报文"></a>BGP的报文</h3><p>BGP对等体间通过以下5种报文进行交互，其中Keepalive报文为周期性发送，其余报文为触发式发送：</p>
<ul>
<li>Open报文：用于建立BGP对等体连接。</li>
<li>Update报文：用于在对等体之间交换路由信息。</li>
<li>Notification报文：用于中断BGP连接。</li>
<li>Keepalive报文：用于保持BGP连接。</li>
<li>Route-refresh报文：用于在改变路由策略后请求对等体重新发送路由信息。只有支持路由刷新（Route-refresh）能力的BGP设备会发送和响应此报文。</li>
</ul>
<h3 id="BGP状态机"><a href="#BGP状态机" class="headerlink" title="BGP状态机"></a>BGP状态机</h3><p>BGP对等体的交互过程中存在6种状态机：空闲（Idle）、连接（Connect）、活跃（Active）、Open报文已发送（OpenSent）、Open报文已确认（OpenConfirm）和连接已建立（Established）。在BGP对等体建立的过程中，通常可见的3个状态是：Idle、Active和Established。</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/BGP状态机.png" alt="BGP状态机"></p>
<ol>
<li>Idle状态是BGP初始状态。在Idle状态下，BGP拒绝邻居发送的连接请求。只有在收到本设备的Start事件后，BGP才开始尝试和其它BGP对等体进行TCP连接，并转至Connect状态。</li>
</ol>
<blockquote>
<p> <strong>说明：</strong><img src="file:///C:/Users/cao/AppData/Local/Temp/msohtmlclip1/01/clip_image002.gif" alt="http://localhost:7890/pages/31189183/08/31189183/08/resources/public_sys-resources/icon-note.gif"></p>
<ul>
<li><p>Start事件是由一个操作者配置一个BGP过程，或者重置一个已经存在的过程或者路由器软件重置BGP过程引起的。</p>
</li>
<li><p>任何状态中收到Notification报文或TCP拆链通知等Error事件后，BGP都会转至Idle状态。</p>
</li>
</ul>
</blockquote>
<ol start="2">
<li>在Connect状态下，BGP启动连接重传定时器（Connect Retry），等待TCP完成连接。</li>
</ol>
<ul>
<li>如果TCP连接成功，那么BGP向对等体发送Open报文，并转至OpenSent状态。</li>
<li>如果TCP连接失败，那么BGP转至Active状态。</li>
<li>如果连接重传定时器超时，BGP仍没有收到BGP对等体的响应，那么BGP继续尝试和其它BGP对等体进行TCP连接，停留在Connect状态。</li>
</ul>
<ol start="3">
<li>在Active状态下，BGP总是在试图建立TCP连接。</li>
</ol>
<ul>
<li>如果TCP连接成功，那么BGP向对等体发送Open报文，关闭连接重传定时器，并转至OpenSent状态。</li>
<li>如果TCP连接失败，那么BGP停留在Active状态。</li>
<li>如果连接重传定时器超时，BGP仍没有收到BGP对等体的响应，那么BGP转至Connect状态。</li>
</ul>
<ol start="4">
<li>在OpenSent状态下，BGP等待对等体的Open报文，并对收到的Open报文中的AS号、版本号、认证码等进行检查。</li>
</ol>
<ul>
<li>如果收到的Open报文正确，那么BGP发送Keepalive报文，并转至OpenConfirm状态。</li>
<li>如果发现收到的Open报文有错误，那么BGP发送Notification报文给对等体，并转至Idle状态。</li>
</ul>
<ol start="5">
<li><p>在OpenConfirm状态下，BGP等待Keepalive或Notification报文。如果收到Keepalive报文，则转至Established状态，如果收到Notification报文，则转至Idle状态。</p>
</li>
<li><p>在Established状态下，BGP可以和对等体交换Update、Keepalive、Route-refresh报文和Notification报文。</p>
</li>
</ol>
<ul>
<li>如果收到正确的Update或Keepalive报文，那么BGP就认为对端处于正常运行状态，将保持BGP连接。</li>
<li>如果收到错误的Update或Keepalive报文，那么BGP发送Notification报文通知对端，并转至Idle状态。</li>
<li>Route-refresh报文不会改变BGP状态。</li>
<li>如果收到Notification报文，那么BGP转至Idle状态。</li>
<li>如果收到TCP拆链通知，那么BGP断开连接，转至Idle状态。</li>
</ul>
<h3 id="BGP对等体之间的交互原则"><a href="#BGP对等体之间的交互原则" class="headerlink" title="BGP对等体之间的交互原则"></a>BGP对等体之间的交互原则</h3><h4 id="华为设备："><a href="#华为设备：" class="headerlink" title="华为设备："></a>华为设备：</h4><p>BGP设备将最优路由加入BGP路由表，形成BGP路由。BGP设备与对等体建立邻居关系后，采取以下交互原则：</p>
<p>从IBGP对等体获得的BGP路由，BGP设备只发布给它的EBGP对等体。</p>
<p>从EBGP对等体获得的BGP路由，BGP设备发布给它所有EBGP和IBGP对等体。</p>
<p>当存在多条到达同一目的地址的有效路由时，BGP设备只将最优路由发布给对等体。</p>
<p>路由更新时，BGP设备只发送更新的BGP路由。</p>
<p>所有对等体发送的路由，BGP设备都会接收。</p>
<h4 id="华三设备发布路由的策略"><a href="#华三设备发布路由的策略" class="headerlink" title="华三设备发布路由的策略"></a>华三设备发布路由的策略</h4><p>BGP发布路由时采用如下策略：</p>
<ul>
<li>存在多条有效路由时，BGP发言者只将最优路由发布给对等体。如果配置了<strong>advertise-rib-active</strong>命令，则BGP发布IP路由表中的最优路由；否则，发布BGP路由表中的最优路由。</li>
<li>BGP发言者只把自己使用的路由发布给对等体。</li>
<li>BGP发言者会将从EBGP获得的路由发布给它的所有BGP对等体（包括EBGP对等体和IBGP对等体）。</li>
<li>BGP发言者会将从IBGP获得的路由发布给它的EBGP对等体，但不会发布给它的IBGP对等体。</li>
<li>会话一旦建立，BGP发言者将把满足上述条件的所有BGP路由发布给新对等体。之后，BGP发言者只在路由变化时，向对等体发布更新的路由。</li>
</ul>
<h2 id="BGP与IGP进行交互"><a href="#BGP与IGP进行交互" class="headerlink" title="BGP与IGP进行交互"></a>BGP与IGP进行交互</h2><p>BGP与IGP在设备中使用不同的路由表，为了实现不同AS间相互通讯，BGP需要与IGP进行交互，即BGP路由表和IGP路由表相互引入。</p>
<h3 id="BGP引入IGP路由"><a href="#BGP引入IGP路由" class="headerlink" title="BGP引入IGP路由"></a>BGP引入IGP路由</h3><p>BGP协议本身不发现路由，因此需要将其他路由引入到BGP路由表，实现AS间的路由互通。当一个AS需要将路由发布给其他AS时，AS边缘路由器会在BGP路由表中引入IGP的路由。为了更好的规划网络，BGP在引入IGP的路由时，可以使用路由策略进行路由过滤和路由属性设置，也可以设置MED值指导EBGP对等体判断流量进入AS时选路。</p>
<p>BGP引入路由时支持Import和Network两种方式：</p>
<ul>
<li>Import方式是按协议类型，将RIP、OSPF、ISIS等协议的路由引入到BGP路由表中。为了保证引入的IGP路由的有效性，Import方式还可以引入静态路由和直连路由。</li>
<li>Network方式是逐条将IP路由表中已经存在的路由引入到BGP路由表中，比Import方式更精确。</li>
</ul>
<h3 id="IGP引入BGP路由"><a href="#IGP引入BGP路由" class="headerlink" title="IGP引入BGP路由"></a>IGP引入BGP路由</h3><p>当一个AS需要引入其他AS的路由时，AS边缘路由器会在IGP路由表中引入BGP的路由。为了避免大量BGP路由对AS内设备造成影响，当IGP引入BGP路由时，可以使用路由策略，进行路由过滤和路由属性设置。</p>
<h2 id="BGP安全性"><a href="#BGP安全性" class="headerlink" title="BGP安全性"></a>BGP安全性</h2><p>BGP使用认证、通用TTL安全保护机制GTSM（Generalized TTL Security Mechanism）和RPKI（Resource Public Key Infrastructure）三个方法保证BGP对等体间的交互安全。</p>
<h3 id="BGP认证"><a href="#BGP认证" class="headerlink" title="BGP认证"></a>BGP认证</h3><p>BGP认证分为MD5认证和Keychain认证，对BGP对等体关系进行认证是提高安全性的有效手段。MD5认证只能为TCP连接设置认证密码，而Keychain认证除了可以为TCP连接设置认证密码外，还可以对BGP协议报文进行认证。</p>
<h3 id="BGP-GTSM"><a href="#BGP-GTSM" class="headerlink" title="BGP GTSM"></a>BGP GTSM</h3><p>BGP GTSM检测IP报文头中的TTL（time-to-live）值是否在一个预先设置好的特定范围内，并对不符合TTL值范围的报文进行允许通过或丢弃的操作，从而实现了保护IP层以上业务，增强系统安全性的目的。</p>
<p>例如将IBGP对等体的报文的TTL的范围设为254至255。当攻击者模拟合法的BGP协议报文，对设备不断的发送报文进行攻击时，TTL值必然小于254。如果没有使能BGP GTSM功能，设备收到这些报文后，发现是发送给本机的报文，会直接上送控制层面处理。这时将会因为控制层面处理大量攻击报文，导致设备CPU占用率高，系统异常繁忙。如果使能BGP GTSM功能，系统会对所有BGP报文的TTL值进行检查，丢弃TTL值小于254的攻击报文，从而避免了因网络攻击报文导致CPU占用率高的问题。</p>
<h2 id="BGP的路由优选规则和负载分担"><a href="#BGP的路由优选规则和负载分担" class="headerlink" title="BGP的路由优选规则和负载分担"></a>BGP的路由优选规则和负载分担</h2><p>在BGP路由表中，到达同一目的地可能存在多条路由。此时BGP会选择其中一条路由作为最佳路由，并只把此路由发送给其对等体。BGP为了选出最佳路由，会根据BGP的路由优选规则依次比较这些路由的BGP属性。</p>
<h3 id="BGP属性"><a href="#BGP属性" class="headerlink" title="BGP属性"></a>BGP属性</h3><p>路由属性是对路由的特定描述，所有的BGP路由属性都可以分为以下4类，常见BGP属性类型如<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0007.html?ft=0&amp;fe=10&amp;hib=6.8.10.2.5&amp;id=dc_feature_bgp_0007#dc_feature_bgp_0007__tab_dc_feature_bgp_000701" target="_blank" rel="noopener">表1</a>所示：</p>
<ul>
<li>公认必须遵循（Well-known mandatory）：所有BGP设备都可以识别此类属性，且必须存在于Update报文中。如果缺少这类属性，路由信息就会出错。</li>
<li>公认任意（Well-known discretionary）：所有BGP设备都可以识别此类属性，但不要求必须存在于Update报文中，即就算缺少这类属性，路由信息也不会出错。</li>
<li>可选过渡（Optional transitive）：BGP设备可以不识别此类属性，如果BGP设备不识别此类属性，但它仍然会接收这类属性，并通告给其他对等体。</li>
<li>可选非过渡（Optional non-transitive）：BGP设备可以不识别此类属性，如果BGP设备不识别此类属性，则会被忽略该属性，且不会通告给其他对等体。</li>
</ul>
<table>
<thead>
<tr>
<th>1BGP常见属性类型</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>属性名</strong></td>
<td><strong>类型</strong></td>
</tr>
<tr>
<td>Origin属性</td>
<td>公认必须遵循</td>
</tr>
<tr>
<td>AS_Path属性</td>
<td>公认必须遵循</td>
</tr>
<tr>
<td>Next_Hop属性</td>
<td>公认必须遵循</td>
</tr>
<tr>
<td>Local_Pref属性</td>
<td>公认任意</td>
</tr>
<tr>
<td>MED属性</td>
<td>可选非过渡</td>
</tr>
<tr>
<td>团体属性</td>
<td>可选过渡</td>
</tr>
<tr>
<td>Originator_ID属性</td>
<td>可选非过渡</td>
</tr>
<tr>
<td>Cluster_List属性</td>
<td>可选非过渡</td>
</tr>
</tbody>
</table>
<h4 id="Origin属性"><a href="#Origin属性" class="headerlink" title="Origin属性"></a>Origin属性</h4><p>Origin属性用来定义路径信息的来源，标记一条路由是怎么成为BGP路由的。它有以下3种类型：</p>
<ul>
<li>IGP：具有最高的优先级。通过<strong>network</strong>命令注入到BGP路由表的路由，其Origin属性为IGP。</li>
<li>EGP：优先级次之。通过EGP得到的路由信息，其Origin属性为EGP。</li>
<li>Incomplete：优先级最低。通过其他方式学习到的路由信息。比如BGP通过<strong>import-route</strong>命令引入的路由，其Origin属性为Incomplete。</li>
</ul>
<h4 id="AS-Path属性"><a href="#AS-Path属性" class="headerlink" title="AS_Path属性"></a>AS_Path属性</h4><p>AS_Path属性按矢量顺序记录了某条路由从本地到目的地址所要经过的所有AS编号。在接收路由时，设备如果发现AS_Path列表中有本AS号，则不接收该路由，从而避免了AS间的路由环路。</p>
<p>当BGP Speaker传播自身引入的路由时：</p>
<ul>
<li>当BGP Speaker将这条路由通告到EBGP对等体时，便会在Update报文中创建一个携带本地AS号的AS_Path列表。</li>
<li>当BGP Speaker将这条路由通告给IBGP对等体时，便会在Update报文中创建一个空的AS_Path列表。</li>
<li>当BGP Speaker传播从其他BGP Speaker的Update报文中学习到的路由时：</li>
<li>当BGP Speaker将这条路由通告给EBGP对等体时，便会把本地AS编号添加在AS_Path列表的最前面（最左面）。收到此路由的BGP设备根据AS_Path属性就可以知道去目的地址所要经过的AS。离本地AS最近的相邻AS号排在前面，其他AS号按顺序依次排列。</li>
<li>当BGP Speaker将这条路由通告给IBGP对等体时，不会改变这条路由相关的AS_Path属性。</li>
</ul>
<p>AS_PATH属性有以下两种类型：</p>
<ul>
<li>AS_SEQUENCE：AS号按照一定的顺序排列。离本地AS最近的相邻AS号排在前面，其他AS号按顺序依次排列。</li>
<li>AS_SET：AS号只是经过的AS的简单罗列，没有顺序要求。</li>
</ul>
<p>AS_PATH属性具有如下用途：</p>
<ul>
<li>避免路由环路的形成：缺省情况下，如果BGP路由器接收到的路由的AS_PATH属性中已经包含了本地的AS号，则BGP路由器认为出现路由环路，不会接受该路由。</li>
<li>影响路由的选择：在其他因素相同的情况下，BGP会优先选择路径较短的路由。</li>
<li>对路由进行过滤：通过配置AS路径过滤列表，可以针对AS_PATH属性中所包含的AS号来对路由进行过滤</li>
</ul>
<h4 id="Next-Hop属性"><a href="#Next-Hop属性" class="headerlink" title="Next_Hop属性"></a>Next_Hop属性</h4><p>Next_Hop属性记录了路由的下一跳信息。BGP的下一跳属性和IGP的有所不同，不一定就是邻居设备的IP地址。通常情况下，Next_Hop属性遵循下面的规则：</p>
<ul>
<li>BGP Speaker在向EBGP对等体发布某条路由时，会把该路由信息的下一跳属性设置为本地与对端建立BGP邻居关系的接口地址。</li>
<li>BGP Speaker将本地始发路由发布给IBGP对等体时，会把该路由信息的下一跳属性设置为本地与对端建立BGP邻居关系的接口地址。</li>
<li>BGP Speaker在向IBGP对等体发布从EBGP对等体学来的路由时，并不改变该路由信息的下一跳属性。</li>
</ul>
<h4 id="Local-Pref属性"><a href="#Local-Pref属性" class="headerlink" title="Local_Pref属性"></a>Local_Pref属性</h4><p>Local_Pref属性表明路由器的BGP优先级，用于判断流量离开AS时的最佳路由。当BGP的设备通过不同的IBGP对等体得到目的地址相同但下一跳不同的多条路由时，将优先选择Local_Pref属性值较高的路由。<strong>Local_Pref**</strong>属性仅在<strong>IBGP对等体之间有效</strong>，不通告给其他AS。Local_Pref属性可以手动配置，如果路由没有配置Local_Pref属性，BGP选路时将该路由的Local_Pref值按缺省值100来处理。</p>
<h4 id="MED属性"><a href="#MED属性" class="headerlink" title="MED属性"></a>MED属性</h4><p>MED（Multi-Exit Discriminator）属性用于判断流量进入AS时的最佳路由，当一个运行BGP的设备通过不同的EBGP对等体得到目的地址相同但下一跳不同的多条路由时，在其它条件相同的情况下，将优先选择MED值较小者作为最佳路由。</p>
<p>MED属性仅在相邻两个AS之间传递，收到此属性的AS一方不会再将其通告给任何其他第三方AS。MED属性可以手动配置，如果路由没有配置MED属性，BGP选路时将该路由的MED值按缺省值0来处理。</p>
<h4 id="团体属性"><a href="#团体属性" class="headerlink" title="团体属性"></a>团体属性</h4><p>团体属性（Community）用于标识具有相同特征的BGP路由，使路由策略的应用更加灵活，同时降低了维护管理的难度。</p>
<p>团体属性分为自定义团体属性和公认团体属性。公认团体属性如<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0007.html?ft=0&amp;fe=10&amp;hib=6.8.10.2.5&amp;id=dc_feature_bgp_0007#dc_feature_bgp_0007__tab_dc_feature_bgp_000702" target="_blank" rel="noopener">表2</a>所示。</p>
<table>
<thead>
<tr>
<th><strong>表**</strong>2** 公认团体属性</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>团体属性名称</strong></td>
<td><strong>团体属性号</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td>Internet</td>
<td>0（0x00000000）</td>
<td>设备在收到具有此属性的路由后，可以向任何BGP对等体发送该路由。</td>
</tr>
<tr>
<td>No_Advertise</td>
<td>4294967042（0xFFFFFF02）</td>
<td>设备收到具有此属性的路由后，将不向任何BGP对等体发送该路由。</td>
</tr>
<tr>
<td>No_Export</td>
<td>4294967041（0xFFFFFF01）</td>
<td>设备收到具有此属性的路由后，将不向AS外发送该路由。</td>
</tr>
<tr>
<td>No_Export_Subconfed</td>
<td>4294967043（0xFFFFFF03）</td>
<td>设备收到具有此属性的路由后，将不向AS外发送该路由，也不向AS内其他子AS发布此路由。</td>
</tr>
</tbody>
</table>
<h4 id="扩展团体属性"><a href="#扩展团体属性" class="headerlink" title="扩展团体属性"></a>扩展团体属性</h4><p><strong>华三文档：</strong></p>
<p>随着团体属性的应用日益广泛，原有四字节的团体属性无法满足用户的需求。因此，BGP定义了新的路由属性——扩展团体属性。扩展团体属性与团体属性有如下不同：</p>
<p> 扩展团体属性为八字节，提供了更多的属性值。</p>
<p> 扩展团体属性可以划分类型。在不同的组网应用中，可以使用不同类型的扩展团体属性对路由进行过滤和控制。与不区分类型、统一使用同一个属性值空间的团体属性相比，扩展团体属性的配置和管理更为简单。</p>
<p>目前，设备支持的扩展团体属性有VPN Target属性和SoO（Site of Origin，源站点）属性。</p>
<p>SoO扩展团体属性用来标识路由的原始站点。路由器不会将带有SoO属性的路由发布给该SoO标识的站点，确保来自某个站点的路由不会再被发布到该站点，从而避免路由环路。在AS路径信息丢失时，可以通过SoO属性来避免发生环路。</p>
<p>SoO属性有三种格式：</p>
<p> 16位自治系统号:32位用户自定义数，例如：101:3。</p>
<p> 32位IP地址:16位用户自定义数，例如：192.168.122.15:1。</p>
<p> 32位自治系统号:16位用户自定义数，其中的自治系统号最小值为65536。例如：65536:1。</p>
<h4 id="Originator-ID属性"><a href="#Originator-ID属性" class="headerlink" title="Originator_ID属性"></a>Originator_ID属性</h4><p>Originator_ID属性和Cluster_List属性用于解决路由反射器场景中的环路问题</p>
<h4 id="Cluster-list属性"><a href="#Cluster-list属性" class="headerlink" title="Cluster_list属性"></a>Cluster_list属性</h4><p>Originator_ID属性和Cluster_List属性用于解决路由反射器场景中的环路问题</p>
<h3 id="BGP选择路由的策略"><a href="#BGP选择路由的策略" class="headerlink" title="BGP选择路由的策略"></a>BGP选择路由的策略</h3><h4 id="华为设备BGP选路原则："><a href="#华为设备BGP选路原则：" class="headerlink" title="华为设备BGP选路原则："></a>华为设备BGP选路原则：</h4><p>当到达同一目的地存在多条路由时，BGP依次对比下列属性来选择路由：</p>
<ol>
<li><p><strong>优选协议首选值（PrefVal）最高的路由。</strong></p>
<p>协议首选值（**PrefVal）是华为设备的特有属性，该属性仅在本地有效。</p>
</li>
<li><p>优选本地优先级（Local_Pref）最高的路由。</p>
<p>如果路由没有本地优先级，BGP选路时将该路由按缺省的本地优先级100来处理。</p>
</li>
<li><p>依次优选手动聚合路由、自动聚合路由、<strong>network</strong>命令引入的路由、<strong>import-route</strong>命令引入的路由、从对等体学习的路由。</p>
</li>
<li><p>优选AS路径（AS_Path）最短的路由。</p>
</li>
<li><p>依次优选Origin类型为IGP、EGP、Incomplete的路由。</p>
</li>
<li><p>对于来自同一AS的路由，优选MED值最低的路由。</p>
</li>
<li><p>依次优选EBGP路由、IBGP路由、LocalCross路由、RemoteCross路由。</p>
<p>PE上某个VPN实例的VPNv4路由的ERT匹配其他VPN实例的IRT后复制到该VPN实例，称为LocalCross；从远端PE学习到的VPNv4路由的ERT匹配某个VPN实例的IRT后复制到该VPN实例，称为RemoteCross。</p>
</li>
<li><p>优选到BGP下一跳IGP度量值（metric）最小的路由。</p>
</li>
<li><p>优选Cluster_List最短的路由。</p>
</li>
<li><p>优选Router ID最小的设备发布的路由。</p>
</li>
<li><p>如果路由携带Originator_ID属性，选路过程中将比较Originator_ID的大小（不再比较Router ID），并优选Originator_ID最小的路由。</p>
</li>
<li><p>优选从具有最小IP Address的对等体学来的路由。</p>
</li>
</ol>
<blockquote>
<ul>
<li><p><strong>load-balancing as-path-relax</strong>命令用来设置路由在形成负载分担时不比较相同长度的AS-Path属性。</p>
<p>缺省情况下，路由在形成负载分担时比较路由的AS-Path属性。</p>
</li>
<li><p><strong>bestroute as-path-ignore</strong>命令用来配置BGP在选择最优路由时忽略AS路径属性。</p>
<p>缺省情况下，BGP将AS路径属性作为选择最优路由的一个条件。</p>
</li>
</ul>
</blockquote>
<h4 id="华三BGP选路原则"><a href="#华三BGP选路原则" class="headerlink" title="华三BGP选路原则"></a>华三BGP选路原则</h4><p>目前，BGP选择路由的过程为：</p>
<ol>
<li>丢弃下一跳（NEXT_HOP）不可达的路由；</li>
<li>优选首选值（Preferred-value）最大的路由；</li>
<li>优选本地优先级（LOCAL_PREF）最高的路由；</li>
<li>依次选择<strong>network</strong>命令生成的路由、<strong>import-route</strong>命令引入的路由、聚合路由；</li>
<li>优选AS路径（AS_PATH）最短的路由；</li>
<li>依次选择ORIGIN类型为IGP、EGP、Incomplete的路由；</li>
<li>优选MED值最低的路由；</li>
<li>依次选择从EBGP、联盟EBGP、联盟IBGP、IBGP学来的路由；</li>
<li>优选IGP Metric值最小的路由；</li>
<li>优选迭代深度值小的路由；</li>
<li>如果路由都来自EBGP邻居，并且Router ID不相同，优选曾经的最优路由；</li>
<li>优选Router ID最小的路由器发布的路由。如果路由包含RR属性，那么在路由选择过程中，就用ORIGINATOR_ID来替代Router ID；</li>
<li>优选CLUSTER_LIST长度最短的路由；</li>
<li>优选IP地址最小的对等体发布的路由。</li>
</ol>
<blockquote>
<ul>
<li><p><strong>balance as-path-neglect</strong> （可选）配置不同AS_PATH属性的路由能够形成BGP负载分担</p>
<p>缺省情况下，不同AS_PATH属性的路由之间不能形成BGP负载分担</p>
</li>
<li><p><strong>balance as-path-relax</strong> （可选）配置内容不同但长度相同的AS_PATH属性的路由能够形成BGP负载分担</p>
<p>缺省情况下，内容不同但长度相同的AS_PATH属性的路由不能形成BGP负载分担</p>
</li>
</ul>
</blockquote>
<h4 id="思科BGP选路原则："><a href="#思科BGP选路原则：" class="headerlink" title="思科BGP选路原则："></a>思科BGP选路原则：</h4><ol>
<li><p>refer the path with the highest WEIGHT. </p>
</li>
<li><p>refer the path with the highest <a href="https://www.cisco.com/en/US/tech/tk365/technologies_tech_note09186a00800c95bb.shtml#localpref" target="_blank" rel="noopener">LOCAL_PREF</a></p>
</li>
<li><p>refer the path that was locally originated via a <strong>network</strong> or <strong>aggregate</strong> BGP subcommand or through redistribution from an IGP.</p>
<p>Local paths that are sourced by the <a href="https://www.cisco.com/en/US/tech/tk365/technologies_tech_note09186a00800c95bb.shtml#networkcommand" target="_blank" rel="noopener"><strong>network</strong> </a>or <strong>redistribute</strong> commands are preferred over local aggregates that are sourced by the <a href="https://www.cisco.com/en/US/tech/tk365/technologies_tech_note09186a0080094826.shtml" target="_blank" rel="noopener"><strong>aggregate-address</strong> </a>command.</p>
</li>
<li><p>refer the path with the shortest AS_PATH.</p>
</li>
<li><p>refer the path with the lowest origin type.</p>
</li>
<li><p>refer the path with the lowest <a href="https://www.cisco.com/en/US/tech/tk365/technologies_tech_note09186a0080094934.shtml#med" target="_blank" rel="noopener">multi-exit discriminator (MED)</a>.</p>
</li>
<li><p>refer eBGP over iBGP paths.</p>
<p>If bestpath is selected, go to Step 9 (multipath).</p>
</li>
<li><p>refer the path with the lowest IGP metric to the BGP next hop.</p>
</li>
<li><p>etermine if multiple paths require installation in the routing table for <a href="https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13753-25.html#anc5" target="_blank" rel="noopener">BGP Multipath</a>.</p>
</li>
<li><p>n both paths are external, prefer the path that was received first (the oldest one).</p>
<p>This step minimizes route-flap because a newer path does not displace an older one, even if the newer path would be the preferred route based on the next decision criteria (Steps 11, 12, and 13).</p>
<p>Skip this step if any of these items is true:</p>
</li>
</ol>
<ul>
<li><p>You have enabled the <a href="https://www.cisco.com/en/US/docs/ios/iproute_bgp/command/reference/irg_bgp1.html#wp1112448" target="_blank" rel="noopener">bgp best path compare-routerid</a> command.</p>
</li>
<li><p>The router ID is the same for multiple paths because the routes were received from the same router.</p>
</li>
<li><p>There is no current best path. The current best path can be lost when, for example, the neighbor that offers the path goes down</p>
</li>
</ul>
<ol start="11">
<li><p>fer the route that comes from the BGP router with the lowest router ID.</p>
<p>The router ID is the highest IP address on the router, with preference given to loopback addresses. Also, you can use the <a href="https://www.cisco.com/en/US/docs/ios/iproute_bgp/command/reference/irg_bgp1.html#wp1115802" target="_blank" rel="noopener">bgp router-id</a> command to manually set the router ID.</p>
</li>
<li><p>the originator or router ID is the same for multiple paths, prefer the path with the minimum cluster list length.</p>
<p>This is only present in BGP RR environments. It allows clients to peer with RRs or clients in other clusters. In this scenario, the client must be aware of the RR-specific BGP attribute.</p>
</li>
<li><p>Prefer the path that comes from the lowest neighbor address.</p>
<p>This address is the IP address that is used in the BGP <strong>neighbor</strong> configuration. The address corresponds to the remote peer that is used in the TCP connection with the local router.</p>
</li>
</ol>
<h3 id="BGP负载分担"><a href="#BGP负载分担" class="headerlink" title="BGP负载分担"></a>BGP负载分担</h3><p>当到达同一目的地址存在多条等价路由时，可以通过BGP等价负载分担实现均衡流量的目的。形成BGP等价负载分担的条件是“BGP选择路由的策略”的1至8条规则中需要比较的属性完全相同。</p>
<p><strong>华三文档：</strong></p>
<p>BGP可以通过如下两种方式实现负载分担：</p>
<p> 基于迭代路由实现负载分担</p>
<p>由于BGP协议本身的特殊性，它产生的路由的下一跳地址可能不是当前路由器直接相连的邻居。常见的一个原因是：IBGP之间发布路由信息时不改变下一跳。这种情况下，为了能够将报文正确转发出去，路由器必须先找到一个直接可达的地址（查找IGP建立的路由表项），通过这个地址到达路由表中指示的下一跳。在上述过程中，去往直接可达地址的路由被称为依赖路由，BGP路由依赖于这些路由指导报文转发。根据下一跳地址找到依赖路由的过程就是路由迭代。</p>
<p>目前系统支持基于迭代的BGP负载分担，即如果依赖路由本身是负载分担的（假设有三个下一跳地址），则BGP也会生成与依赖路由数量相同的下一跳地址来指导报文转发。需要说明的是，基于迭代的BGP负载分担并不需要命令配置，这一特性在系统上始终启用。</p>
<p> 通过改变BGP选路规则实现负载分担</p>
<p>在实现方法上，BGP的负载分担与IGP的负载分担有所不同：</p>
<p> IGP（如RIP、OSPF）是通过协议定义的路由算法，对到达同一目的地址的不同路由，根据计算结果，将度量值（metric）相等的路由进行负载分担，选择的标准很明确（按metric）。</p>
<p> BGP本身并没有路由计算的算法，它只是一个选路的路由协议，因此，不能根据一个明确的度量值决定是否对路由进行负载分担，但BGP有丰富的选路规则，可以在对路由进行一定的选择后，有条件地进行负载分担，也就是将负载分担加入到BGP的选路规则中去。</p>
<p>采用本方式进行负载分担时，BGP不再按照“选路规则”中的规则选择路由，当路由同时满足如下条件时，即在这些路由间进行负载分担：</p>
<p> ORIGIN属性、LOCAL_PREF属性和MED属性完全相同。如果未配置balance as-path-neglect命令，则要求AS_PATH属性也必须相同；如果配置了该命令，则AS_PATH属性可以不同。</p>
<p> 同为标签路由（具有对应MPLS标签值的路由）或同为非标签路由。</p>
<p> 如果未配置balance as-path-neglect命令，形成负载分担的路由的AS_PATH属性相同，则发布路由的AS_PATH属性就为该值；如果配置了balance as-path-neglect命令，形成负载分担的路由的AS_PATH属性不同，则发布路由的AS_PATH属性为最佳路由的AS_PATH属性。</p>
<p> NEXT_HOP属性改变为Router C的地址，而不是原来的EBGP对等体地址。</p>
<p> 其它的BGP路由属性为最佳路由的属性。</p>
<p><strong>思科文档：</strong></p>
<p>In order to be candidates for multipath, paths to the same destination need to have these characteristics equal to the best-path characteristics:</p>
<p>Weight</p>
<p>Local preference</p>
<p>AS-PATH length</p>
<p>Origin</p>
<p>MED</p>
<p>One of these:</p>
<p>Neighboring AS or sub-AS (before the addition of the eiBGP Multipath feature)</p>
<p>AS-PATH (after the addition of the eiBGP Multipath feature)</p>
<p>Some BGP Multipath features put additional requirements on multipath candidates.</p>
<p>These are the additional requirements for eBGP multipath:</p>
<p>The path should be learned from an external or confederation-external neighbor (eBGP).</p>
<p>The IGP metric to the BGP next hop should be equal to the best-path IGP metric.</p>
<p>These are the additional requirements for iBGP multipath:</p>
<p>The path should be learned from an internal neighbor (iBGP).</p>
<p>The IGP metric to the BGP next hop should be equal to the best-path IGP metric, unless the router is configured for unequal-cost iBGP multipath.</p>
<p>BGP inserts up to <em>n</em> most recently received paths from multipath candidates in the IP routing table. The maximum value of <em>n</em> is currently 6. The default value, when multipath is disabled, is 1.</p>
<p>For unequal-cost load balancing, you can also use BGP Link Bandwidth. </p>
<h2 id="路由反射器"><a href="#路由反射器" class="headerlink" title="路由反射器"></a>路由反射器</h2><p>为保证IBGP对等体之间的连通性，需要在IBGP对等体之间建立全连接关系。假设在一个AS内部有n台设备，那么建立的IBGP连接数就为n(n-1)/2。当设备数目很多时，设备配置将十分复杂，而且配置后网络资源和CPU资源的消耗都很大。在IBGP对等体间使用路由反射器可以解决以上问题。</p>
<h3 id="路由反射器相关角色"><a href="#路由反射器相关角色" class="headerlink" title="路由反射器相关角色"></a>路由反射器相关角色</h3><p>在一个AS内部关于路由反射器有以下几种角色：</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/反射器.png" alt="反射器"></p>
<ul>
<li>路由反射器RR（Route Reflector）：允许把从IBGP对等体学到的路由反射到其他IBGP对等体的BGP设备，类似OSPF网络中的DR。</li>
<li>客户机（Client）：与RR形成反射邻居关系的IBGP设备。在AS内部客户机只需要与RR直连。</li>
<li>非客户机（Non-Client）：既不是RR也不是客户机的IBGP设备。在AS内部非客户机与RR之间，以及所有的非客户机之间仍然必须建立全连接关系。</li>
<li>始发者（Originator）：在AS内部始发路由的设备。Originator_ID属性用于防止集群内产生路由环路。</li>
<li>集群（Cluster）：路由反射器及其客户机的集合。Cluster_List属性用于防止集群间产生路由环路。</li>
</ul>
<h3 id="路由反射器原理"><a href="#路由反射器原理" class="headerlink" title="路由反射器原理"></a>路由反射器原理</h3><p>同一集群内的客户机只需要与该集群的RR直接交换路由信息，因此客户机只需要与RR之间建立IBGP连接，不需要与其他客户机建立IBGP连接，从而减少了IBGP连接数量。如上图所示，在AS65000内一台设备作为RR，三台设备作为客户机，形成Cluster1。此时AS65000中IBGP的连接数从配置RR前的10条减少到4条，不仅简化了设备的配置，也减轻了网络和CPU的负担。</p>
<p>RR突破了“从IBGP对等体获得的BGP路由，BGP设备只发布给它的EBGP对等体。”的限制，并采用独有的Cluster_List属性和Originator_ID属性防止路由环路。RR向IBGP邻居发布路由规则如下：</p>
<ul>
<li>从非客户机学到的路由，发布给所有客户机。</li>
<li>从客户机学到的路由，发布给所有非客户机和客户机（发起此路由的客户机除外）。</li>
<li>从EBGP对等体学到的路由，发布给所有的非客户机和客户机。</li>
</ul>
<h3 id="Cluster-List属性"><a href="#Cluster-List属性" class="headerlink" title="Cluster_List属性"></a>Cluster_List属性</h3><p>路由反射器和它的客户机组成一个集群（Cluster），使用AS内唯一的Cluster ID作为标识。为了防止集群间产生路由环路，路由反射器使用Cluster_List属性，记录路由经过的所有集群的Cluster ID。</p>
<p>当一条路由第一次被RR反射的时候，RR会把本地Cluster ID添加到Cluster List的前面。如果没有Cluster_List属性，RR就创建一个。</p>
<p>当RR接收到一条更新路由时，RR会检查Cluster List。如果Cluster List中已经有本地Cluster ID，丢弃该路由；如果没有本地Cluster ID，将其加入Cluster List，然后反射该更新路由。</p>
<h3 id="备份路由反射器"><a href="#备份路由反射器" class="headerlink" title="备份路由反射器"></a>备份路由反射器</h3><p>为增加网络的可靠性，防止单点故障对网络造成影响，有时需要在一个集群中配置一个以上的RR。由于RR打破了从IBGP对等体收到的路由不能传递给其他IBGP对等体的限制，所以同一集群内的RR之间中可能存在环路。这时，该集群中的所有RR必须使用相同的Cluster ID，以避免RR之间的路由环路。</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/备份.png" alt="备份"></p>
<p>如上图，路由反射器RR1和RR2在同一个集群内，配置了相同的Cluster ID。</p>
<p>当客户机Client1从EBGP对等体接收到一条更新路由，它将通过IBGP向RR1和RR2通告这条路由。</p>
<p>RR1和RR2在接收到该更新路由后，将本地Cluster ID添加到Cluster List前面，然后向其他的客户机（Client2、Client3）反射，同时相互反射。</p>
<p>RR1和RR2在接收到该反射路由后，检查Cluster List，发现自己的Cluster ID已经包含在Cluster List中。于是RR1和RR2丢弃该更新路由，从而避免了路由环路。</p>
<h3 id="多集群路由反射器"><a href="#多集群路由反射器" class="headerlink" title="多集群路由反射器"></a>多集群路由反射器</h3><p>一个AS中可以存在多个集群，各个集群的RR之间建立IBGP对等体。当RR所处的网络层不同时，可以将较低网络层次的RR配成客户机，形成分级RR。当RR所处的网络层相同时，可以将不同集群的RR全连接，形成同级RR。</p>
<h4 id="分级的路由反射器"><a href="#分级的路由反射器" class="headerlink" title="分级的路由反射器"></a>分级的路由反射器</h4><p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/分级.png" alt="分级"></p>
<p>在实际的RR部署中，常用的是分级RR的场景。ISP为AS100提供Internet路由。AS100内部分为两个集群，其中Cluster1内的四台设备是核心路由器，采用备份RR的形式保证可靠性。</p>
<h4 id="同级路由反射器"><a href="#同级路由反射器" class="headerlink" title="同级路由反射器"></a>同级路由反射器</h4><p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/同级.png" alt="同级"></p>
<p>一个骨干网被分成多个集群。各集群的RR互为非客户机关系，并建立全连接。此时虽然每个客户机只与所在集群的RR建立IBGP连接，但所有RR和客户机都能收到全部路由信息。</p>
<h2 id="BGP联盟"><a href="#BGP联盟" class="headerlink" title="BGP联盟"></a>BGP联盟</h2><p>解决AS内部的IBGP网络连接激增问题，除了使用路由反射器之外，还可以使用联盟（Confederation）。联盟将一个AS划分为若干个子AS。每个子AS内部建立IBGP全连接关系，子AS之间建立联盟EBGP连接关系，但联盟外部AS仍认为联盟是一个AS。配置联盟后，原AS号将作为每个路由器的联盟ID。这样有两个好处：一是可以保留原有的IBGP属性，包括Local Preference属性、MED属性和NEXT_HOP属性等；二是联盟相关的属性在传出联盟时会自动被删除，即管理员无需在联盟的出口处配置过滤子AS号等信息的操作。</p>
<p> <img src="/2020/04/18/BGP知识手册-华为-华三-思科/联盟.png" alt="联盟"></p>
<p>如上图，所示，AS100使用联盟后被划分为3个子AS：AS65001、AS65002和AS65003，使用AS100作为联盟ID。此时IBGP的连接数量从10条减少到4条，不仅简化了设备的配置，也减轻了网络和CPU的负担。而AS100外的BGP设备因为仅知道AS100的存在，并不知道AS100内部的联盟关系，所以不会增加CPU的负担。</p>
<h3 id="路由反射器和联盟的比较"><a href="#路由反射器和联盟的比较" class="headerlink" title="路由反射器和联盟的比较"></a>路由反射器和联盟的比较</h3><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>路由反射器</strong></td>
<td><strong>联盟</strong></td>
</tr>
<tr>
<td>不需要更改现有的网络拓扑，兼容性好。</td>
<td>需要改变逻辑拓扑。</td>
</tr>
<tr>
<td>配置方便，只需要对作为反射器的设备进行配置，客户机并不需要知道自己是客户机。</td>
<td>所有设备需要重新进行配置。</td>
</tr>
<tr>
<td>集群与集群之间仍然需要全连接。</td>
<td>联盟的子AS之间是特殊的EBGP连接，不需要全连接。</td>
</tr>
<tr>
<td>适用于中、大规模网络。</td>
<td>适用于大规模网络。</td>
</tr>
</tbody>
</table>
<h2 id="路由聚合"><a href="#路由聚合" class="headerlink" title="路由聚合"></a>路由聚合</h2><p>在大规模的网络中，BGP路由表十分庞大，给设备造成了很大的负担，同时使发生路由振荡的几率也大大增加，影响网络的稳定性。</p>
<p>路由聚合是将多条路由合并的机制，它通过只向对等体发送聚合后的路由而不发送所有的具体路由的方法，减小路由表的规模。并且被聚合的路由如果发生路由振荡，也不再对网络造成影响，从而提高了网络的稳定性。</p>
<p>BGP在IPv4网络中支持自动聚合和手动聚合两种方式，而IPv6网络中仅支持手动聚合方式：</p>
<p>自动聚合：对BGP引入的路由进行聚合。配置自动聚合后，BGP将按照自然网段聚合路由（例如非自然网段A类地址10.1.1.1/24和10.2.1.1/24将聚合为自然网段A类地址10.0.0.0/8），并且BGP向对等体只发送聚合后的路由。</p>
<p>手动聚合：对BGP本地路由表中存在的路由进行聚合。手动聚合可以控制聚合路由的属性，以及决定是否发布具体路由。</p>
<p>为了避免路由聚合可能引起的路由环路，BGP设计了AS_Set属性。AS_Set属性是一种无序的AS_Path属性，标明聚合路由所经过的AS号。当聚合路由重新进入AS_Set属性中列出的任何一个AS时，BGP将会检测到自己的AS号在聚合路由的AS_Set属性中，于是会丢弃该聚合路由，从而避免了路由环路的形成。</p>
<h2 id="路由衰减"><a href="#路由衰减" class="headerlink" title="路由衰减"></a>路由衰减</h2><p>当BGP应用于复杂的网络环境时，路由振荡十分频繁。为了防止频繁的路由振荡带来的不利影响，BGP使用路由衰减来抑制不稳定的路由。</p>
<p>路由振荡指路由表中添加一条路由后，该路由又被撤销的过程。当发生路由振荡时，设备就会向邻居发布路由更新，收到更新报文的设备需要重新计算路由并修改路由表。所以频繁的路由振荡会消耗大量的带宽资源和CPU资源，严重时会影响到网络的正常工作。</p>
<p>BGP衰减示意图</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/惩罚值.png" alt="惩罚值"></p>
<p>路由衰减使用惩罚值（Penalty value）来衡量一条路由的稳定性，惩罚值越高说明路由越不稳定。如上图所示，路由每发生一次振荡，BGP便会给此路由增加1000的惩罚值，其余时间惩罚值会慢慢下降。当惩罚值超过抑制阈值（suppress value）时，此路由被抑制，不加入到路由表中，也不再向其他BGP对等体发布更新报文。被抑制的路由每经过一段时间，惩罚值便会减少一半，这个时间称为半衰期（half-life）。当惩罚值降到再使用阈值（reuse value）时，此路由变为可用并被加入到路由表中，同时向其他BGP对等体发布更新报文。从路由被抑制到路由恢复可用的时间称为抑制时间（suppress time）。</p>
<p><strong>路由衰减只对EBGP路由起作用，对IBGP路由不起作用。这是因为IBGP路由可能含有本AS的路由，而IGP网络要求AS内部路由表尽可能一致。如果路由衰减对IBGP路由起作用，那么当不同设备的衰减参数不一致时，将会导致路由表不一致。</strong></p>
<h2 id="BMP"><a href="#BMP" class="headerlink" title="BMP"></a>BMP</h2><p>BGP监控协议BGP Monitoring Protocol（BMP）能够对网络中的设备的BGP运行状态进行实时监控，BGP运行状态包括对等体关系的建立与解除、路由信息刷新等。</p>
<p>实现BMP之前，只能通过人工查询方式来获得设备的BGP运行状态，效率较低；实现BMP之后，设备可通过与监控服务器的连接，向监控服务器上报其运行状态信息，大大提升了网络监控的效率。通过BMP了解BGP运行状态，可以及时发现网络中的安全隐患并采取规避措施，保障了网络的稳定性。</p>
<h3 id="BMP消息类型"><a href="#BMP消息类型" class="headerlink" title="BMP消息类型"></a>BMP消息类型</h3><p>BMP会话包含Initiation、PU、RM、PD、SR、Termination六种消息，六种消息均以报文形式发送。上报的信息主要为BGP路由信息、BGP邻居信息和设备的厂商信息、版本号等。</p>
<p>Initiation消息：初始化消息，向监控服务器通告厂商信息、版本号等。</p>
<ul>
<li>PU（Peer Up Notification）消息：向监控服务器上报与对等体BGP连接的建立。</li>
<li>RM（Route Monitoring）消息：路由监控消息，向监控服务器发送从对等体收到的所有路由，并随时向监控服务器上报路由的新增或撤销。</li>
<li>PD（Peer Down Notification）消息：向监控服务器上报与对等体BGP连接的中断。</li>
<li>SR（Stats Reports）消息：向监控服务器上报设备运行状态的统计信息。</li>
<li>Termination消息：结束消息，向监控服务器通告关闭BMP会话的原因。</li>
<li>BMP会话是单向的，即设备向监控服务器上报消息但忽略监控服务器发送的任何消息。</li>
</ul>
<h3 id="BMP工作原理"><a href="#BMP工作原理" class="headerlink" title="BMP工作原理"></a>BMP工作原理</h3><p>BMP典型组网；</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/bmp.png" alt="bmp"></p>
<p>被监控设备（如图中的PE1、PE2）与监控服务器建立TCP连接，监控服务器无需发送任何指令给被监控设备，被监控设备就会发送BGP运行状态信息给监控服务器，监控服务器解析接收到的BMP报文并呈现在监控视图中。设备发送给监控服务器的报文都带有表示对等体信息的报文头，从而监控服务器可以区分出报文来自哪个BGP邻居。</p>
<p>设备与监控服务器建立连接时需要注意以下几点：</p>
<ul>
<li>设备与监控服务器的连接基于TCP协议，可以指定连接端口号。</li>
<li>设备与监控服务器的连接可以是多对多的关系。</li>
<li>一个BMP实例仅能连接一台监控服务器。</li>
<li>监控服务器监控所有BGP邻居，不可以指定需要监控的邻居。</li>
</ul>
<h2 id="BGP与BFD联动"><a href="#BGP与BFD联动" class="headerlink" title="BGP与BFD联动"></a>BGP与BFD联动</h2><p>BGP协议通过周期性的向对等体发送报文来实现邻居检测机制。但这种机制检测到故障所需时间比较长，超过1秒钟。当数据的传输速度达到Gbit/s级别时，这种机制的检测时间将导致大量数据丢失，无法满足网络高可靠性的需求。BGP与BFD（Bidirectional Forwarding Detection）联动可以利用BFD的毫秒级快速检测机制解决上述问题。</p>
<p>BGP与BFD联动组网图</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/bfd.png" alt="bfd"></p>
<p>如上图所示，RouterA和RouterB分别属于AS100和AS200，两台路由器直接相连并建立EBGP连接，并配置BGP与BFD联动。当RouterA和RouterB之间的链路发生故障时，BFD利用毫秒级检测机制感知到BFD会话状态由Up变为Down，并通知RouterA和RouterB。RouterA和RouterB处理邻居Down事件，重新进行BGP选路。</p>
<h2 id="BGP-Auto-FRR"><a href="#BGP-Auto-FRR" class="headerlink" title="BGP Auto FRR"></a>BGP Auto FRR</h2><p>BGP Auto FRR（BGP Auto Fast ReRoute）是一种链路故障保护措施，应用于有主备链路的网络拓扑结构中，可以使BGP的两个邻居切换或者两个下一跳切换达到亚秒级的收敛速度。</p>
<p>BGP Auto FRR对于从不同对等体学到的相同前缀的路由，利用最优路由作为主链路进行转发，并自动将次优路由作为备份链路。当主链路出现故障的时候，系统快速响应BGP路由不可达的通知，并将转发路径切换到备份链路上保证数据转发。在BGP收敛后，BGP Auto FRR再将流量按BGP选出的最佳路由指导转发。</p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p> <img src="/2020/04/18/BGP知识手册-华为-华三-思科/ying.png" alt="ying"></p>
<p>BGP Auto FRR示意图：</p>
<p>所示，RouterD将学到的BGP路由发往AS100中的RouterB和RouterC，然后RouterB和RouterC通过反射器将路由发到RouterA上，RouterA上收到下一跳为RouterB和RouterC的两份路由，配置策略优选其中一条链路上收到的路由，这里假设在RouterA上优选从RouterB发来的路由，主链路是LinkB，备份链路是LinkC。</p>
<p>在RouterA上使能Auto FRR，当域内LinkB经过的节点或者链路出现故障的时候，RouterA上到RouterB的下一跳信息就会失效，触发转发平面迅速将从RouterA到RouterD流量快速切换到LinkC上，优先保证流量不丢失。同时，RouterA重新进行BGP选路，优选从RouterC发来的路由并更新FIB。</p>
<h2 id="BGP-GR和NSR"><a href="#BGP-GR和NSR" class="headerlink" title="BGP GR和NSR"></a>BGP GR和NSR</h2><p>BGP的平滑重启GR（Graceful Restart）和不间断路由NSR（Non-Stop Routing）作为高可靠性的解决方案，其根本目的都是为了保证用户业务在设备故障的时候不受影响或者影响最小。</p>
<h3 id="BGP-GR"><a href="#BGP-GR" class="headerlink" title="BGP GR"></a>BGP GR</h3><p>BGP GR技术保证了在设备重启或者主备倒换过程中转发层面能够继续指导数据的转发，同时控制层面邻居关系的重建以及路由计算等动作不会影响转发层面的功能，从而避免了路由震荡引发的业务中断，提高了整网的可靠性。</p>
<p>GR相关概念：</p>
<ul>
<li>GR Restarter：指由管理员触发或故障触发后，以GR方式重启的设备。</li>
<li>GR Helper：GR Restarter的邻居，协助GR Restarter进行GR的设备。</li>
<li>GR Time：是GR Helper检测到GR Restarter重启或者主备倒换后，保持转发信息不删除的时间。</li>
</ul>
<p>BGP GR的过程是：</p>
<ol>
<li>利用BGP的能力协商机制，GR Restarter和GR Helper了解彼此的GR能力，建立有GR能力的会话。</li>
<li>当GR Helper检查到GR Restarter重启或者主备倒换后，不删除和GR Restarter相关的路由和转发表项，也不通知其他邻居，而是等待重建BGP连接。</li>
<li>GR Restarter在GR Time超时前与重启前的所有GR Helper新建立好邻居关系。</li>
</ol>
<h3 id="BGP-NSR"><a href="#BGP-NSR" class="headerlink" title="BGP NSR"></a>BGP NSR</h3><p>NSR是一种控制平面倒换而邻居不感知的可靠性技术，适用于设备具有主用主控板和备用主控板的场景。与GR相比，NSR具有不需要邻居协助，不存在互通性问题的优点。</p>
<p>设备上NSR功能缺省使能，无需配置。</p>
<h3 id="有无GR、NSR技术的比较"><a href="#有无GR、NSR技术的比较" class="headerlink" title="有无GR、NSR技术的比较"></a>有无GR、NSR技术的比较</h3><table>
<thead>
<tr>
<th><strong>无GR、NSR技术的主备倒换</strong></th>
<th><strong>有GR技术的主备倒换</strong></th>
<th><strong>有NSR技术的主备倒换</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>BGP邻居重建</td>
<td>BGP邻居重建</td>
<td>BGP邻居重建</td>
</tr>
<tr>
<td>路由重新计算</td>
<td>路由重新计算</td>
<td>路由重新计算</td>
</tr>
<tr>
<td>转发表变化</td>
<td>转发表保持不变</td>
<td>转发表保持不变</td>
</tr>
<tr>
<td>转发流量丢失，业务中断</td>
<td>转发流量零丢失，业务不受影响</td>
<td>转发流量零丢失，业务不受影响</td>
</tr>
<tr>
<td>整网感知路由变化，路由短时震荡</td>
<td>除主备倒换设备的邻居外的其他路由器感知不到路由变化</td>
<td>整网不感知路由变化</td>
</tr>
<tr>
<td>-</td>
<td>GR Restarter需要邻居支持GR Helper功能，GR Helper不支持多邻居节点同时以GR方式主备倒换</td>
<td>不需要邻居支持NSR功能</td>
</tr>
</tbody>
</table>
<h2 id="BGP-ORF"><a href="#BGP-ORF" class="headerlink" title="BGP ORF"></a>BGP ORF</h2><p>RFC5291、RFC5292规定了BGP基于前缀的ORF（Outbound Route Filtering）能力，能将本端设备配置的基于前缀的入口策略通过路由刷新报文发送给BGP邻居。BGP邻居根据这些策略构造出口策略，在路由发送时对路由进行过滤。这样不仅避免了本端设备接收大量无用的路由，降低了本端设备的CPU使用率，还有效减少了BGP邻居的配置工作，降低了链路带宽的占用率。</p>
<h3 id="应用："><a href="#应用：" class="headerlink" title="应用："></a>应用：</h3><p>当本端设备希望BGP邻居只发送它需要的路由，而BGP邻居又不愿意针对不同设备维护不同的出口策略时，可以运用BGP ORF特性。</p>
<p><strong>图1</strong> 域间EBGP邻居场景</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/ying2.png" alt="ying2"></p>
<p>如<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0016.html?ft=0&amp;fe=10&amp;hib=6.8.10.2.14&amp;id=dc_feature_bgp_0016#dc_feature_bgp_0016__fig_dc_feature_bgp_001601" target="_blank" rel="noopener">图1</a>所示，直连BGP邻居中，RouterA、RouterB协商基于前缀的ORF能力后，RouterA将本地配置的基于前缀的入口策略打包到Route-refresh报文中发送给RouterB。RouterB根据接收到的路由刷新报文构造出口策略，通过Route-refresh报文发送路由给RouterA。RouterA只收到它需要的路由，而RouterB不必维护路由策略，减少了配置工作。</p>
<p><strong>图2</strong> 域内RR场景</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/ying3.png" alt="ying3"></p>
<p>如<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0016.html?ft=0&amp;fe=10&amp;hib=6.8.10.2.14&amp;id=dc_feature_bgp_0016#dc_feature_bgp_0016__fig_dc_feature_bgp_001602" target="_blank" rel="noopener">图2</a>所示，域内带RR的BGP邻居，RouterA、RouterB为RR的客户端，RouterA与RR、RouterB与RR，分别协商基于前缀的ORF能力，RouterA、RouterB将本地配置的基于前缀的入口策略打包到Route-refresh报文中发送给RR。RR根据接收到的前缀信息构造出口策略，通过Route-refresh报文将路由反射给RouterA、RouterB。RouterA和RouterB只收到需要的路由，RR不必维护路由策略，减少了配置工作。</p>
<h2 id="BGP按组打包"><a href="#BGP按组打包" class="headerlink" title="BGP按组打包"></a>BGP按组打包</h2><p>目前现网路由表的快速增长，以及网络拓扑的复杂性导致BGP需要支持更多的邻居。特别是一些邻居数目多且路由量大的场景下，针对路由器需要给大量的BGP邻居发送路由，且大部分邻居具有相同出口策略的特点，要求较高的打包发包性能。</p>
<p>按组打包技术将所有拥有共同出口策略的BGP邻居当作是一个打包组。这样每条待发送路由只被打包一次然后发给组内的所有邻居，使打包效率指数级提升。例如，一个反射器有100个客户机，有10万条路由需要反射。如果按照每个邻居分别打包的方式，反射器RR在向100个客户机发送路由的时候，所有路由被打包的总次数是10万×100。而按组打包技术将这个过程变为10万×1，性能相当于提升了100倍。</p>
<h3 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h3><p>在邻居数目多、路由量大且大部分邻居具有相同出口策略的场景下，按组打包技术极大的提高了BGP打包发包性能。按组打包的典型应用场景主要有以下三种情况：</p>
<h4 id="在国际关口局场景"><a href="#在国际关口局场景" class="headerlink" title="在国际关口局场景"></a>在国际关口局场景</h4><p>如<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0017.html?ft=0&amp;fe=10&amp;hib=6.8.10.2.15&amp;id=dc_feature_bgp_0017#dc_feature_bgp_0017__fig_dc_feature_bgp_001701" target="_blank" rel="noopener">图1</a>所示，IGW Router会向所有相邻AS发送路由。如果IGW Router支持BGP按组打包功能，那么它的BGP的转发性能将得到较大的提升。</p>
<p><strong>图1</strong> 国际关口局典型组网图</p>
<p> <img src="/2020/04/18/BGP知识手册-华为-华三-思科/c1.png" alt="c1"></p>
<h4 id="路由反射器场景"><a href="#路由反射器场景" class="headerlink" title="路由反射器场景"></a>路由反射器场景</h4><p>如<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0017.html?ft=0&amp;fe=10&amp;hib=6.8.10.2.15&amp;id=dc_feature_bgp_0017#dc_feature_bgp_0017__fig_dc_feature_bgp_001702" target="_blank" rel="noopener">图2</a>所示，RR会向所有Client发送路由。如果RR支持BGP按组打包功能，那么它的BGP的转发性能将得到较大的提升。</p>
<p><strong>图2</strong> 路由反射器典型组网图</p>
<p><img src="/2020/04/18/BGP知识手册-华为-华三-思科/c2.png" alt="c2"></p>
<h4 id="ASBR场景"><a href="#ASBR场景" class="headerlink" title="ASBR场景"></a>ASBR场景</h4><p>如<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/dc_feature_bgp_0017.html?ft=0&amp;fe=10&amp;hib=6.8.10.2.15&amp;id=dc_feature_bgp_0017#dc_feature_bgp_0017__fig_dc_feature_bgp_001703" target="_blank" rel="noopener">图3</a>所示，作为ASBR的RouterB从EBGP邻居RouterA收来路由后，会向所有IBGP邻居发送。如果RouterB支持BGP按组打包功能，那么它的BGP的转发性能将得到较大的提升。</p>
<p><strong>图3</strong> PE与多个IBGP邻居连接典型组网图</p>
<p> <img src="/2020/04/18/BGP知识手册-华为-华三-思科/c3.png" alt="c3"></p>
<h2 id="MP-BGP"><a href="#MP-BGP" class="headerlink" title="MP-BGP"></a>MP-BGP</h2><p>传统的BGP-4只能管理IPv4单播路由信息，对于使用其它网络层协议（如IPv6、组播等）的应用，在跨AS传播时就受到一定限制。BGP多协议扩展MP-BGP（MultiProtocol BGP）就是为了提供对多种网络层协议的支持，对BGP-4进行的扩展。目前的MP-BGP标准是RFC4760，使用扩展属性和地址族来实现对IPv6、组播和VPN相关内容的支持，BGP协议原有的报文机制和路由机制并没有改变。</p>
<p>MP-BGP对IPv6单播网络的支持特性称为BGP4+，对IPv4组播网络的支持特性称为MBGP（Multicast BGP）。MP-BGP为IPv6单播网络和IPv4组播网络建立独立的拓扑结构，并将路由信息储存在独立的路由表中，保持单播IPv4网络、单播IPv6网络和组播网络之间路由信息相互隔离，也就实现了用单独的路由策略维护各自网络的路由。</p>
<h3 id="扩展属性"><a href="#扩展属性" class="headerlink" title="扩展属性"></a>扩展属性</h3><p>BGP使用的报文中，与IPv4相关的三处信息都由Update报文携带，这三处信息分别是：NLRI字段、Next_Hop属性、Aggregator属性。</p>
<p>为实现对多种网络层协议的支持，BGP需要将网络层协议的信息反映到NLRI及Next_Hop。因此MP-BGP引入了两个新的可选非过渡路径属性：</p>
<ul>
<li>MP_REACH_NLRI：Multiprotocol Reachable NLRI，多协议可达NLRI。用于发布可达路由及下一跳信息。</li>
<li>MP_UNREACH_NLRI：Multiprotocol Unreachable NLRI，多协议不可达NLRI。用于撤销不可达路由。</li>
</ul>
<h3 id="地址族"><a href="#地址族" class="headerlink" title="地址族"></a>地址族</h3><p>MP-BGP采用地址族（Address Family）来区分不同的网络层协议，目前支持的地址族视图包括：</p>
<ul>
<li>BGP-IPv4单播地址族视图</li>
<li>BGP-IPv4组播地址族视图</li>
<li>BGP-VPN实例IPv4地址族视图</li>
<li>BGP-VPNv4地址族视图</li>
<li>BGP-IPv6单播地址族视图</li>
<li>BGP-VPN实例IPv6地址族视图</li>
<li>BGP-VPNv6地址族视图</li>
</ul>
<h2 id="BGP多进程（华三）"><a href="#BGP多进程（华三）" class="headerlink" title="BGP多进程（华三）"></a>BGP多进程（华三）</h2><p>一台BGP路由器上可以同时启动多个BGP进程，每个BGP进程对应一个BGP实例。BGP为不同的BGP实例维护独立的路由表。</p>
<p>BGP对BGP实例具有如下要求：</p>
<ul>
<li>一个BGP实例下可以创建多个公网地址族，但不同BGP实例下不能创建相同的公网地址族（公网IPv4单播地址族、公网IPv6单播地址族、公网VPNv4和公网VPNv6地址族除外）。</li>
<li>一个BGP实例下可以创建多个VPN实例，每个VPN实例下可以创建多个地址族，但不同BGP实例下不能创建相同的VPN实例。</li>
<li>不同BGP实例对</li>
</ul>
<h1 id="华为设备BGP相关配置"><a href="#华为设备BGP相关配置" class="headerlink" title="华为设备BGP相关配置"></a>华为设备BGP相关配置</h1><h2 id="BGP配置任务概览"><a href="#BGP配置任务概览" class="headerlink" title="BGP配置任务概览"></a>BGP配置任务概览</h2><p>\1.      <strong>配置BGP的基本功能</strong>：配置BGP的基本功能是组建BGP网络的基础，是能够使用BGP其他功能的前提。</p>
<p>\2.      <strong>配置BGP安全性</strong>：在BGP网络中，非法用户可以通过篡改数据报文或者伪装成认证用户攻击BGP网络。为了解决BGP网络承载的业务的安全性问题，可以配置BGP MD5认证或BGP Keychain认证。</p>
<p><strong>3.</strong>      <strong>监控IBGP网络连接:</strong> 在BGP网络中，非法用户可以通过篡改数据报文或者伪装成认证用户攻击BGP网络。为了解决BGP网络承载的业务的安全性问题，可以配置BGP MD5认证或BGP Keychain认证。</p>
<p><strong>4.</strong>      <strong>配置BGP路由选路和负载分担:</strong> 在BGP路由表中，到达同一目的地可能存在多条路由。为了指导路由选路，BGP规定了下一跳策略和路由选路规则，其中下一跳策略的优先级比BGP路由选路规则高。在执行完下一跳策略后，BGP使用选路规则进行路由选择。</p>
<p>网络中到达同一目的地通常会存在多条有效路由，如果BGP只将最优路由发布给对等体，这样就造成很多流量负载不均衡的情况。通过配置BGP负载分担，可以使流量负载均衡，减少网络拥塞。</p>
<p><strong>5.</strong>      <strong>控制BGP路由的发布和接收</strong>：随着网络的日益扩大，路由表激增导致网络负担越来越重，网络安全问题也越来越多。通过路由策略来对路由进行筛选，只发送和接收需要的BGP路由，可以解决上述问题。此外，到达同一个目的地址，可能存在多条路由。如果这些路由分别需要穿越不同的AS，把业务流量引导向某些特定的AS，也可以对发布的路由进行筛选。</p>
<p><strong>6.</strong>      <strong>配置调整BGP网络的收敛速度：</strong>当需要BGP快速感知网络中的变化时，可以配置加快BGP网络的收敛速度。当需要减少防止路由振荡对网络的影响、减轻设备负担时，可以配置减慢BGP网络的收敛速度。</p>
<p><strong>7.</strong>      <strong>配置BGP可靠性：</strong>为了保证BGP网络发生故障时的业务不长时间中断，可以采用备份主控板和备份链路的方案。但BGP自带的机制检测到故障和主备倒换所需时间比较长，超过1秒钟。为了保证语音等对时延敏感的业务的用户不感知业务中断，可以使用BGP Tracking、BGP与BFD联动功能实现故障快速感知，同时使用BGP Auto FRR和BGP GR功能实现故障感知后的快速主备倒换。</p>
<p>\8.      <strong>配置BGP路由聚合：</strong>在中型或大型BGP网络中，BGP路由表会变得十分庞大，存储路由表占用大量的设备内存资源，传输和处理路由信息需要占用大量的网络资源。使用路由聚合（Routes Aggregation）不仅可以减小路由表的规模，还可以隐藏一些具体的路由，减少路由震荡对网络带来的影响。其中，虽然BGP自动路由聚合配置方便，但只能将路由聚合为自然网段的路由。BGP手动路由聚合可以结合灵活的路由策略，使BGP更有效的传递和控制路由。</p>
<p>\9.      <strong>配置向对等体发送缺省路由</strong>：在中型或大型BGP网络中，BGP路由表会变得十分庞大，存储路由表占用大量的设备内存资源，传输和处理路由信息需要占用大量的网络资源。当对等体的BGP路由表中的多条路由都只是由本端发送时，可以在本端配置向对等体发送缺省路由功能。这时无论本端的路由表中是否存在缺省路由，都会向对等体发布一条下一跳地址为本地地址的缺省路由。再使用路由策略使本端向对等体只发送该条缺省路由后，将很大程度地减少网络路由数量，节省对等体的内存资源与网络资源。</p>
<p><strong>10.</strong>   <strong>配置MP-BGP：</strong>传统的BGP-4只能管理IPv4单播网络的路由信息，无法支持IPv6、组播等其它网络的AS间路由的传播。为了提供对多种网络层协议的支持，IETF对BGP-4进行了扩展，形成MP-BGP，目前的MP-BGP标准是RFC4760（Multiprotocol Extensions for BGP-4，BGP-4的多协议扩展）。其中MP-BGP对IPv6网络的支持特性称为BGP4+，对组播网络的支持特性称为MBGP（Multicast BGP）。</p>
<h2 id="华为CE系列交换机BGP默认参数"><a href="#华为CE系列交换机BGP默认参数" class="headerlink" title="华为CE系列交换机BGP默认参数"></a>华为CE系列交换机BGP默认参数</h2><p><ce1865>display  default-parameter bgp </ce1865></p>
<p> BGP version               : 4</p>
<p> EBGP preference           : 255</p>
<p> IBGP preference           : 255</p>
<p> Local preference          : 255</p>
<p> BGP connect-retry         : 32s</p>
<p> BGP holdtime              : 180s</p>
<p> BGP keepAlive             : 60s</p>
<p> EBGP route-update-interval: 30s </p>
<p> IBGP route-update-interval: 15s </p>
<p> Default local-preference  : 100</p>
<p> Default MED               : 0</p>
<p> IPv4-family unicast       : enable</p>
<p> EBGP-interface-sensitive  : enable</p>
<p> IBGP-interface-sensitive  : disable</p>
<p> Reflect between-clients   : enable</p>
<p> Check-first-as            : enable</p>
<p> Synchronization           : disable</p>
<p> Private-4-byte-as         : disable</p>
<p> Nexthop-resolved rules    :</p>
<p>​     IPv4-family           : unicast(ip)</p>
<p>​                             label-route(ip)</p>
<p>​                             multicast(ip)</p>
<p>​                             vpn-instance(tunnel)</p>
<p>​                             vpnv4(ip)</p>
<p>​     IPv6-family           : unicast(ip)</p>
<p>​                             vpn-instance(tunnel)</p>
<p>​                             vpnv6(ip)</p>
<p>​                             6PE(tunnel)</p>
<p> BGP L2VPN-family EVPN     :</p>
<p>​     BUM Flow Forward Mode : Ingress Replication</p>
<p>​     Tunnel Type           : VXLAN</p>
<h2 id="配置BGP的基本功能"><a href="#配置BGP的基本功能" class="headerlink" title="配置BGP的基本功能"></a>配置BGP的基本功能</h2><h3 id="（可选）配置BGP-4字节AS号的显示格式"><a href="#（可选）配置BGP-4字节AS号的显示格式" class="headerlink" title="（可选）配置BGP 4字节AS号的显示格式"></a>（可选）配置BGP 4字节AS号的显示格式</h3><p>缺省情况下，BGP的4字节AS号的显示格式为点分形式（即x.y格式）。如果用户习惯于使用整数形式的4字节AS号，那么可以执行该配置任务将4字节AS号的显示格式从点分形式切换到整数形式。</p>
<p>整数形式的4字节AS号和点分形式的4字节AS号的换算关系是：整数形式的4字节AS号=x<em>65536+y，例如点分形式的4字节AS号2.3，对应的整数形式的4字节AS号为：2</em>65536+3=131075。</p>
<p><strong>as-notation plain</strong>命令用来配置BGP 4字节AS号的显示格式为整数形式。</p>
<p><strong>undo as-notation plain</strong>命令用来配置BGP 4字节AS号的显示格式为点分形式。</p>
<p>缺省情况下，BGP 4字节AS号的显示格式为点分形式，即x.y格式。</p>
<h3 id="启动BGP进程"><a href="#启动BGP进程" class="headerlink" title="启动BGP进程"></a>启动BGP进程</h3><p><strong>bgp</strong>命令用来启动BGP，进入BGP视图。</p>
<p><strong>undo bgp</strong>命令用来关闭BGP。</p>
<p>缺省情况下，BGP是关闭的。</p>
<h3 id="配置BGP对等体"><a href="#配置BGP对等体" class="headerlink" title="配置BGP对等体"></a>配置BGP对等体</h3><p><a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_as-number.html" target="_blank" rel="noopener"><strong>peer</strong></a> { <em>ipv4-address</em> | <em>ipv6-address</em> } <strong>as-number</strong> <em>as-number</em></p>
<h3 id="配置BGP对等体组"><a href="#配置BGP对等体组" class="headerlink" title="配置BGP对等体组"></a>配置BGP对等体组</h3><p>在大型BGP网路中，对等体的数目众多，配置和维护极为不便。对于存在相同配置的BGP对等体，可以将它们加入一个BGP对等体组进行批量配置，简化管理的难度，并提高路由发布效率。</p>
<p>当需要将EBGP对等体加入同一对等体组时，需先配置BGP对等体，再加入组中。</p>
<p><a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/group.html" target="_blank" rel="noopener"><strong>group</strong></a> <em>group-name</em> [ <strong>external</strong> | <strong>internal</strong> ]，创建对等体组</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_group.html" target="_blank" rel="noopener"><strong>peer</strong></a> { <em>ipv4-address</em> | <em>ipv6-address</em> } <strong>group</strong> <em>group-name</em>，向对等体组中加入对等体。</p>
<h3 id="配置BGP引入路由"><a href="#配置BGP引入路由" class="headerlink" title="配置BGP引入路由"></a>配置BGP引入路由</h3><p>BGP协议本身不发现路由，因此需要将其他路由（如IGP路由等）引入到BGP路由表中，从而将这些路由在AS之内和AS之间传播。BGP协议支持通过以下两种方式引入路由：</p>
<p>Import方式：按协议类型，将RIP路由、OSPF路由、ISIS路由等协议的路由引入到BGP路由表中。为了保证引入的IGP路由的有效性，Import方式还可以引入静态路由和直连路由。</p>
<p>Network方式：逐条将IP路由表中已经存在的路由引入到BGP路由表中，比Import方式更精确。</p>
<p>Bgp 100</p>
<p>​       Ipv4-family unicast</p>
<p>​     行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/import-route_bgp.html" target="_blank" rel="noopener"><strong>import-route</strong></a> <em>protocol</em> [ <em>process-id</em> ] [ <strong>med</strong> <em>med</em> | <strong>route-policy</strong> <em>route-policy-name</em> ] *，配置BGP引入其他协议的路由。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/network_bgp.html" target="_blank" rel="noopener"><strong>network</strong></a> <em>ipv4-address</em> [ <em>mask</em> | <em>mask-length</em> ] [ <strong>route-policy</strong> <em>route-policy-name</em> ]，或<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/network_bgp.html" target="_blank" rel="noopener"><strong>network</strong></a> <em>ipv6-address prefix-length</em> [ <strong>route-policy</strong> <em>route-policy-name</em> ]，配置BGP逐条引入IPv4路由表或IPv6路由表中的路由。</p>
<h2 id="配置BGP安全性"><a href="#配置BGP安全性" class="headerlink" title="配置BGP安全性"></a>配置BGP安全性</h2><h3 id="配置MD5认证"><a href="#配置MD5认证" class="headerlink" title="配置MD5认证"></a>配置MD5认证</h3><p>BGP使用TCP作为传输协议，只要TCP数据包的源地址、目的地址、源端口、目的端口和TCP序号是正确的，BGP就会认为这个数据包有效，但数据包的大部分参数对于攻击者来说是不难获得的。为了保证BGP协议免受攻击，可以在BGP邻居之间使用MD5认证或者Keychain认证来降低被攻击的可能性。其中MD5算法配置简单，配置后生成单一密码，需要人为干预才可以更换密码。</p>
<p>BGP使用TCP作为传输层协议，为提高BGP的安全性，可以在建立TCP连接时进行MD5认证。BGP的MD5认证并不能对BGP报文认证，它只是为TCP连接设置MD5认证密码，由TCP完成认证。如果认证失败，则不建立TCP连接。</p>
<p><strong>peer 10.1.1.2 password cipher Huawei</strong></p>
<p>如果对等体上使用<strong>peer password</strong>命令配置了认证，对等体组也使用<strong>peer password</strong>命令配置了认证，现在要将对等体加入对等体组，并且要求对等体继承组的认证方式，建议先使用<strong>undo peer password</strong>命令删除对等体的配置，然后使用<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_group.html" target="_blank" rel="noopener"><strong>peer group</strong></a>命令讲对等体加入对等体组。</p>
<h2 id="配置BGP路由选路和负载负担"><a href="#配置BGP路由选路和负载负担" class="headerlink" title="配置BGP路由选路和负载负担"></a>配置BGP路由选路和负载负担</h2><h3 id="配置BGP协议优先级"><a href="#配置BGP协议优先级" class="headerlink" title="配置BGP协议优先级"></a>配置BGP协议优先级</h3><p>由于交换机上可能同时运行多个动态路由协议，就存在各个路由协议之间路由信息共享和选择的问题。系统为每一种路由协议设置一个缺省优先级。在不同协议发现同一条路由时，优先级高的路由将被优选。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/preference_bgp.html" target="_blank" rel="noopener"><strong>preference</strong></a> { <em>external</em> <em>internal</em> <em>local</em> | <strong>route-policy</strong> <em>route-policy-name</em> }，设定BGP的协议优先级。</p>
<p>缺省情况下，BGP的协议优先级为255。</p>
<p>配置优先级的值越小，优先级越高。</p>
<p>BGP有三种路由：</p>
<p>从外部对等体学到的路由（EBGP）</p>
<p>从内部对等体学到的路由（IBGP）</p>
<p>本地产生的路由（Local Originated），是指通过聚合命令（<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/summary_automatic.html" target="_blank" rel="noopener"><strong>summary automatic</strong></a>自动聚合和<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/aggregate_bgp.html" target="_blank" rel="noopener"><strong>aggregate</strong></a>手动聚合）所聚合的路由。</p>
<p>可以为这三种路由设定不同的优先级。</p>
<p>另外，还可以通过应用路由策略，为符合匹配条件的特定路由配置优先级。对于不符合匹配条件的路由，则使用缺省优先级。</p>
<h3 id="配置Next-Hop属性"><a href="#配置Next-Hop属性" class="headerlink" title="配置Next_Hop属性"></a>配置Next_Hop属性</h3><p>当ASBR将从EBGP邻居学到的路由转发给IBGP邻居时，默认不修改下一跳。IBGP邻居收到该路由后，会发现下一跳不可达，于是将该路由设为非活跃路由，不通过该路由指导流量转发。当希望IBGP邻居通过该路由指导流量转发时，可以在ASBR上配置向IBGP对等体（组）转发路由时，将自身地址作为下一跳。这时，IBGP邻居收到ASBR从EBGP邻居学习来的路由后，发现下一跳可达，于是将路由设为活跃路由。</p>
<p>当BGP路由发生变化时，BGP需要对非直连的下一跳重新进行迭代。如果不对迭代后的路由进行任何限制，则BGP可能会将下一跳迭代到一个错误的转发路径上，从而造成流量丢失。此时，可配置BGP按路由策略迭代下一跳，避免流量丢失。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_next-hop-local.html" target="_blank" rel="noopener"><strong>peer</strong></a> { <em>ipv4-address</em> | <em>group-name</em> | <em>ipv6-address</em> } <strong>next-hop-local</strong>，配置BGP设备向IBGP对等体（组）发布路由时，把下一跳地址设为自身的IP地址。</p>
<p>缺省情况下：</p>
<p> BGP向EBGP对等体通告路由时，将下一跳属性设为自身与对等体相连的接口地址。</p>
<p> BGP从EBGP向IBGP对等体通告非标签路由时，不改变下一跳属性，通告标签路由时，将下一跳属性改为自身与对等体相连的接口地址。</p>
<p> BGP从IBGP向IBGP对等体通告路由时，不改变下一跳属性。</p>
<p> BGP将本地始发路由发布给IBGP对等体时，将下一跳属性设为自身与对等体相连的接口地址。</p>
<p> 执行<strong>peer next-hop-local</strong>命令后，设备向IBGP对等体/对等体组通告路由时，把下一跳属性设为自身的IP地址。</p>
<p> <strong>peer next-hop-local</strong>命令仅应用于IBGP对等体间。</p>
<p><strong>nexthop third-party</strong>命令用来配置在特定场景下，BGP Speaker向对等体发布路由时，不修改下一跳地址。这些特定场景包括：</p>
<p>从直连邻居学来的路由，发送给直连EBGP邻居，原始下一跳与本地和对端建立BGP邻居关系的接口地址在同一网段，且直连接口均为广播口；</p>
<p>本地引入的路由，发送给直连IBGP或EBGP邻居，引入路由迭代下一跳与本地和对端建立BGP邻居关系的接口地址在同一网段，且直连接口均为广播口。</p>
<p><strong>undo nexthop third-party</strong>命令用来恢复缺省设置。</p>
<p>缺省情况下：</p>
<p>从直连邻居学来的路由，发送给直连EBGP邻居时，会把该路由信息的下一跳属性设置为本地与对端建立BGP邻居关系的接口地址；</p>
<p>本地引入的路由，发送给直连IBGP或EBGP邻居时，会把该路由信息的下一跳属性设置为本地与对端建立BGP邻居关系的接口地址。</p>
<h3 id="配置BGP路由信息的首选值"><a href="#配置BGP路由信息的首选值" class="headerlink" title="配置BGP路由信息的首选值"></a>配置BGP路由信息的首选值</h3><p>协议首选值（PrefVal）是<strong>华为设备</strong>的特有属性，该属性仅在本地有效。当BGP路由表中存在到相同目的地址的路由时，将优先选择协议首选值高的路由</p>
<p><strong>peer</strong> { <em>group-name</em> | <em>ipv4-address</em> | <em>ipv6-address</em> } <strong>preferred-value</strong> <em>value</em> 整数形式，取值范围是0～65535。</p>
<p>为从指定对等体学来的所有路由配置首选值。</p>
<p>缺省情况下，从对等体学来的路由的初始首选值为0。</p>
<h3 id="配置本机缺省Local-Pref属性"><a href="#配置本机缺省Local-Pref属性" class="headerlink" title="配置本机缺省Local_Pref属性"></a>配置本机缺省Local_Pref属性</h3><p>Local_Pref属性用于判断流量离开AS时的最佳路由。当BGP的设备通过不同的IBGP对等体得到到AS外的目的地址相同但下一跳不同的多条路由时，将优先选择Local_Pref属性值较高的路由。</p>
<p><strong>default local-preference</strong>命令用来配置BGP的缺省本地优先级。缺省情况下，BGP本地优先级的值为100。</p>
<h3 id="配置AS-Path属性"><a href="#配置AS-Path属性" class="headerlink" title="配置AS_Path属性"></a>配置AS_Path属性</h3><p>AS_Path属性按矢量顺序记录了某条路由从本地到目的地址所要经过的所有AS编号。配置不同的AS_Path属性功能，可以实现灵活的路由选路。</p>
<p>缺省情况下，AS_Path属性内AS_Path数量作为BGP选路条件。当不需要AS_Path属性作为选路条件时，可以配置不将AS_Path属性作为选路条件。</p>
<p>缺省情况下，BGP通过AS号检测路由环路。但在Hub and Spoke组网方式下，为保证路由能够正确传递，从Hub-CE发布私网路由到Spoke-CE途中经过的相关BGP对等体需要配置允许AS_Path中AS号重复1次的路由通过。</p>
<p>公有AS号可以直接在Internet上使用，私有AS号直接发布到Internet上可能造成环路现象。为了解决上述情况，可以在把路由发布到Internet前，配置发送EBGP更新报文时，AS_Path属性中仅携带公有AS编号。</p>
<p>在重构AS_Path或聚合生成新路由时，可以对AS_Path中的AS号最大个数予以限制。配置AS_Path属性中AS号的最大个数后，接收路由时会检查AS_Path属性中的AS号是否超限，如果超限则丢弃路由。</p>
<p>缺省情况下，一个设备只支持一个BGP进程，即只支持一个AS号。但是在某些特殊情况下，例如网络迁移更换AS号的时候来为了保证网络切换的顺利进行，可以为指定对等体设置一个伪AS号。</p>
<p>缺省情况下，设备会检查所有EBGP对等体发来的更新消息中AS_Path列表的第一个AS号，确认第一个AS号必须是该EBGP对等体所在的AS。否则，该更新信息被拒绝，EBGP连接中断。如果不需要设备检查所有EBGP对等体发来的更新消息中AS_Path列表的第一个AS号，可以去使能此功能。</p>
<h4 id="apply-as-path"><a href="#apply-as-path" class="headerlink" title="apply as-path"></a>apply as-path</h4><p>命令用来在路由策略中配置改变BGP路由的AS_Path属性的动作。</p>
<p><strong>apply as-path</strong> { { <em>as-number-plain</em> | <em>as-number-dot</em> } &amp;<1-63> { <strong>additive</strong> | <strong>overwrite</strong> | <strong>delete</strong> } | <strong>none</strong> <strong>overwrite</strong> }</1-63></p>
<p>当BGP路由需要改变AS_Path属性来参与路由选择的竞争时，可以应用包含<strong>apply as-path</strong>命令的路由策略，改变匹配成功的BGP路由的AS_Path属性。</p>
<p>AS_Path属性是BGP的私有属性，记录了某条路由从本地到目的地址所要经过的所有AS编号，通过应用AS_Path属性可以控制路由选择及防止路由环路。当到达同一目的地存在多条路由时，BGP会比较路由的AS_Path属性，AS_Path列表较短的路由将被认为是最佳路由。</p>
<p>配置此命令后，符合匹配条件的BGP路由的AS_Path列表将会改变。假设原来AS_Path为（30，40，50），在符合匹配条件的情况下：</p>
<p>如果配置了<strong>apply as-path</strong> <strong>60</strong> <strong>70</strong> <strong>80</strong> <strong>additive</strong>命令，则AS_Path列表更改为（60，70，80，30，40，50）。这种配置一般用于调整使路由不被优选。</p>
<p>如果配置了<strong>apply as-path</strong> <strong>60</strong> <strong>70</strong> <strong>80 overwrite</strong>命令，则AS_Path列表更改为（60，70，80）。更改AS_Path的应用比较灵活，主要有以下几种情况：</p>
<p> 隐藏路由的真实路径信息。比如，AS_Path列表更改为（60，70，80）之后，路由就丢失了原来携带的AS_Path路径信息（30，40，50）。</p>
<p> 用于形成负载分担。比如，设备收到两条路由，目的地址都是10.1.0.0/16这个网络，其中一条路由的AS_Path为（60，70，80），另一条路由的AS_Path为（30，40，50），如果把AS_Path（30，40，50）更改为（60，70，80），那么这两条路由就有可能形成负载分担。</p>
<p> 如果配置了<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/as-path-limit.html" target="_blank" rel="noopener"><strong>as-path-limit</strong></a>命令，接收路由时会检查AS_Path属性中的AS号是否超限，如果超限则丢弃路由。这样对于AS_Path较长的路由，在接收之前，可以把AS_Path替换成较短的AS_Path。例如原来的AS_Path为（60，70，80，65001，65002，65003），可以配置<strong>apply as-path</strong> <strong>60</strong> <strong>70</strong> <strong>80 overwrite</strong>命令，把AS_Path列表更改为（60，70，80），缩短AS_Path的长度，防止路由由于AS号超限而被丢弃。</p>
<p> 缩短AS_Path长度，使路由被优选，把流量引导向本自治系统。</p>
<p>如果配置了<strong>apply as-path</strong> <strong>none</strong> <strong>overwrite</strong>命令，则AS_Path列表更改为空。BGP在选路时，如果AS_Path列表为空，AS_Path长度按照0来处理。通过清空AS_Path，不但可以隐藏真实的路径信息，还可以缩短AS_Path长度，使路由被优选，把流量引导向本自治系统。</p>
<h4 id="bestroute-as-path-ignore"><a href="#bestroute-as-path-ignore" class="headerlink" title="bestroute as-path-ignore"></a>bestroute as-path-ignore</h4><p><strong>bestroute as-path-ignore</strong>命令用来配置BGP在选择最优路由时忽略AS路径属性。</p>
<p>缺省情况下，BGP将AS路径属性作为选择最优路由的一个条件。</p>
<p>配置该命令后，BGP将不比较AS路径的长度。缺省情况下，长度较小者优先。</p>
<p>执行命令<strong>bestroute as-path-ignore</strong>之后，AS_Path属性不作为BGP选路条件。</p>
<p><a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/as-path-limit.html" target="_blank" rel="noopener"><strong>as-path-limit</strong></a>配置AS_Path属性中AS号的最大个数。</p>
<p>缺省情况下，AS_Path属性中AS号的最大个数是255。</p>
<h3 id="配置MED属性"><a href="#配置MED属性" class="headerlink" title="配置MED属性"></a>配置MED属性</h3><p>MED属性相当于IGP使用的度量值（Metrics），它用于判断流量进入AS时的最佳路由。当一个运行BGP的设备通过不同的EBGP对等体得到目的地址相同但下一跳不同的多条路由时，在其它条件相同的情况下，将优先选择MED值较小者作为最佳路由。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/default_med.html" target="_blank" rel="noopener"><strong>default med</strong></a> <em>med</em>，配置缺省MED值。</p>
<p>缺省情况下，MED的值为0。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/bestroute_med-none-as-maximum.html" target="_blank" rel="noopener"><strong>bestroute med-none-as-maximum</strong></a>，设置当路由没有MED值时将其作为最大值处理。</p>
<p>缺省情况下，当路由属性中没有MED值时，BGP在选路时将使用缺省MED值。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/compare-different-as-med.html" target="_blank" rel="noopener"><strong>compare-different-as-med</strong></a>，允许BGP比较属于任意AS的EBGP对等体的路由的MED值。</p>
<p>缺省情况下，BGP只比较属于同一AS的EBGP对等体的路由的MED属性值</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/bestroute_med-plus-igp.html" target="_blank" rel="noopener"><strong>bestroute med-plus-igp</strong></a> [ <strong>igp-multiplier</strong> <em>igp-multiplier</em> | <strong>med-multiplier</strong> <em>med-multiplier</em> ] *，配置BGP在需要比较MED值来选择最优路由时，将MED值与IGP Metric分别乘对应系数相加作为结果进行比较。</p>
<p>缺省情况下，MED值与IGP Metric作为单独的BGP选路条件参与选路。</p>
<h3 id="配置BGP团体属性"><a href="#配置BGP团体属性" class="headerlink" title="配置BGP团体属性"></a>配置BGP团体属性</h3><p>团体属性是BGP的私有属性，在BGP对等体之间传播，且不受AS的限制。利用团体属性可以使多个AS中的一组BGP设备共享相同的策略，从而简化路由策略的应用和降低维护管理的难度。BGP设备可以在发布路由时，新增或者改变路由的团体属性。</p>
<p><strong>apply community</strong>命令用来在路由策略中配置改变BGP路由团体属性的动作。</p>
<p><strong>apply community</strong> { <em>community-number</em> | <em>aa:nn</em> | <strong>internet</strong> | <strong>no-advertise</strong> | <strong>no-export</strong> | <strong>no-export-subconfed</strong> } &amp;<1-32> [ <strong>additive</strong> ]</1-32></p>
<table>
<thead>
<tr>
<th>表示删除路由的所有团体属性。</th>
<th>-</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><em>community-number</em> \</td>
<td><em>aa</em>:<em>nn</em></td>
<td>指定团体属性中的团体号。一条命令中最多可以配置32个团体号。     如果不配置<strong>internet</strong>、<strong>no-export-subconfed</strong>、<strong>no-advertise</strong>和<strong>no-export</strong>，则<em>community-number</em>和<em>aa:nn</em>一共可以指定32个。     如果配置<strong>internet</strong>、<strong>no-export-subconfed</strong>、<strong>no-advertise</strong>和<strong>no-export</strong>中的一个，则<em>community-number</em>和<em>aa:nn</em>一共可以指定31个。     如果配置<strong>internet</strong>、<strong>no-export-subconfed</strong>、<strong>no-advertise</strong>和<strong>no-export</strong>中的两个，则<em>community-number</em>和<em>aa:nn</em>一共可以指定30个。     如果配置<strong>internet</strong>、<strong>no-export-subconfed</strong>、<strong>no-advertise</strong>和<strong>no-export</strong>中的三个，则<em>community-number</em>和<em>aa:nn</em>一共可以指定29个。     如果配置<strong>internet</strong>、<strong>no-export-subconfed</strong>、<strong>no-advertise</strong>和<strong>no-export</strong>，则<em>community-number</em>和<em>aa:nn</em>一共可以指定28个。</td>
<td>整数形式，<em>community-number</em>的取值范围是0～4294967295，<em>aa</em>和<em>nn</em>的取值范围都是0～65535。</td>
</tr>
<tr>
<td><strong>internet</strong></td>
<td>表示可以向任何对等体发送匹配的路由。缺省情况下，所有的路由都属于Internet团体。</td>
<td>-</td>
</tr>
<tr>
<td><strong>no-advertise</strong></td>
<td>表示不向任何对等体发送匹配的路由。即收到具有此属性的路由后，不能发布给任何其他的BGP对等体。</td>
<td>-</td>
</tr>
<tr>
<td><strong>no-export</strong></td>
<td>表示不向AS外发送匹配的路由，但发布给其它子自治系统。即收到具有此属性的路由后，不能发布到本地AS之外。</td>
<td>-</td>
</tr>
<tr>
<td><strong>no-export-subconfed</strong></td>
<td>表示不向AS外发送匹配的路由，也不发布给其它子自治系统。即收到具有此属性的路由后，不能发布给任何其他的子自治系统。</td>
<td>-</td>
</tr>
<tr>
<td><strong>additive</strong></td>
<td>表示追加路由的团体属性。</td>
</tr>
</tbody>
</table>
<p>路由策略中配置<strong>apply community</strong>命令，则通过该策略的BGP路由，其团体属性将按照策略中的配置进行相应变更。</p>
<p>假设原BGP路由的团体属性为30，在符合过滤条件的情况下，替换或追加AS的规则举例如下：</p>
<p>如果配置了<strong>apply community 100</strong>命令，则团体属性更改为100。</p>
<p>如果配置了<strong>apply community 100 150</strong>命令，则团体属性更改为100，150。</p>
<p>如果配置了<strong>apply community 100 150 additive</strong>命令，则团体属性更改为30，100，150。</p>
<p>如果配置了<strong>apply community none</strong>命令，则BGP路由的团体属性被删除。</p>
<h3 id="配置BGP负载分担"><a href="#配置BGP负载分担" class="headerlink" title="配置BGP负载分担"></a>配置BGP负载分担</h3><p>在大型网路中，到达同一目的地通常会存在多条有效路由，但是BGP只将最优路由发布给对等体，这一特点往往会造成很多流量负载不均衡的情况。通过配置BGP负载分担，可以流量负载均衡，减少网络拥塞。</p>
<p>一般情况下，只有“BGP选择路由的策略”所描述的前8个属性完全相同，BGP路由之间才能相互等价，实现BGP的负载分担。但路由负载分担的规则也可以通过配置来改变，如忽略路由AS-Path属性的比较，但这些配置需要确保不会引起路由环路。</p>
<p>公私网互引路由和本地交叉路由不能进行负载分担。</p>
<p>如果实现了BGP负载分担，则不论是否配置了<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_next-hop-local.html" target="_blank" rel="noopener"><strong>peer next-hop-local</strong></a>命令，本地设备向IBGP对等体组发布路由时都先将下一跳地址改变为自身地址。</p>
<p><strong>maximum load-balancing</strong>命令用来设置形成负载分担的等价路由的最大条数。</p>
<p> 整数形式，取值范围是1～64</p>
<p><strong>应用场景</strong></p>
<p>配置该命令可以使多条BGP等价路由形成负载分担，以达到负载均衡的目的，实现网络资源的合理利用。</p>
<p>配置该命令后，满足如下所有条件的多条BGP路由会成为等价路由，形成负载分担：</p>
<ul>
<li>原始下一跳不相同；</li>
<li>首选值（PrefVal）相同；</li>
<li>本地优先级（Local_Pref）相同；</li>
<li>都是聚合路由，或者都不是聚合路由；</li>
<li>Origin类型（IGP、EGP、Incomplete）相同；</li>
<li>MED值相同；</li>
<li>都是EBGP路由或都是IBGP路由；</li>
<li>AS内部IGP的Metric相同；</li>
<li>AS_Path属性完全相同。</li>
</ul>
<p>配置<strong>maximum load-balancing</strong> <strong>ebgp</strong> <em>number</em>命令后，仅EBGP路由形成负载分担；配置<strong>maximum load-balancing</strong> <strong>ibgp</strong> <em>number</em>命令后，仅IBGP路由形成负载分担。不配置[ <strong>ebgp</strong> | <strong>ibgp</strong> ]参数时，EBGP路由和IBGP路由都可以形成负载分担，且形成负载分担的路由条数相同。</p>
<p>缺省情况下，执行<strong>maximum load-balancing</strong> <em>number</em>命令后，BGP在向对等体发布路由时，无论该路由是否形成负载分担，都将下一跳修改为自己。配置<strong>ecmp-nexthop-changed</strong>参数，可以使BGP只在发布形成负载分担的路由时才修改下一跳为自己；而在发布没有形成负载分担的路由时，不对下一跳作特殊处理，即原始下一跳与没有配置负载分担时发布的下一跳保持一致。</p>
<h2 id="控制BGP路由的发布和接收"><a href="#控制BGP路由的发布和接收" class="headerlink" title="控制BGP路由的发布和接收"></a>控制BGP路由的发布和接收</h2><h3 id="控制BGP路由信息的发布"><a href="#控制BGP路由信息的发布" class="headerlink" title="控制BGP路由信息的发布"></a>控制BGP路由信息的发布</h3><p>BGP路由表路由数量通常比较大，传递大量的路由对设备来说是一个很大的负担，为了减小路由发送规模，需要对发布的路由进行控制，只发送自己想要发布的路由或者只发布对等体需要的路由。另外，到达同一个目的地址，可能存在多条路由，这些路由分别需要穿越不同的AS，为了把业务流量引导向某些特定的AS，也需要对发布的路由进行筛选。</p>
<p>配置BGP对全局发布的路由信息进行过滤。</p>
<p>基于访问控制列表ACL：<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_export_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> { <em>acl-number</em> | <strong>acl-name</strong> <em>acl-name</em> } <strong>export</strong> [ <em>protocol</em> [ <em>process-id</em> ] ]或者<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_export_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> { <em>acl6-number</em> | <strong>acl6-name</strong> <em>acl6-name</em> } <strong>export</strong> [ <em>protocol</em> [ <em>process-id</em> ] ]</p>
<p>基于地址前缀列表：<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_export_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> <strong>ip-prefix</strong> <em>ip-prefix-name</em> <strong>export</strong> [ <em>protocol</em> [ <em>process-id</em> ] ]或者<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_export_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> <strong>ipv6-prefix</strong> <em>ipv6-prefix-name</em> <strong>export</strong> [ <em>protocol</em> [ <em>process-id</em> ] ]</p>
<h3 id="控制BGP路由信息的接收"><a href="#控制BGP路由信息的接收" class="headerlink" title="控制BGP路由信息的接收"></a>控制BGP路由信息的接收</h3><p>当设备遭到恶意攻击或者网络中出现错误配置时，会导致BGP从邻居接收到大量的路由，从而消耗大量设备的资源。因此管理员必须根据网络规划和设备容量，对运行时所使用的资源进行限制。BGP提供了基于对等体的路由控制，限定邻居发来的路由数量，这样可以避免上述问题。</p>
<p>置BGP对从全局接收的路由信息进行过滤。</p>
<p>基于访问控制列表ACL：<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_import_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> { <em>acl-number</em> | <strong>acl-name</strong> <em>acl-name</em> } <strong>import</strong>或者<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_import_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> { <em>acl6-number</em> | <strong>acl6-name</strong> <em>acl6-name</em> } <strong>import</strong></p>
<p>基于地址前缀列表：<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_import_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> <strong>ip-prefix</strong> <em>ip-prefix-name</em> <strong>import</strong>或者<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/filter-policy_import_bgp.html" target="_blank" rel="noopener"><strong>filter-policy</strong></a> <strong>ipv6-prefix</strong> <em>ipv6-prefix-name</em> <strong>import</strong></p>
<h3 id="配置BGP软复位"><a href="#配置BGP软复位" class="headerlink" title="配置BGP软复位"></a>配置BGP软复位</h3><p>BGP的入口策略改变后，为了使新的策略立即生效，可以复位BGP连接，但这样会造成短暂的BGP连接中断。BGP支持手工对BGP连接进行软复位，可在不中断BGP连接情况下完成路由表的刷新。对于不支持软复位的BGP对等体，可以同时配置保留该对等体的所有原始路由功能，在不复位BGP连接的情况下完成路由表的刷新。</p>
<p>对于支持Route-refresh能力的BGP对等体，同时配置手工对BGP连接进行软复位，可在不中断BGP连接情况下完成路由表的刷新。</p>
<p><strong>peer</strong> { <em>group-name</em> | <em>ipv4-address</em> } <strong>capability-advertise</strong> { <strong>4-byte-as</strong> | <strong>route-refresh</strong> | <strong>conventional</strong> }</p>
<p><strong>peer</strong> <em>ipv6-address</em> <strong>capability-advertise</strong> { <strong>4-byte-as</strong> | <strong>route-refresh</strong> }</p>
<p><strong>peer capability-advertise</strong>命令用来使能BGP的发布可选能力。缺省情况下，BGP路由刷新功能和4字节AS号功能处于使能状态。</p>
<p><strong>refresh bgp</strong>命令用来手工对BGP连接进行软复位。</p>
<p>对于邻居是支持Route-refresh的设备，可以执行<strong>refresh bgp</strong>命令手工对BGP连接进行软复位，BGP软复位可以在不中断BGP连接的情况下重新刷新BGP路由表，并应用新的策略。</p>
<p><strong>前置条件</strong></p>
<p>配置BGP软复位要求BGP对等体支持Route-refresh能力。</p>
<p><strong>peer keep-all-routes</strong>命令用来保存自BGP连接建立起来之后的所有来自指定对等体（组）的BGP路由更新信息。</p>
<p>缺省情况下，只保存来自对等体的通过已配置入口策略的BGP路由更新信息。</p>
<p><strong>应用场景</strong></p>
<p>BGP的入口策略改变后，为了使新的策略立即生效，可以复位BGP连接，但这样会造成短暂的BGP连接中断。对于不支持Route-Refresh能力的BGP对等体，可以配置<strong>peer keep-all-routes</strong>命令，保留该对等体的所有原始路由，这样不需要复位BGP连接即可完成路由表的刷新。</p>
<p><strong>注意事项</strong></p>
<p>如果交换机不支持Route-refresh能力，则需要在本地和对等体上均配置该命令。第一次配置<strong>peer keep-all-routes</strong>命令后会导致与对等体会话重新连接。</p>
<p>如果交换机支持Route-refresh能力，配置该命令后，不会导致与对等体的会话重新连接，但交换机通过执行<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/refresh_bgp.html" target="_blank" rel="noopener"><strong>refresh bgp</strong></a>命令刷新路由表功能将不会生效。</p>
<p>执行<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/keep-all-routes.html" target="_blank" rel="noopener"><strong>keep-all-routes</strong></a>命令后，再执行<strong>undo peer keep-all-routes</strong>命令不会生效。此时，需要先执行<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/keep-all-routes.html" target="_blank" rel="noopener"><strong>undo keep-all-routes</strong></a>命令，再执行<strong>peer keep-all-routes</strong>命令才可以配置此功能。</p>
<h2 id="配置调整BGP网络的收敛速度"><a href="#配置调整BGP网络的收敛速度" class="headerlink" title="配置调整BGP网络的收敛速度"></a>配置调整BGP网络的收敛速度</h2><h3 id="配置BGP连接重传定时器"><a href="#配置BGP连接重传定时器" class="headerlink" title="配置BGP连接重传定时器"></a>配置BGP连接重传定时器</h3><p>BGP发起TCP连接后，如果成功建立起TCP连接，则关闭连接重传定时器。如果TCP连接建立不成功，则会在连接重传定时器超时后重新尝试建立连接。</p>
<p>设置较小的连接重传定时器，可以减少等待下次连接建立的时间，加快连接失败后重新建立的速度。</p>
<p>设置较大的连接重传定时器，可以减小由于邻居反复震荡引起的路由振荡。</p>
<p>BGP支持在全局或者单个对等体（组）配置连接重传定时器。定时器生效的优先级是单个对等体高于对等体组，对等体组高于全局。</p>
<p><strong>timer connect-retry</strong>命令用来配置全局连接重传时间间隔。</p>
<p>缺省情况下，连接重传时间间隔是32秒。</p>
<h3 id="配置BGP存活时间和保持时间定时器"><a href="#配置BGP存活时间和保持时间定时器" class="headerlink" title="配置BGP存活时间和保持时间定时器"></a>配置BGP存活时间和保持时间定时器</h3><p>BGP的Keepalive消息用于维持BGP连接关系。</p>
<p>减小存活时间和保持时间，BGP可以更快速的检测到链路的故障，有利于BGP网络快速收敛。但是过短的保持时间会导致网络中的Keepalive消息会增多，使得设备的负担加重，并且会占用一定的网络带宽。</p>
<p>增大存活时间和保持时间，可以减轻设备负担和减少网络带宽的占用。但是过长的保持时间会导致网络中的Keepalive消息减少，使得BGP不能及时检测到链路状态的变化，不利于BGP网络快速收敛，还可能会造成流量损失。</p>
<p>BGP支持在全局或者单个对等体（组）配置存活时间和保持时间定时器。定时器生效的优先级单个对等体高于对等体组，对等体组高于全局。</p>
<p><strong>timer</strong>命令用来配置BGP的存活时间与保持时间间隔。</p>
<p>缺省情况下，存活时间为60秒，保持时间为180秒。</p>
<h3 id="配置更新报文定时器"><a href="#配置更新报文定时器" class="headerlink" title="配置更新报文定时器"></a>配置更新报文定时器</h3><p>BGP协议不会定期更新路由表，当BGP路由发生变化时，会通过Update消息增量地更新路由表。</p>
<p>减小更新报文时间，BGP可以更快速的检测到路由变化，有利于BGP网络快速收敛。但是过短的更新报文时间会导致网络中的Update消息会增多，使得设备的负担加重，并且会占用一定的网络带宽。</p>
<p>增大更新报文时间，可以减轻设备负担和减少网络带宽的占用，避免不必要的路由震荡。但是过长的保持时间会导致网络中的Update消息减少，使得BGP不能及时检测到路由的变化，不利于BGP网络快速收敛，还可能会造成流量损失。</p>
<p><strong>peer route-update-interval</strong>命令用来配置向对等体（组）发送相同路由前缀更新报文（Update报文）的时间间隔。</p>
<p>缺省情况下，IBGP对等体的路由更新时间间隔为15秒，EBGP对等体的路由更新时间间隔为30秒。</p>
<h3 id="配置EBGP连接快速复位"><a href="#配置EBGP连接快速复位" class="headerlink" title="配置EBGP连接快速复位"></a>配置EBGP连接快速复位</h3><p>EBGP连接快速复位功能缺省情况下是使能的，目的是为了使BGP协议不必等待保持时间定时器超时，而立即快速响应接口故障，删除接口上的EBGP直连会话，便于BGP快速收敛。</p>
<p>但是如果EBGP连接所使用的接口状态反复变化，EBGP会话就会反复重建与删除，造成网络震荡。这时，可以去使能EBGP连接快速复位功能。BGP协议会等待保持时间定时器超时，才会删除接口上的EBGP直连会话，这样就在一定程度上抑制了BGP网络震荡，同时在一定程度上节约了网络带宽。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/ebgp-interface-sensitive.html" target="_blank" rel="noopener"><strong>undo ebgp-interface-sensitive</strong></a>，去使能EBGP连接快速复位。</p>
<p>EBGP连接快速复位功能缺省情况下是使能的。</p>
<p>接口故障恢复后，BGP协议依靠自身状态机机制来恢复会话。</p>
<p>该命令适用于EBGP连接所使用的接口状态不断变化的场合。如果接口状态恢复稳定，建议立即执行<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/ebgp-interface-sensitive.html" target="_blank" rel="noopener"><strong>ebgp-interface-sensitive</strong></a>命令恢复缺省配置，使能EBGP连接快速复位功能。</p>
<h3 id="配置BGP路由震荡抑制"><a href="#配置BGP路由震荡抑制" class="headerlink" title="配置BGP路由震荡抑制"></a>配置BGP路由震荡抑制</h3><p>路由振荡（Route flapping）指路由表中的某条路由反复消失和重现。一般情况下，BGP都应用于复杂的网络环境中，路由变化十分频繁。而频繁的路由振荡会消耗大量的带宽资源和CPU资源，严重时会影响到网络的正常工作。通过配置EBGP或者IBGP路由振荡抑制功能可防止持续路由振荡带来的不利影响。</p>
<p>BGP可以按策略区分路由，对不同的路由采用不同的Dampening参数进行抑制。例如，实际网络中，对掩码较长的路由设置较长的抑制时间，而对掩码较短的（例如8位掩码长度）路由，则采用相对较短的抑制时间。</p>
<p><strong>dampening</strong>命令用来使能BGP路由振荡抑制或修改各种BGP路由振荡抑制参数。</p>
<p>缺省情况下，BGP路由振荡抑制未使能。</p>
<p><strong>应用场景</strong></p>
<p>BGP振荡抑制使用惩罚值来衡量一条路由的稳定性，惩罚值越高则说明路由越不稳定。路由每发生一次振荡，即交换机收到该路由的Withdraw报文时，BGP便会给此路由增加一定的惩罚值（1000），收到路由更新时也会给此路由增加一定的惩罚值（500）。</p>
<p>当惩罚值超过抑制阈值时，此路由被抑制，不加入到IP路由表中，交换机也不再向其他BGP对等体发布更新报文。如果该路由被打上d标志，说明交换机最后收到的是Update报文；如果该路由被打上h标志，说明交换机最后收到的是Withdraw报文。惩罚值增加到一定程度之后，便不会再增加，这个值称为惩罚上限值。</p>
<p>同时，被抑制的路由每经过一段时间，惩罚值便会减少一半。如果是d标志的路由，当惩罚值降到再使用阈值时，此路由会被去掉d标记，变为可用并被优选后加入到IP路由表中，同时向其他BGP对等体发布更新报文。如果是h标志的路由，当惩罚值降为0时，此路由会从BGP路由表中删除。</p>
<p>配置BGP路由振荡抑制功能后，使用命令行中的任何参数都可以起到抑制振荡路由的作用，调整参数的目的是按照不同的抑制时间诉求进行调整。若想增加振荡路由的抑制时间，可以通过如下方式实现（反之，则可以减小抑制时间）：</p>
<p>增加<em>ceiling</em>的取值；</p>
<p>增加<em>half-life-reach</em>的取值；</p>
<p>减小<em>reuse</em>的取值。</p>
<p>d标志和h标志可以通过命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/display_bgp_routing-table_label.html" target="_blank" rel="noopener"><strong>display bgp routing-table label</strong></a>查看，分别表示该路由已经被抑制和曾经被抑制。</p>
<p><strong>注意事项</strong></p>
<p><strong>dampening</strong>命令为覆盖式命令。</p>
<p>执行<strong>dampening</strong>命令后，系统抑制不稳定的路由，不将这类路由加入到BGP路由表中，也不将这类路由向其他BGP对等体发布。</p>
<p>配置BGP路由振荡抑制时，需注意如下事项：</p>
<p>所指定的<em>reuse</em>、<em>suppress</em>、<em>ceiling</em>三个阈值是依次增大的，即必须满足：<em>reus</em>e&lt;<em>suppress</em>&lt;<em>ceiling</em>。</p>
<p>根据公式MaxSuppressTime=<em>half-life-reach</em>×60×(ln(<em>ceiling</em>/<em>reuse</em>)/ln(2))，如果MaxSuppressTime小于1就不能抑制。所以要保证MaxSuppressTime大于等于1，即必须满足：<em>ceiling</em>/<em>reuse</em>足够大。</p>
<h2 id="配置BGP可靠性"><a href="#配置BGP可靠性" class="headerlink" title="配置BGP可靠性"></a>配置BGP可靠性</h2><h3 id="配置BFD-For-BGP"><a href="#配置BFD-For-BGP" class="headerlink" title="配置BFD For BGP"></a>配置BFD For BGP</h3><p>BGP协议通过周期性的向对等体发送Keepalive报文来实现邻居检测。但这种机制检测到故障所需时间比较长，超过1秒钟。当数据达到吉比特速率级时，这么长的检测时间将导致大量数据丢失，无法满足电信级网络高可靠性的需求。为了解决上述问题，BGP协议引入了BGP与BFD联动功能。BFD检测是毫秒级，可以在50ms内通报BGP对等体间链路的故障，因此能够提高BGP路由的收敛速度，保障链路快速切换，减少流量损失。</p>
<p>当对等体加入了对等体组，且这个对等体组使能了BFD特性，对等体将会继承该对等体组的BFD特性，创建BFD会话。如果不希望对等体从对等体组继承BFD特性，可以配置<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_bfd_block.html" target="_blank" rel="noopener"><strong>peer bfd block</strong></a>命令，阻止对等体从对等体组中继承BFD功能。</p>
<p>默认情况下，华为设备之间IBGP为多跳会话。建议华为设备和默认IBGP为单跳会话的其他厂商设备对接时，只配置IGP与BFD联动会话或者只配置IBGP与BFD联动会话。</p>
<p><strong>peer bfd enable</strong>命令用来使能对等体（组）的BFD功能。</p>
<p>缺省情况下，对等体（组）的BFD功能未使能。</p>
<h3 id="BGP-Auto-FRR-1"><a href="#BGP-Auto-FRR-1" class="headerlink" title="BGP Auto FRR"></a>BGP Auto FRR</h3><p>在传统的IP网络上，通常从检测到链路故障发生到路由系统完成路由收敛，要经历几秒钟的时间。对于网络上某些对延时、丢包等非常敏感的业务来说，秒级的收敛时间是不能忍受的，因为这将导致当前业务的中断。比如VoIP业务所能容忍的网络中断时间为毫秒级。BGP Auto FRR功能在当物理层或链路层检测到故障后，实现毫秒级收敛，降低对承载业务的影响。</p>
<p><strong>auto-frr</strong>命令用来使能BGP Auto FRR功能。</p>
<h3 id="配置BGP-GR"><a href="#配置BGP-GR" class="headerlink" title="配置BGP GR"></a>配置BGP GR</h3><p>当BGP协议重启时会导致对等体关系重新建立和转发中断，使能平滑重启GR（Graceful Restart）功能后可以避免流量中断。</p>
<p><img src="file:///C:/Users/cao/AppData/Local/Temp/msohtmlclip1/01/clip_image002.gif" alt="http://localhost:7890/pages/31189183/08/31189183/08/resources/public_sys-resources/icon-note.gif"> <strong>说明：</strong></p>
<p>目前，设备仅支持GR Helper，GR Restart的功能由新功能NSR代替，NSR无需配置。</p>
<p>执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/graceful-restart_bgp.html" target="_blank" rel="noopener"><strong>graceful-restart</strong></a>，使能BGP协议的GR功能。</p>
<p>缺省情况下，BGP协议的GR功能未使能</p>
<h2 id="配置BGP路由聚合"><a href="#配置BGP路由聚合" class="headerlink" title="配置BGP路由聚合"></a>配置BGP路由聚合</h2><h3 id="配置BGP自动聚合"><a href="#配置BGP自动聚合" class="headerlink" title="配置BGP自动聚合"></a>配置BGP自动聚合</h3><p>IPv4网络中BGP支持自动聚合和手动聚合两种聚合方式，自动聚合的路由优先级低于手动聚合的路由优先级。</p>
<p><strong>summary automatic</strong>命令用来使能对本地引入的路由进行自动聚合功能。</p>
<p>在BGP-IPv4单播地址族视图下，配置<strong>summary automatic</strong>命令对公网BGP本地引入的路由进行自动聚合。</p>
<p>在BGP-VPN实例IPv4地址族视图下，配置<strong>summary automatic</strong>命令对该私网BGP本地引入的路由进行自动聚合。</p>
<p><strong>summary automatic</strong>命令对BGP引入的路由进行聚合，引入的路由可以是直连路由、静态路由、RIP路由、OSPF路由、IS-IS路由。配置该命令后，BGP将按照自然网段聚合路由（如10.1.1.0/24和10.2.1.0/24将聚合为A类地址10.0.0.0/8），并且BGP只向对等体发送聚合后的路由。这样可以减少路由信息的数量。</p>
<h3 id="配置BGP手动聚合"><a href="#配置BGP手动聚合" class="headerlink" title="配置BGP手动聚合"></a>配置BGP手动聚合</h3><p><strong>aggregate</strong>命令用来在BGP路由表中创建一条聚合路由。</p>
<p><strong>aggregate</strong> <em>ipv4-address</em> { <em>mask</em> | <em>mask-length</em> } [ <strong>as-set</strong> | <strong>attribute-policy</strong> <em>route-policy-name1</em> | <strong>detail-suppressed</strong> | <strong>origin-policy</strong> <em>route-policy-name2</em> | <strong>suppress-policy</strong> <em>route-policy-name3</em> ] *</p>
<p><strong>aggregate</strong> <em>ipv6-address</em> <em>prefix-length</em> [ <strong>as-set</strong> | <strong>attribute-policy</strong> <em>route-policy-name1</em> | <strong>detail-suppressed</strong> | <strong>origin-policy</strong> <em>route-policy-name2</em> | <strong>suppress-policy</strong> <em>route-policy-name3</em> ] *</p>
<p><strong>undo aggregate</strong> <em>ipv4-address</em> { <em>mask</em> | <em>mask-length</em> } [ <strong>as-set</strong> | <strong>attribute-policy</strong> <em>route-policy-name1</em> | <strong>detail-suppressed</strong> | <strong>origin-policy</strong> <em>route-policy-name2</em> | <strong>suppress-policy</strong> <em>route-policy-name3</em> ] *</p>
<p><strong>undo aggregate</strong> <em>ipv6-address</em> <em>prefix-length</em> [ <strong>as-set</strong> | <strong>attribute-policy</strong> <em>route-policy-name1</em> | <strong>detail-suppressed</strong> | <strong>origin-policy</strong> <em>route-policy-name2</em> | <strong>suppress-policy</strong> <em>route-policy-name3</em> ] *</p>
<table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>参数说明</strong></th>
<th><strong>取值</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><em>ipv4-address</em></td>
<td>指定聚合路由的IPv4地址。</td>
<td>点分十进制形式。</td>
</tr>
<tr>
<td><em>mask</em></td>
<td>指定聚合路由的网络掩码。</td>
<td>点分十进制形式。</td>
</tr>
<tr>
<td><em>mask-length</em></td>
<td>指定聚合路由的网络掩码长度。</td>
<td>整数形式，取值范围是0～32。</td>
</tr>
<tr>
<td><em>ipv6-address</em></td>
<td>指定聚合路由的IPv6地址。</td>
<td>32位16进制数，格式为X:X:X:X:X:X:X:X。</td>
</tr>
<tr>
<td><em>prefix-length</em></td>
<td>指定聚合IPv6路由的前缀长度。</td>
<td>整数形式，取值范围是0～128。</td>
</tr>
<tr>
<td><strong>as-set</strong></td>
<td>指定生成具有AS-SET的路由。</td>
<td>-</td>
</tr>
<tr>
<td><strong>attribute-policy</strong> <em>route-policy-name1</em></td>
<td>指定设置聚合后路由的属性策略名称。</td>
<td>字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</td>
</tr>
<tr>
<td><strong>detail-suppressed</strong></td>
<td>指定仅通告聚合路由。</td>
<td>-</td>
</tr>
<tr>
<td><strong>origin-policy</strong> <em>route-policy-name2</em></td>
<td>指定允许生成聚合路由的策略名称。</td>
<td>字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</td>
</tr>
<tr>
<td><strong>suppress-policy</strong> <em>route-policy-name3</em></td>
<td>指定抑制指定路由通告的策略名称。</td>
<td>字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</td>
</tr>
</tbody>
</table>
<p><strong>应用场景</strong></p>
<p>BGP路由聚合分为手动聚合和自动聚合两种，<strong>aggregate</strong>命令用于实现手动聚合。该命令可以对BGP本地路由表中的路由进行聚合。手动聚合后的路由的优先级高于自动聚合。</p>
<p>如果聚合路由中所包含的具体路由各Origin属性不相同，那么聚合路由的Origin属性按照优先级igp &gt; egp &gt; incomplete为准。聚合路由会携带原来所有具体路由中的团体属性。</p>
<p>通过设置关键字<strong>as-set</strong>，可创建一条聚合路由，该路由的自治系统AS（Autonomous System）路径包含了具体路由的AS路径信息。若需聚合较多AS路径时，请慎用此关键字，因为当具体路由的变化较频繁时，会导致路由振荡。</p>
<p>关键字<strong>detail-suppressed</strong>抑制该聚合路由所包含的所有具体路由，只发布该聚合路由。生成的聚合路由带Atomic-aggregate属性，并且不能携带原具体路由的团体属性。</p>
<p>关键字<strong>suppress-policy</strong>能产生聚合路由，但抑制指定路由的通告。可以用<strong>route-policy</strong>的<strong>if-match</strong>子句有选择地抑制一些具体路由，即匹配该策略的路由将被抑制，但其他未通过策略的具体路由仍被通告。也可以通过<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_route-policy.html" target="_blank" rel="noopener"><strong>peer route-policy</strong></a>命令，配置不希望发布给对等体的策略达到相同效果。</p>
<p>使用关键字<strong>origin-policy</strong>仅在匹配<strong>route-policy</strong>时才生成聚合路由。</p>
<p>关键字<strong>attribute-policy</strong>可设置聚合路由的属性。如果在策略中使用命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/apply_as-path.html" target="_blank" rel="noopener"><strong>apply as-path</strong></a>配置了AS_Path属性，且<strong>aggregate</strong>命令设置了关键字<strong>as-set</strong>，那么策略中的<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/apply_as-path.html" target="_blank" rel="noopener"><strong>apply as-path</strong></a>命令将不会生效。通过<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/peer_route-policy.html" target="_blank" rel="noopener"><strong>peer route-policy</strong></a>命令也可以完成同样的工作。</p>
<h2 id="配置向对等体发送缺省路由"><a href="#配置向对等体发送缺省路由" class="headerlink" title="配置向对等体发送缺省路由"></a>配置向对等体发送缺省路由</h2><p>当对等体的BGP路由表中的多条路由都只是由本端发送时，可以在本端配置向对等体发送缺省路由功能。配置向对等体发送缺省路由功能后，无论本端的路由表中是否存在缺省路由，都向对等体发布一条下一跳地址为本地地址的缺省路由，从而很大程度地减少网络路由数量，节省对等体的内存资源与网络资源。</p>
<p><strong>peer default-route-advertise</strong>命令用来配置BGP设备向对等体（组）发布缺省路由。</p>
<p>缺省路由一般应用于具有如下特点的网络中：</p>
<p>存在多个EBGP邻居，且从每个邻居都会收到全网路由。</p>
<p>存在多个路由反射器，从每个反射器都会收到全网路由。</p>
<p>网络未进行负载分担时，BGP对等体最多只接收一份活跃的全网路由；实现负载分担时，BGP对等体接收的活跃路由数量就会翻倍，导致网络路由数量剧增。在这样的网络中，通过配置向BGP对等体仅发布缺省路由，用缺省路由作负载分担，可以很大程度地减少网络路由数量。</p>
<h2 id="配置BMP"><a href="#配置BMP" class="headerlink" title="配置BMP"></a>配置BMP</h2><p>BMP（BGP Monitoring Protocol）主要应用在存在监控服务器，需要对网络中设备的BGP运行状态进行监控。通过配置BMP，可以对网络中设备的BGP运行状态进行实时监控，包括对等体关系的建立与解除、路由信息刷新等。BMP的产生改变了以往只能通过人工查询方式来获得设备的BGP运行状态的状况，大大提高了网络监控的效率。</p>
<p><strong>bmp</strong>命令用来启动BMP并进入BMP视图，或者直接进入BMP视图。</p>
<p><strong>statistics-timer</strong>命令用来配置BMP向监控服务器上报BGP运行状态统计信息的时间间隔。缺省情况下，BMP向监控服务器上报BGP运行状态统计信息的时间间隔为3600s。</p>
<p><strong>session</strong>命令用来配置BMP与监控服务器建立TCP连接的会话地址，并与监控服务器建立TCP连接。</p>
<p><strong>tcp</strong>命令用来配置BMP与监控服务器建立TCP连接的连接信息。</p>
<h2 id="维护BGP"><a href="#维护BGP" class="headerlink" title="维护BGP"></a>维护BGP</h2><h3 id="复位BGP连接"><a href="#复位BGP连接" class="headerlink" title="复位BGP连接"></a>复位BGP连接</h3><p>当BGP路由策略（交换机不支持Router Refresh）发生变化后，需要通过复位BGP连接使新的配置生效。</p>
<p>在确认需要复位所有BGP连接后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp.html" target="_blank" rel="noopener"><strong>reset bgp</strong></a> <strong>all</strong>。</p>
<p>在确认需要复位与指定AS之间的BGP连接后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp.html" target="_blank" rel="noopener"><strong>reset bgp</strong></a> { <em>as-number-plain</em> | <em>as-number-dot</em> }。</p>
<p>在确认需要复位与指定对等体的BGP连接后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp.html" target="_blank" rel="noopener"><strong>reset bgp</strong></a> <em>ipv4-address</em>。</p>
<p>在确认需要复位所有EBGP连接后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp.html" target="_blank" rel="noopener"><strong>reset bgp</strong></a> <strong>external</strong>。</p>
<p>在确认需要复位与指定对等体组的BGP连接后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp.html" target="_blank" rel="noopener"><strong>reset bgp</strong></a> <strong>group</strong> <em>group-name</em>。</p>
<p>在确认需要复位所有IBGP连接后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp.html" target="_blank" rel="noopener"><strong>reset bgp</strong></a> <strong>internal</strong>。</p>
<p>在确认需要复位指定对等体间的MBGP连接后，在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_multicast.html" target="_blank" rel="noopener"><strong>reset bgp multicast</strong></a> <em>peer-address</em>。</p>
<p>在确认需要复位所有MBGP连接后，在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_multicast.html" target="_blank" rel="noopener"><strong>reset bgp multicast</strong></a> <strong>all</strong>。</p>
<p>在确认需要复位同一对等体组内所有对等体间的MBGP连接后，在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_multicast.html" target="_blank" rel="noopener"><strong>reset bgp multicast</strong></a> <strong>group</strong> <em>group-name</em>。</p>
<p>在确认需要复位外部连接后，在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_multicast_external.html" target="_blank" rel="noopener"><strong>reset bgp multicast external</strong></a>。</p>
<p>在确认需要复位内部连接后，在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_multicast_internal.html" target="_blank" rel="noopener"><strong>reset bgp multicast internal</strong></a>。</p>
<h3 id="清除BGP统计信息"><a href="#清除BGP统计信息" class="headerlink" title="清除BGP统计信息"></a>清除BGP统计信息</h3><p>在确认需要清除路由的振荡统计信息后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_flap-info.html" target="_blank" rel="noopener"><strong>reset bgp flap-info</strong></a> [ <strong>regexp</strong> <em>as-path-regexp</em> | <strong>as-path-filter</strong> { <em>as-path-filter-number</em> | <em>as-path-filter-name</em> } | <em>network-address</em> [ <em>mask</em> | <em>mask-length</em> ] ]。</p>
<p>在确认需要清除指定对等体的振荡统计信息后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_flap-info.html" target="_blank" rel="noopener"><strong>reset bgp</strong></a> <em>ipv4-address</em> <strong>flap-info</strong>。</p>
<p>在确认需要清除路由的衰减信息并释放被抑制的路由后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_dampening.html" target="_blank" rel="noopener"><strong>reset bgp dampening</strong></a> [ <em>ipv4-address</em> [ <em>mask</em> | <em>mask-length</em> ] ]。</p>
<p>在确认需要清除MBGP路由的衰减信息后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_multicast_dampening.html" target="_blank" rel="noopener"><strong>reset bgp multicast dampening</strong></a> [ <em>ip-address</em> [ <em>mask</em> | <em>mask-length</em> ] ]。</p>
<p>在确认需要清除MBGP路由的振荡统计信息后，请在用户视图下执行命令<a href="http://localhost:7890/pages/31189183/08/31189183/08/resources/dc/reset_bgp_multicast_flap-info.html" target="_blank" rel="noopener"><strong>reset bgp multicast flap-info</strong></a> [ <em>ip-address</em> [ <em>mask</em> | <em>mask-length</em> ] | <strong>as-path-filter</strong> { <em>as-path-list-number</em> | <em>as-path-list-name</em> } | <strong>regrexp</strong> <em>regrexp</em> ]</p>
<h1 id="华三设备BGP相关配置"><a href="#华三设备BGP相关配置" class="headerlink" title="华三设备BGP相关配置"></a>华三设备BGP相关配置</h1><h2 id="配置BGP基本功能"><a href="#配置BGP基本功能" class="headerlink" title="配置BGP基本功能"></a>配置BGP基本功能</h2><h3 id="动态创建BGP对等体"><a href="#动态创建BGP对等体" class="headerlink" title="动态创建BGP对等体"></a>动态创建BGP对等体</h3><p>设备需要和大量的邻居建立对等体关系时，如果逐个配置对等体关系，则配置工作量大，新增或者删除对等体的维护、升级工作难度较大，且容易出错。</p>
<p>如果设备的邻居位于同一个网段内，则可以通过BGP动态对等体功能简化配置。在设备上简单地配置一个网段地址内的邻居作为动态对等体，就可以接受来自该网段内的所有邻居的连接请求，并与其建立对等体关系。只有当邻居发起连接请求时，本地才会维护与该邻居的对等体关系；否则，不维护对等体关系。BGP动态对等体功能既简化了配置，又大大降低了维护和升级成本。</p>
<p>配置动态对等体时，设备和邻居只能有一端配置网段地址，另一端必须配置实际IP地址。</p>
<h3 id="配置EBGP对等体组"><a href="#配置EBGP对等体组" class="headerlink" title="配置EBGP对等体组"></a>配置EBGP对等体组</h3><p>根据对等体组中的对等体是否属于同一个外部AS，EBGP对等体组又可以分为纯EBGP对等体组和混合EBGP对等体组。如果对等体组中的对等体属于同一个外部AS，该对等体组就是纯EBGP对等体组；如果对等体组中的对等体属于不同外部AS，该对等体组就是混合EBGP对等体组。</p>
<p>用户有三种方式配置EBGP对等体组：</p>
<p> 第一种方式是创建对等体组后，先指定对等体组的AS号，再将对等体加入到对等体组中，该方式下加入的对等体具有相同的AS号，均为对等体组的AS号。对等体加入对等体组之前可以配置AS号，且为对等体配置的AS号必须与对等体组的AS号相同。</p>
<p> 第二种方式是创建对等体组后，先配置对等体的AS号，再将对等体加入对等体组中。该方式下，对等体组中对等体的AS号可以相同也可以不同。</p>
<p> 第三种方式是创建对等体组后，将对等体加入对等体组的同时指定AS号。该方式下，对等体组中对等体的AS号可以相同也可以</p>
<p><strong>group</strong> <em>group-name</em> <strong>external</strong> 创建EBGP对等体组</p>
<p><strong>peer</strong> <em>ipv4-address [ mask-length ]</em> <strong>group</strong> <em>group-name [</em> <strong>as-number</strong> <em>as-number ]</em> 向对等体组中添加指定的IPv4 BGP对等体</p>
<p><strong>peer</strong> <em>group-name</em> <strong>description</strong> <em>text</em>  （可选）配置对等体组的描述信息</p>
<h3 id="配置建立TCP连接使用的源地址"><a href="#配置建立TCP连接使用的源地址" class="headerlink" title="配置建立TCP连接使用的源地址"></a>配置建立TCP连接使用的源地址</h3><p>BGP使用TCP作为其传输层协议。缺省情况下，BGP使用到达BGP对等体的最佳路由出接口的主IP地址或IPv6地址与对等体/对等体组建立TCP连接。在如下场合可以通过本配置指定建立TCP连接使用的源地址或源接口（即采用指定源接口的IP地址/IPv6地址与对等体/对等体组建立TCP连接）：</p>
<p> 当指定的对等体的IP地址/IPv6地址不是本地路由器与对等体之间直连接口的IP地址/IPv6地址时，需要在对等体上通过本配置将建立TCP连接使用的源接口指定为对等体IP地址/IPv6地址所在的接口。例如，本端设备通过接口A和对端设备的接口B相连，在本端使用<strong>peer</strong> x.x.x.x <strong>as-number</strong> <em>as-number</em>命令将对端指定为自己的对等体，但是x.x.x.x不是接口B的IP地址时，需要在对端设备上使用<strong>peer connect-interface</strong>命令配置源接口，指定源接口为IP地址x.x.x.x所在的接口。</p>
<p> 当建立BGP会话的路由器之间存在冗余链路时，如果路由器上的一个接口发生故障，链路状态变为down，建立TCP连接的源地址可能会随之发生变化，导致BGP需要重新建立TCP连接，造成网络震荡。为了避免该情况的发生，建议网络管理员将建立TCP连接所使用的源地址配置为Loopback接口的地址，或将源接口配置为Loopback接口，以提高TCP连接的可靠性和稳定性。</p>
<p> 当BGP对等体之间同时建立多条BGP会话时，如果没有明确指定建立TCP连接的源地址，可能会导致根据最优路由选择TCP连接源地址错误，并影响BGP会话的建立。如果多条BGP会话基于不同接口的IP地址建立，则建议用户在配置BGP对等体时，通过配置源接口或源地址明确指定每个BGP会话的TCP连接源地址；如果多条BGP会话基于同一接口的不同IP地址建立，则建议用户通过配置源地址，明确指定每个BGP会话的TCP连接源地址。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>source-address</strong> <em>source-ipv4-address</em> </p>
<p>指定与对等体/对等体组创建BGP会话时建立TCP连接使用的源IP地址</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>connect-interface</strong> <em>interface-type interface-number</em></p>
<p>指定与对等体/对等体组创建BGP会话时建立TCP连接使用的源接口</p>
<p>缺省情况下，BGP使用到达BGP对等体的最佳路由出接口的主IP地址与对等体/对等体组建立TCP连接</p>
<h2 id="控制BGP路由信息的发布与接收"><a href="#控制BGP路由信息的发布与接收" class="headerlink" title="控制BGP路由信息的发布与接收"></a>控制BGP路由信息的发布与接收</h2><h3 id="配置BGP路由聚合-1"><a href="#配置BGP路由聚合-1" class="headerlink" title="配置BGP路由聚合"></a>配置BGP路由聚合</h3><p>在中型或大型BGP网络中，在向对等体发布路由信息时，可以配置路由聚合，减少发布的路由数量，并减小路由表的规模。IPv4 BGP支持自动聚合和手动聚合两种聚合方式，同时配置时，手动聚合的优先级高于自动聚合的优先级。IPv6 BGP只支持手动聚合。</p>
<p>BGP路由表中创建的聚合路由的出接口为Null0接口，聚合后可以减少向BGP对等体发布的路由数目。在使用中应注意不要使这条聚合路由成为本设备的优选路由，否则会导致报文转发失败。如果聚合路由的子网掩码长度和被聚合的某一条具体路由完全相同，且聚合路由优先级高于具体路由，则聚合路由会成为优选路由，这种情况下需要通过修改路由优先级等方式，来确保优选的路由为具体路由。</p>
<p><strong>summary automatic</strong> 配置对引入的子网路由进行自动聚合</p>
<p><strong>aggregate</strong> <em>ipv4-address { mask-length | mask } [</em> <strong>as-set</strong> <em>|</em> <strong>attribute-policy</strong> <em>route-policy-name |</em> <strong>detail-suppressed</strong> <em>|</em> <strong>origin-policy</strong> <em>route-policy-name |</em> <strong>suppress-policy</strong> *route-policy-name ] **  在BGP路由表中创建一条聚合路由</p>
<h3 id="配置发布IP路由表中的最优路由"><a href="#配置发布IP路由表中的最优路由" class="headerlink" title="配置发布IP路由表中的最优路由"></a>配置发布IP路由表中的最优路由</h3><p>缺省情况下，BGP发布BGP路由表中的最优路由，不管该路由在IP路由表中是否为最优路由。通过本配置可以保证BGP发送出去的路由是IP路由表中的最优路由，以减少BGP发送的路由数量。</p>
<p><strong>advertise-rib-active</strong>  在指定地址族视图下，配置发布IP路由表中的最优路由</p>
<p>缺省情况下，与BGP实例视图下的配置保持一致</p>
<h3 id="配置优先发送缺省路由的更新信息"><a href="#配置优先发送缺省路由的更新信息" class="headerlink" title="配置优先发送缺省路由的更新信息"></a>配置优先发送缺省路由的更新信息</h3><p>BGP路由器向对等体发送路由更新消息时，不会优先发送缺省路由的更新消息。当BGP邻居关系断开时，无法保证优先撤销缺省路由，如果需要撤销的路由数量较多，那么较长时间后才能撤销缺省路由，造成流量中断时间较长。配置BGP优先发送缺省路由更新，BGP路由器会将缺省路由作为第一条更新进行发送，在BGP邻居关系断开时，最大限度地减少流量中断时间。</p>
<p><strong>default-route update-first</strong> 配置优先发送缺省路由的更新消息 </p>
<p>缺省情况下，不优先发送缺省路由的更新消息</p>
<h3 id="限制从BGP对等体-对等体组接收的路由数量"><a href="#限制从BGP对等体-对等体组接收的路由数量" class="headerlink" title="限制从BGP对等体/对等体组接收的路由数量"></a>限制从BGP对等体/对等体组接收的路由数量</h3><p>通过本配置可以避免攻击者向路由器发送大量的BGP路由，对路由器进行攻击。</p>
<p>当路由器从指定对等体/对等体组接收的路由数量超过指定的最大值时，可以选择以下处理方式：</p>
<p> 路由器中断与该对等体/对等体组的BGP会话，不再尝试重建会话。</p>
<p> 路由器保持与该对等体/对等体组的BGP会话，可以继续接收路由，仅打印日志信息。</p>
<p> 路由器保持与该对等体/对等体组的BGP会话，丢弃超出限制的路由，并打印日志信息。</p>
<p> 路由器中断与该对等体/对等体组的BGP会话，经过指定的时间后自动与对等体/对等体组重建会话。</p>
<p>执行本配置任务时，还可以指定路由器产生日志信息的阈值，即路由器接收的路由数量与配置的最大值的百分比达到指定的阈值时，路由器将产生日志信息。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>route-limit</strong> <em>prefix-number [ {</em> <strong>alert-only</strong> <em>|</em> <strong>discard</strong> <em>|</em> <strong>reconnect</strong> *reconnect-time } | percentage-value ] **</p>
<p>配置允许从对等体/对等体组接收的路由的最大数量</p>
<p>缺省情况下，不限制从对等体/对等体组接收的路由数量</p>
<h3 id="配置BGP路由信息的发布接收策略"><a href="#配置BGP路由信息的发布接收策略" class="headerlink" title="配置BGP路由信息的发布接收策略"></a>配置BGP路由信息的发布接收策略</h3><p>配置BGP路由信息的发布/接收策略前，根据采取的策略，需要配置下列过滤器：</p>
<ul>
<li>访问控制列表</li>
<li>地址前缀列表</li>
<li>路由策略</li>
<li>AS路径过滤列表</li>
</ul>
<p>用户可以根据需求选择过滤策略。如果同时配置了几种过滤策略，则按照如下顺序过滤发布的路由信息：</p>
<ul>
<li><strong>filter-policy export</strong></li>
<li><strong>peer filter-policy export</strong></li>
<li><strong>peer as-path-acl export</strong></li>
<li><strong>peer prefix-list export</strong></li>
<li><strong>peer route-policy export</strong></li>
</ul>
<p>用户可以根据需求选择过滤策略。如果同时配置了几种过滤策略，则按照如下顺序过滤接收的路由：</p>
<ul>
<li><strong>filter-policy import</strong></li>
<li><strong>peer filter-policy import</strong></li>
<li><strong>peer as-path-acl import</strong></li>
<li><strong>peer prefix-list import</strong></li>
<li><strong>peer route-policy import</strong></li>
</ul>
<h3 id="配置BGP新增路由发布速率"><a href="#配置BGP新增路由发布速率" class="headerlink" title="配置BGP新增路由发布速率"></a>配置BGP新增路由发布速率</h3><p>网络中新增路由数量较大时，如果在短时间内发布大量路由，可能会导致BGP对等体已接收到新增路由并添加对应的转发表项，本地设备上的转发表项却尚未添加，从而导致流量转发失败。通过本功能合理地配置BGP发送新增路由的速率可以避免上述情况发生。</p>
<p>请根据设备的性能合理配置BGP发送新增路由的速率，如果设备的性能较高，可以将BGP发送新增路由的速率适当调大；如果设备的性能一般，建议将BGP发送新增路由的速率适当调小。</p>
<p>目前，仅支持对新增IPv4单播和IPv6单播路由的发送速率进行限制。</p>
<p><strong>route-rate-limit</strong> <em>rate</em>  配置BGP新增路由发布速率</p>
<p>缺省情况下，不限制BGP发送新增路由的发布速率</p>
<h3 id="配置BGP延迟发布"><a href="#配置BGP延迟发布" class="headerlink" title="配置BGP延迟发布"></a>配置BGP延迟发布</h3><p>通过配置当前设备在重启后延迟发布路由更新消息，可以保证在重启时BGP先引入其他邻居的所有路由信息，然后再优选并向其他设备发布，以减少设备重启造成的流量丢失。</p>
<p>配置BGP延迟发布后，如果需要部分路由前缀不受延迟发布控制，可以使用路由策略进行控制，通过前缀列表过滤的路由不受延迟发布的影响。</p>
<p><strong>bgp update-delay on-startup</strong> <em>seconds</em> 配置设备在重启后延迟发布路由更新消息</p>
<p>缺省情况下，设备重启后立刻向BGP邻居发布路由更新消息</p>
<p><strong>bgp update-delay on-startup prefix-list</strong> <em>prefix-list-name</em> </p>
<p>（可选）配置路由策略控制BGP延迟发布 目前只支持IPv4地址前缀列表</p>
<h3 id="配置设备启动时为BGP路由应用启动策略"><a href="#配置设备启动时为BGP路由应用启动策略" class="headerlink" title="配置设备启动时为BGP路由应用启动策略"></a>配置设备启动时为BGP路由应用启动策略</h3><p>设备在启动时，通过为BGP路由应用启动策略，修改发送的BGP路由的属性值，使得接收端优选其他设备发送的路由，可以减少设备重启造成的流量丢失。</p>
<p><strong>bgp apply-policy on-startup duration</strong> <em>seconds</em> 配置设备在重启后发送应用启动策略的路由更新消息的时间</p>
<p><strong>bgp policy on-startup med</strong> <em>med-value</em> 配置启动策略中的MED值 缺省情况下，启动策略中的MED值为4294967295</p>
<h2 id="配置BGP路径的选择"><a href="#配置BGP路径的选择" class="headerlink" title="配置BGP路径的选择"></a>配置BGP路径的选择</h2><h3 id="配置MED属性-1"><a href="#配置MED属性-1" class="headerlink" title="配置MED属性"></a>配置MED属性</h3><p>MED用来判断流量进入AS时的最佳路由。当一个BGP路由器通过不同的EBGP对等体得到目的地址相同但下一跳不同的多条路由时，在其它条件相同的情况下，将优先选择MED值较小者作为最佳路由。</p>
<p><strong>default med</strong> <em>med-value</em>  配置MED的缺省值 缺省情况下，MED的缺省值为0</p>
<p><strong>compare-different-as-med</strong> 配置允许比较来自不同AS路由的MED属性值</p>
<p>缺省情况下，不允许比较来自不同AS路由的MED属性值</p>
<p><strong>bestroute compare-med</strong>  配置对来自同一AS的路由进行MED排序优选 </p>
<p>缺省情况下，不会对来自同一AS的路由进行MED排序优选</p>
<h3 id="配置AS-Path属性-1"><a href="#配置AS-Path属性-1" class="headerlink" title="配置AS_Path属性"></a>配置AS_Path属性</h3><p><strong>bestroute as-path-neglect</strong> 配置BGP在选择最优路由时忽略AS_PATH属性 缺省情况下，BGP将AS_PATH属性作为选择最优路由的一个条件</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>fake-as</strong> <em>as-number</em> 为对等体/对等体组指定一个虚拟的本地自治系统号</p>
<p>配置发送BGP更新消息时AS_Path属性中不携带私有AS号</p>
<p>私有AS号是内部使用的AS号，范围为64512～65535。私有AS号主要用于测试网络，一般情况下不需要在公共网络中传播。</p>
<p>通过本配置，可以指定如果向EBGP对等体/对等体组发送的BGP更新消息中AS_PATH属性只包括私有AS号，则删除私有AS号后，将BGP更新消息发送给对等体/对等体组。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>public-as-only</strong> 配置向指定EBGP对等体/对等体组发送BGP更新消息时只携带公有AS号，不携带私有AS号</p>
<p>缺省情况下，系统收到EBGP路由后，会检测路由的第一个AS号。如果此AS号不是EBGP对等体的AS号，且不是私有AS号，则断开与该对等体的BGP会话。</p>
<p>通过配置<strong>ignore-first-as</strong>命令，可以忽略对EBGP路由第一个AS号的检测。</p>
<p>表1-75 配置EBGP不检测路由的第一个AS号</p>
<p><strong>ignore-first-as</strong> 配置不检测EBGP路由的第一个AS号</p>
<h3 id="配置BGP在选择最优路由时忽略IGP-Metric的比较"><a href="#配置BGP在选择最优路由时忽略IGP-Metric的比较" class="headerlink" title="配置BGP在选择最优路由时忽略IGP Metric的比较"></a>配置BGP在选择最优路由时忽略IGP Metric的比较</h3><p>从多个邻居收到多条相同前缀但不同路径的路由时，BGP需要选择到达该前缀的最佳路由来指导报文转发。缺省情况下，BGP会比较这些路由下一跳的IGP路由的Metric值，并优选IGP Metric值最小的路由。</p>
<p>配置了本功能后，BGP在选择最优路由时忽略IGP Metric的比较。</p>
<p><strong>bestroute igp-metric-ignore</strong>  配置BGP在选择最优路由时忽略IGP Metric的比较</p>
<h3 id="配置SoO属性"><a href="#配置SoO属性" class="headerlink" title="配置SoO属性"></a>配置SoO属性</h3><p>为BGP对等体/对等体组配置SoO属性后，从该BGP对等体/对等体组接收路由时设备会为路由增加SoO属性，并且向该BGP对等体/对等体组发布路由时设备会检查路由的SoO属性，如果路由中携带的SoO属性与为对等体/对等体组配置的SoO属性相同，则不会将该路由发布给对等体/对等体组，从而避免路由环路。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>soo</strong> <em>site-of-origin</em> 为BGP对等体/对等体组配置SoO属性</p>
<h2 id="调整和优化BGP网络"><a href="#调整和优化BGP网络" class="headerlink" title="调整和优化BGP网络"></a>调整和优化BGP网络</h2><h3 id="配置BGP会话的存活时间间隔与保持时间"><a href="#配置BGP会话的存活时间间隔与保持时间" class="headerlink" title="配置BGP会话的存活时间间隔与保持时间"></a>配置BGP会话的存活时间间隔与保持时间</h3><p><strong>timer</strong> <strong>keepalive</strong> <em>keepalive</em> <strong>hold</strong> <em>holdtime</em> </p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>timer</strong> <strong>keepalive</strong> <em>keepalive</em> <strong>hold</strong> <em>holdtime</em></p>
<p>缺省情况下，BGP会话的存活时间间隔为60秒，保持时间为180秒</p>
<h3 id="配置重新建立BGP会话的时间间隔"><a href="#配置重新建立BGP会话的时间间隔" class="headerlink" title="配置重新建立BGP会话的时间间隔"></a>配置重新建立BGP会话的时间间隔</h3><p><strong>timer connect-retry</strong> <em>retry-time</em></p>
<p><strong>peer</strong> { <em>group-name</em> | <em>ipv4-address</em> [ <em>mask-length</em> ] | <em>ipv6-address</em> [ <em>prefix-length</em> ] } <strong>timer connect-retry</strong> <em>retry-time</em></p>
<table>
<thead>
<tr>
<th>缺省情况下，本地路由器与对等体/对等体组之间重新建立BGP会话的时间间隔为32秒</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="配置发布同一路由的时间间隔"><a href="#配置发布同一路由的时间间隔" class="headerlink" title="配置发布同一路由的时间间隔"></a>配置发布同一路由的时间间隔</h3><p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>route-update-interval</strong> <em>interval</em></p>
<p>缺省情况下，向IBGP对等体发布同一路由的时间间隔为15秒，向EBGP对等体发布同一路由的时间间隔为30秒</p>
<h3 id="使能直连EBGP会话快速复位功能"><a href="#使能直连EBGP会话快速复位功能" class="headerlink" title="使能直连EBGP会话快速复位功能"></a>使能直连EBGP会话快速复位功能</h3><p>如果没有使能本功能，则连接直连EBGP对等体的链路down后，本地路由器不会立即断开与EBGP对等体的会话，而是等待会话保持时间（Holdtime）超时后，才断开该会话。没有使能本功能时，链路震荡不会影响EBGP会话的状态。</p>
<p>如果使能了本功能，则连接直连EBGP对等体的链路down后，本地路由器会立即断开与EBGP对等体的会话，并重新与该对等体建立EBGP会话，从而实现快速发现链路故障，快速重建会话。</p>
<p><strong>ebgp-interface-sensitive</strong> 缺省情况下，直连EBGP会话快速复位功能处于使能状态</p>
<h3 id="使能4字节AS号抑制功能"><a href="#使能4字节AS号抑制功能" class="headerlink" title="使能4字节AS号抑制功能"></a>使能4字节AS号抑制功能</h3><p>设备支持4字节的AS号，即AS号取值占用4字节，取值范围为1～4294967295。缺省情况下，设备在与对端设备建立BGP会话时，通过Open消息通告对端设备本端支持4字节的AS号。如果对端设备不支持4字节AS号（只支持2字节AS号），则会导致会话协商失败。此时，在本端与对端设备之间使能4字节AS号抑制功能，可以使得本端设备通过Open消息向对端设备谎称自己不支持4字节的AS号，从而确保本端和对端设备之间可以成功建立BGP会话。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>capability-advertise suppress-4-byte-as</strong></p>
<p>缺省情况下， 4字节AS号抑制功能处于关闭状态</p>
<h3 id="配置BGP的MD5认证"><a href="#配置BGP的MD5认证" class="headerlink" title="配置BGP的MD5认证"></a>配置BGP的MD5认证</h3><p>通过为BGP对等体配置BGP的MD5认证，可以在以下两方面提高BGP的安全性：</p>
<p> 为BGP建立TCP连接时进行MD5认证，只有两台路由器配置的密钥相同时，才能建立TCP连接，从而避免与非法的BGP路由器建立TCP连接。</p>
<p> 传递BGP报文时，对封装BGP报文的TCP报文段进行MD5运算，从而保证BGP报文不会被篡改。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>password</strong> <em>{</em> <strong>cipher</strong> <em>|</em> <strong>simple</strong> <em>} password</em></p>
<h2 id="配置BGP负载分担-1"><a href="#配置BGP负载分担-1" class="headerlink" title="配置BGP负载分担"></a>配置BGP负载分担</h2><p>通过改变BGP选路规则实现负载分担时，设备根据<strong>balance</strong>命令配置的进行BGP负载分担的路由条数，选择指定数目的路由进行负载分担，以提高链路利用率。</p>
<p><strong>balance</strong> [ <strong>ebgp | eibgp | ibgp ]</strong> <em>number</em> 配置进行BGP负载分担的路由条数</p>
<p>缺省情况下，不会进行BGP负载分担</p>
<p><strong>balance as-path-neglect</strong> （可选）配置不同AS_PATH属性的路由能够形成BGP负载分担</p>
<p>缺省情况下，不同AS_PATH属性的路由之间不能形成BGP负载分担</p>
<p><strong>balance as-path-relax</strong> （可选）配置内容不同但长度相同的AS_PATH属性的路由能够形成BGP负载分担</p>
<p>缺省情况下，内容不同但长度相同的AS_PATH属性的路由不能形成BGP负载分担</p>
<h2 id="禁止与对等体建立会话"><a href="#禁止与对等体建立会话" class="headerlink" title="禁止与对等体建立会话"></a>禁止与对等体建立会话</h2><p>由于网络升级维护等原因，需要暂时断开与某个对等体/对等体组的BGP会话时，可以通过本配置禁止与该对等体/对等体组建立会话。当网络恢复后，通过执行<strong>undo peer ignore</strong>命令恢复与对等体/对等体组的会话。这样，网络管理员无需删除并重新进行对等体/对等体组相关配置，减少了网络维护的工作量。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>ignore</strong>  禁止与对等体/对等体组建立会话</p>
<h2 id="配置BGP-NSR"><a href="#配置BGP-NSR" class="headerlink" title="配置BGP NSR"></a>配置BGP NSR</h2><p>BGP NSR（Nonstop Routing，不间断路由）是一种通过在BGP协议主备进程之间备份必要的协议状态和数据（如BGP邻居信息和路由信息），使得BGP协议的主进程中断时，备份进程能够无缝地接管主进程的工作，从而确保对等体感知不到BGP协议中断，保持BGP路由，并保证转发不会中断的技术。</p>
<p>导致BGP主进程中断的事件包括以下几种：</p>
<ul>
<li>BGP主进程重启</li>
<li>BGP主进程所在的主控板发生故障</li>
<li>BGP主进程所在的主控板进行ISSU（In-Service Software Upgrade，不中断业务升级）</li>
</ul>
<p>BGP NSR与BGP GR具有如下区别，请根据实际情况选择合适的方式确保数据转发不中断：</p>
<p> 对设备要求不同：BGP协议的主进程和备进程运行在不同的主控板上，因此要运行BGP NSR功能，设备上必须有两个或两个以上的主控板。要运行BGP GR功能，设备上可以只有一个主控板。</p>
<p> 对BGP对等体的要求不同：使用BGP NSR功能时，BGP对等体不会感知本地设备发生了BGP进程的异常重启或主备倒换等故障，不需要BGP对等体协助恢复BGP路由信息。BGP GR要求BGP对等体具有GR能力，并且在BGP会话中断恢复时，BGP对等体能够作为GR helper协助本地设备恢复BGP路由信息。</p>
<p><strong>non-stop-routing</strong>  使能BGP NSR功能  缺省情况下，BGP NSR功能处于关闭状态</p>
<p><strong>华为设备缺省处于使能状态。</strong></p>
<h3 id="BGP功能特性"><a href="#BGP功能特性" class="headerlink" title="BGP功能特性"></a>BGP功能特性</h3><h3 id="开启告警功能"><a href="#开启告警功能" class="headerlink" title="开启告警功能"></a>开启告警功能</h3><p><strong>snmp-agent trap enable bgp</strong></p>
<p>[ <strong>instance</strong> <em>instance-name</em> <strong>]</strong></p>
<p>开启BGP模块的告警功能</p>
<p>缺省情况下，BGP模块的告警功能处于开启状态</p>
<h3 id="使能BGP日志功能"><a href="#使能BGP日志功能" class="headerlink" title="使能BGP日志功能"></a>使能BGP日志功能</h3><p>全局使能BGP日志记录功能，并使能与指定对等体/对等体组之间BGP会话的日志记录功能后，与该对等体/对等体组之间的BGP会话建立以及断开时会生成日志信息，通过<strong>display bgp peer ipv4 unicast log-info</strong>命令或<strong>display bgp peer ipv6 unicast log-info</strong>命令可以查看记录的日志信息。生成的日志信息还将被发送到设备的信息中心，通过设置信息中心的参数，决定日志信息的输出规则（即是否允许输出以及输出方向）。</p>
<p><strong>log-peer-change</strong>  全局使能BGP日志记录功能<br> 缺省情况下，全局BGP日志记录功能处于开启状态</p>
<h3 id="使能BGP的路由抖动日志记录功能"><a href="#使能BGP的路由抖动日志记录功能" class="headerlink" title="使能BGP的路由抖动日志记录功能"></a>使能BGP的路由抖动日志记录功能</h3><p>使能BGP对应地址族的路由抖动日志记录功能后，当该地址族的路由发生抖动并满足日志输出条件时会生成路由抖动日志信息。生成的日志信息还将被发送到设备的信息中心，通过设置信息中心的参数，决定日志信息的输出规则（即是否允许输出以及输出方向）。</p>
<p><strong>log-route-flap</strong> <em>monitor-time monitor-count [ log-count-limit |</em> <strong>route-policy</strong> *route-policy-name ] **</p>
<p>缺省情况下，BGP的路由抖动日志记录功能处于关闭状态</p>
<h3 id="配置BGP与BFD联动"><a href="#配置BGP与BFD联动" class="headerlink" title="配置BGP与BFD联动"></a>配置BGP与BFD联动</h3><p>配置BGP GR功能后，请慎用BGP与BFD联动功能。因为当链路故障时，系统可能还没来得及启用GR处理流程，BFD已经检测到链路故障了，从而导致GR失败。如果设备上同时配置了BGP GR和BGP BFD，则在BGP GR期间请勿去使能BGP BFD，否则可能导致GR失败。</p>
<p><strong>peer</strong> { <em>group-name | ipv4-address [ mask-length ] }</em> <strong>bfd</strong> <em>[</em> <strong>multi-hop</strong> <em>|</em> <strong>single-hop</strong> <em>]</em></p>
<p>缺省情况下，不使用BFD检测本地路由器和BGP对等体/对等体组之间的链路</p>
<h3 id="配置BGP快速重路由"><a href="#配置BGP快速重路由" class="headerlink" title="配置BGP快速重路由"></a>配置BGP快速重路由</h3><p>当BGP网络中的链路或某台路由器发生故障时，需要通过故障链路或故障路由器传输才能到达目的地的报文将会丢失或产生路由环路，数据流量将会被中断。直到BGP根据新的网络拓扑路由收敛后，被中断的流量才能恢复正常的传输。</p>
<p>为了尽可能缩短网络故障导致的流量中断时间，网络管理员可以开启BGP快速重路由功能。</p>
<p>开启BGP快速重路由功能的方法有如下两种：</p>
<p> 在BGP地址族视图下执行<strong>pic</strong>命令开启当前地址族的BGP快速重路由功能。采用这种方法时，BGP会为当前地址族的所有BGP路由自动计算备份下一跳，即只要从不同BGP对等体学习到了到达同一目的网络的路由，且这些路由不等价，就会生成主备两条路由。</p>
<p> 在BGP地址族视图下执行<strong>fast-reroute route-policy</strong>命令指定快速重路由引用的路由策略，并在引用的路由策略中，通过<strong>apply</strong> [ <strong>ipv6 ] fast-reroute backup-nexthop</strong>命令指定备份下一跳的地址。采用这种方式时，只有为主路由计算出的备份下一跳地址与指定的地址相同时，才会为其生成备份下一跳；否则，不会为主路由生成备份下一跳。在引用的路由策略中，还可以配置<strong>if-match</strong>子句，用来决定哪些路由可以进行快速重路由保护，BGP只会为通过<strong>if-match</strong>子句过滤的路由生成备份下一跳。</p>
<p>引用路由策略方式的优先级高于通过<strong>pic</strong>命令开启BGP快速重路由方式。</p>
<p>IPv4单播路由和IPv6单播路由支持BGP快速重路由功能；IPv4组播路由和IPv6组播路由不支持BGP快速重路由功能。</p>
<h1 id="思科BGP相关配置"><a href="#思科BGP相关配置" class="headerlink" title="思科BGP相关配置"></a>思科BGP相关配置</h1><h2 id="配置BGP基础功能"><a href="#配置BGP基础功能" class="headerlink" title="配置BGP基础功能"></a>配置BGP基础功能</h2><p>router bgp 100   #创建BGP进程</p>
<p><strong>neighbor</strong> <em>ip-address</em> <strong>remote-as</strong> <em>number #**建立邻居</em></p>
<p>如果有任何BGP配置更改，则必须重置邻居连接以允许新参数生效。</p>
<p><strong>clear ip bgp</strong> <em>address</em> <em>重置指定邻居的<strong>BGP</strong>连接</em></p>
<p><strong>clear ip bgp *</strong>   <strong>重置所有邻居的**</strong>BGP<strong>**连接</strong></p>
<p>默认情况下，BGP会话从使用BGP版本4开始，如果需要，向下协商到较早的版本。可以阻止协商并强制路由器使用BGP版本与邻居通信。在路由器配置模式下执行此命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neighbor &#123;ip address | peer-group-name&#125; version value</span><br></pre></td></tr></table></figure>
<p>BGP建立邻居，需要注意以下几点：</p>
<ul>
<li>BGP版本是v4.</li>
<li>远端router id, 这个数字是路由器上最高的IP地址，或者是最高的环回接口(如果存在的话)。</li>
<li>表版本：表版本提供了表的状态。每当有新的信息进来时，表就会增加版本。如果一个版本在不断增加，则表示有某个路由皮瓣导致路由的不断更新。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">show ip bgp neighbors</span><br><span class="line">     BGP neighbor is 129.213.1.1, remote AS 200, external link </span><br><span class="line">     BGP version 4, remote router ID 175.220.12.1 </span><br><span class="line">     BGP state = Established, table version = 3, up for 0:10:59 </span><br><span class="line">     Last read 0:00:29, hold time is 180, keepalive interval is 60 seconds </span><br><span class="line">     Minimum time between advertisement runs is 30 seconds </span><br><span class="line">     Received 2828 messages, 0 notifications, 0 in queue </span><br><span class="line">     Sent 2826 messages, 0 notifications, 0 in queue </span><br><span class="line">     Connections established 11; dropped 10</span><br></pre></td></tr></table></figure>
<h3 id="BGP的Loopback接口和EBGP多跳："><a href="#BGP的Loopback接口和EBGP多跳：" class="headerlink" title="BGP的Loopback接口和EBGP多跳："></a>BGP的Loopback接口和EBGP多跳：</h3><p>使用环回接口来定义邻居在iBGP中很常见，但在eBGP中不常见。通常，使用环回接口来确保邻居的IP地址不受正常运行的硬件的影响。在eBGP的情况下，对等路由器经常有直接连接，环回不适用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neighbor ip-address update-source interface #指定更新</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">neighbor <span class="number">180.225</span><span class="number">.11</span><span class="number">.1</span> ebgp-multihop #配置EBGP多跳</span><br><span class="line">配置示例：</span><br><span class="line"><span class="keyword">int</span> loopback <span class="number">0</span> </span><br><span class="line">ip address <span class="number">150.10</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line">router bgp <span class="number">100</span> </span><br><span class="line">neighbor <span class="number">160.10</span><span class="number">.1</span><span class="number">.1</span> remote-as <span class="number">200</span> </span><br><span class="line">neighbor <span class="number">160.10</span><span class="number">.1</span><span class="number">.1</span> ebgp-multihop </span><br><span class="line">neighbor <span class="number">160.10</span><span class="number">.1</span><span class="number">.1</span> update-source loopback <span class="number">0</span> </span><br><span class="line">network <span class="number">150.10</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<p>使用环回口建立邻居的情况下，如果有多跳链路直连，可以实现负载。</p>
<h2 id="BGP中控制路由的接收与发送"><a href="#BGP中控制路由的接收与发送" class="headerlink" title="BGP中控制路由的接收与发送"></a>BGP中控制路由的接收与发送</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route-map map-tag [[permit | deny] | [sequence-number]]</span><br></pre></td></tr></table></figure>
<p>route-map可以匹配：</p>
<ul>
<li><strong>match as-path</strong></li>
<li><strong>match community</strong></li>
<li><strong>match clns</strong></li>
<li><strong>match interface</strong></li>
<li><strong>match ip address</strong></li>
<li><strong>match ip next-hop</strong></li>
<li><strong>match ip route-source</strong></li>
<li><strong>match metric</strong></li>
<li><strong>match route-type</strong></li>
<li><strong>match tag</strong></li>
</ul>
<p>可以设置：</p>
<ul>
<li><strong>set as-path</strong></li>
<li><strong>set clns</strong></li>
<li><strong>set automatic-tag</strong></li>
<li><strong>set community</strong></li>
<li><strong>set interface</strong></li>
<li><strong>set default interface</strong></li>
<li><strong>set ip default next-hop</strong></li>
<li><strong>set level</strong></li>
<li><strong>set local-preference</strong></li>
<li><strong>set metric</strong></li>
<li><strong>set metric-type</strong></li>
<li><strong>set next-hop</strong></li>
<li><strong>set origin</strong></li>
<li><strong>set tag</strong></li>
<li><strong>set weight</strong></li>
</ul>
<p>路由策略配置示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router bgp 300</span><br><span class="line">network 170.10.0.0</span><br><span class="line">neighbor 2.2.2.2 remote-as 100</span><br><span class="line">neighbor 2.2.2.2 route-map STOPUPDATES out</span><br><span class="line"> </span><br><span class="line">route-map STOPUPDATES permit 10</span><br><span class="line">match ip address 1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access-list 1 deny 170.10.0.0 0.0.255.255</span><br><span class="line">access-list 1 permit 0.0.0.0 255.255.255.255</span><br></pre></td></tr></table></figure>
<h3 id="BGP宣告网络"><a href="#BGP宣告网络" class="headerlink" title="BGP宣告网络"></a>BGP宣告网络</h3><p>Network宣告网段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network network-number [mask network-mask]， 最多宣告200个。</span><br></pre></td></tr></table></figure>
<p>重分发网段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redistribute ospf 10</span><br><span class="line">neighbor 1.1.1.1 distribute-list 1 out #配置BGP重分发，建议使用过滤，只重分发需要的路由。</span><br><span class="line">redistribute eigrp 10</span><br></pre></td></tr></table></figure>
<h2 id="思科设备BGP选路原则"><a href="#思科设备BGP选路原则" class="headerlink" title="思科设备BGP选路原则"></a>思科设备BGP选路原则</h2><p>当BGP从不同的自治系统接收到关于不同目的地的更新后，协议必须选择到达特定目的地的路径。BGP只选择一条路径到达特定的目的地。</p>
<p>BGP总是向邻居传播最佳路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neighbor &#123;ip-address | peer-group-name&#125; next-hop-self  #配置BGP下一跳为自己</span><br></pre></td></tr></table></figure>
<h3 id="思科路由协议的默认管理距离："><a href="#思科路由协议的默认管理距离：" class="headerlink" title="思科路由协议的默认管理距离："></a>思科路由协议的默认管理距离：</h3><p>default distances are:</p>
<ul>
<li>120 for RIP</li>
<li>100 for IGRP</li>
<li>90 for EIGRP</li>
<li>110 for OSPF</li>
</ul>
<p>By default, BGP has these distances:</p>
<ul>
<li>External distance—20</li>
<li>Internal distance—200</li>
<li>Local distance—200</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distance bgp external-distance internal-distance local-distance #调整BGP的默认管理距离</span><br></pre></td></tr></table></figure>
<p>如果想要优选IGP路由，有两种方式：</p>
<ol>
<li><p>更改BGP的默认管理距离。<strong>distance bgp</strong>  <strong>，不建议改变。</strong></p>
</li>
<li><p><strong>使用BGP（Backdoor）后门。</strong> BGP后门使IGP路由成为首选路由。</p>
</li>
</ol>
<p>所配置的网络是希望通过IGP访问的网络。对于BGP，这个网络与本地分配的网络得到相同的处理，只是BGP更新不会公布这个网络</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router bgp 100 </span><br><span class="line">neighbor 2.2.2.1 remote-as 300 </span><br><span class="line">network 160.10.0.0 backdoor</span><br></pre></td></tr></table></figure>
<p>网络160.10.0.0仅仅在本地有效，不发布给其他BGP邻居。</p>
<h3 id="BGP与IGP同步配置"><a href="#BGP与IGP同步配置" class="headerlink" title="BGP与IGP同步配置"></a>BGP与IGP同步配置</h3><p>同步状态下，如果您的AS从另一个AS传递流量到第三个AS, BGP不应该在您的AS中的所有路由器通过IGP了解路由之前发布路由广告。BGP会等待，直到IGP在AS中传播了路由。然后，BGP向外部同行宣传路线</p>
<p>禁止同步状态下，在某些情况下，不需要同步。如果您没有通过AS传递来自不同AS的流量可以禁用同步。也可以禁用同步，如果所有路由器在您的AS运行BGP。禁用此功能可以让您在IGP中携带更少的路由，并允许BGP更快地聚合。</p>
<p>同步的失效不是自动的。如果你所有的路由器在AS中运行BGP，而你根本不运行IGP，路由器就无从得知。在路由器将路由发送给外部节点之前，您的路由器无限期地等待关于某个路由的IGP更新。在这种情况下，你必须手动禁用同步，这样路由才能正常工作:</p>
<p>思科设备中IGP与BGP默认同步。需要手动关闭。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router bgp 100 </span><br><span class="line">no synchronization</span><br></pre></td></tr></table></figure>
<p>关闭后，必须重置邻居会话。</p>
<h3 id="Weight（权重）属性（思科私有属性）"><a href="#Weight（权重）属性（思科私有属性）" class="headerlink" title="Weight（权重）属性（思科私有属性）"></a>Weight（权重）属性（思科私有属性）</h3><p>weight属性是一个cisco定义的属性。此属性使用weight选择最佳路径。该weight在本地分配给路由器。该值只对特定的路由器有意义。该值不会通过任何路由更新传播或携带。权重可以是0到65,535之间的数字。路由器初始化的路径的默认权值为32,768，其他路径的权值为0</p>
<p><strong>当同一目的地存在多条路由时，具有较高权值的路由优先</strong></p>
<p>思科的Weight与华为PreVal值作用类似。 协议首选值（PrefVal）是<strong>华为设备</strong>的特有属性</p>
<p>Multiple mthods achieve this weight set:</p>
<p>Use the <strong>neighbor</strong> command.</p>
<p><strong>neighbor {*</strong>ip-address<em> <strong>|</strong> </em>peer-group<strong>*} weight</strong> <em>weight</em></p>
<p>Use AS_PATH access lists.</p>
<p><strong>ip as-path access-list</strong> <em>access-list-number</em> <strong>{permit | deny}</strong> <em>as-regular-expression</em> <strong>neighbor</strong> <em>ip-address</em> <strong>filter-list</strong> <em>access-list-number</em> <strong>weight</strong> <em>weight</em></p>
<p>Use route maps.</p>
<h3 id="Local-preference-本地优先级"><a href="#Local-preference-本地优先级" class="headerlink" title="Local-preference,本地优先级"></a>Local-preference,本地优先级</h3><p>本地优先级用于判断离开AS时的最佳路径。具有较高局部首选项的路径更受欢迎。本地首选项的默认值是100。</p>
<p>与仅与本地路由器相关的weight属性不同，本地首选项是路由器交换的属性在同一个AS中。</p>
<p><a href="https://www.cisco.com/en/US/docs/ios/12_3t/ip_route/command/reference/ip2_b1gt.html#wp1078941" target="_blank" rel="noopener">bgp default local-preference</a> value #配置默认local-preference</p>
<p>配置完，需要重置BGP连接。 <a href="https://www.cisco.com/en/US/docs/ios/12_3t/ip_route/command/reference/ip2_c1gt.html#wp1103308" target="_blank" rel="noopener">clear ip bgp</a> [soft][in/out]，使用soft不会破坏连接</p>
<h3 id="Metric（MED）-属性"><a href="#Metric（MED）-属性" class="headerlink" title="Metric（MED） 属性"></a>Metric（MED） 属性</h3><p>用于判断进入AS时的路径，优选Metric（MED）值小的路径。Metric在相邻AS之间传播。默认值为0.</p>
<p>除非路由器接收到其他方向，否则该路由器将比较来自邻居的路径指标。为了让路由器比较来自不同ASs的邻居的指标，您需要在路由器上发出特殊的配置命令bgp always-compare-med</p>
<p>bgp always-compare-med，配置从不通AS进来的路由比较MED，默认不比较。</p>
<p><strong>bgp deterministic-med</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-metric 50 #调整BGP MED值</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bgp bestpath as-path ignore #配置忽略as-path</span><br></pre></td></tr></table></figure>
<h3 id="Community属性"><a href="#Community属性" class="headerlink" title="Community属性"></a>Community属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set community community-number [additive] [well-known-community]</span><br></pre></td></tr></table></figure>
<p><strong>no-export</strong>—Do not advertise to eBGP peers. Keep this route within an AS.</p>
<p><strong>no-advertise</strong>—Do not advertise this route to any peer, internal or external.</p>
<p><strong>internet</strong>—Advertise this route to the Internet community. Any router belongs to this community.</p>
<p><strong>local-as</strong>—Use in confederation scenarios to prevent the transmit of packets outside the local AS.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neighbor &#123;ip-address | peer-group-name&#125; send-community #强制给邻居发送团体属性</span><br></pre></td></tr></table></figure>
<p> <strong>ip bgp-community new-format</strong> <strong>配置使用新格式显示团体属性AA：BB</strong></p>
<h2 id="BGP路由过滤"><a href="#BGP路由过滤" class="headerlink" title="BGP路由过滤"></a>BGP路由过滤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neighbor &#123;ip-address | peer-group-name&#125; distribute-list access-list-number &#123;in | out&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">router bgp 300 </span><br><span class="line">network 170.10.0.0 </span><br><span class="line">neighbor 3.3.3.3 remote-as 200 </span><br><span class="line">neighbor 2.2.2.2 remote-as 100 </span><br><span class="line">neighbor 2.2.2.2 distribute-list 1 out </span><br><span class="line">access-list 1 deny 160.10.0.0 0.0.255.255 </span><br><span class="line">access-list 1 permit 0.0.0.0 255.255.255.255 </span><br><span class="line"> </span><br><span class="line">ip as-path access-list access-list-number &#123;permit | deny&#125; as-regular-expression</span><br><span class="line">#配置as-path过滤</span><br><span class="line">neighbor &#123;ip-address | peer-group-name&#125; filter-list access-list-number &#123;in | out&#125;</span><br><span class="line">#配置acl过滤</span><br><span class="line"> </span><br><span class="line">BGP团体属性过滤：</span><br><span class="line">router bgp 200 </span><br><span class="line">network 160.10.0.0 </span><br><span class="line">neighbor 3.3.3.1 remote-as 300 </span><br><span class="line">neighbor 3.3.3.1 send-community </span><br><span class="line">neighbor 3.3.3.1 route-map setcommunity out </span><br><span class="line"> </span><br><span class="line">route-map setcommunity </span><br><span class="line">match ip address 1 </span><br><span class="line">set community no-export  </span><br><span class="line"> </span><br><span class="line">access-list 1 permit 0.0.0.0 255.255.255.255 </span><br><span class="line"> </span><br><span class="line">ip community-list community-list-number &#123;permit | deny&#125; community-number</span><br></pre></td></tr></table></figure>
<h2 id="BGP对等体组"><a href="#BGP对等体组" class="headerlink" title="BGP对等体组"></a>BGP对等体组</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neighbor peer-group-name peer-group</span><br></pre></td></tr></table></figure>
<p>配置示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router bgp 300 </span><br><span class="line">   neighbor externalmap peer-group </span><br><span class="line">   neighbor externalmap route-map SETMETRIC </span><br><span class="line">   neighbor externalmap filter-list 1 out </span><br><span class="line">   neighbor externalmap filter-list 2 in </span><br><span class="line">   neighbor 2.2.2.2 remote-as 100 </span><br><span class="line">   neighbor 2.2.2.2 peer-group externalmap </span><br><span class="line">   neighbor 4.4.4.2 remote-as 600 </span><br><span class="line">   neighbor 4.4.4.2 peer-group externalmap</span><br></pre></td></tr></table></figure>
<h2 id="路由聚合-1"><a href="#路由聚合-1" class="headerlink" title="路由聚合"></a>路由聚合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aggregate-address 160.0.0.0 255.0.0.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">aggregate-address address mask summary-only #只传输聚合路由</span><br><span class="line"> </span><br><span class="line">aggregate-address address-mask as-set #通告更具体的路由信息。</span><br><span class="line"> </span><br><span class="line">aggregate-address address-mask suppress-map map-name #抑制更详细路由信息</span><br><span class="line"> </span><br><span class="line">aggregate-address address-mask attribute-map map-name #允许在发布路由时，设置属性。</span><br><span class="line">例如：</span><br><span class="line">route-map SETMETRIC </span><br><span class="line">set origin igp </span><br><span class="line"> </span><br><span class="line">aggregate-address 160.0.0.0 255.0.0.0 attribute-map SETORIGIN</span><br></pre></td></tr></table></figure>
<h2 id="BGP联盟-1"><a href="#BGP联盟-1" class="headerlink" title="BGP联盟"></a>BGP联盟</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bgp confederation identifier autonomous-system</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bgp confederation peers autonomous-system [autonomous-system]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router bgp 50</span><br><span class="line">bgp confederation identifier 500</span><br><span class="line">bgp confederation peers 60 70</span><br><span class="line">neighbor 128.213.10.1 remote-as 50 (IBGP connection within AS50)</span><br><span class="line">neighbor 128.213.20.1 remote-as 50 (IBGP connection within AS50)</span><br><span class="line">neighbor 129.210.11.1 remote-as 60 (BGP connection with confederation peer 60)</span><br><span class="line">neighbor 135.212.14.1 remote-as 70 (BGP connection with confederation peer 70)</span><br><span class="line">neighbor 5.5.5.5 remote-as 100 (EBGP connection to external AS100)</span><br></pre></td></tr></table></figure>
<h2 id="BGP反射器"><a href="#BGP反射器" class="headerlink" title="BGP反射器"></a>BGP反射器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">neighbor route-reflector-client</span><br><span class="line"> </span><br><span class="line">router bgp 100</span><br><span class="line">neighbor 6.6.6.6 remote-as 100</span><br><span class="line">neighbor 6.6.6.6 route-reflector-client</span><br><span class="line">bgp cluster-id 10</span><br></pre></td></tr></table></figure>
<h2 id="BGP路由震荡"><a href="#BGP路由震荡" class="headerlink" title="BGP路由震荡"></a>BGP路由震荡</h2><p><strong>bgp dampening</strong>—Turns on dampening.</p>
<p><strong>no bgp dampening</strong>—Turns off dampening.</p>
<p><strong>bgp dampening</strong> <em>half-life-time</em> —Changes the half-life time.</p>
<p><strong>bgp dampening</strong> <em>half-life-time</em> <em>reuse</em> <em>suppress</em> <em>maximum-suppress-time</em></p>
<p>This list details the syntax:</p>
<p><em>half-life-time</em> —The range is 1–45 minutes, and the current default is 15 minutes.</p>
<p><em>reuse-value</em> —The range is 1–20,000, and the default is 750.</p>
<p><em>suppress-value</em> —The range is 1–20,000, and the default is 2000.</p>
<p><em>max-suppress-time</em> —This is the maximum duration for the suppression of a route. The range is 1–255 minutes, and the default is 4 times the half-life time.</p>
<hr>
<blockquote>
<p> 备注：以上资料整理自以下三个网站，有华为，华三，思科三个厂商官网的BGP相关资料。放这里是为了自己查看方便。同时，有需要的可以参考参考。</p>
</blockquote>
<blockquote>
<p>官方文档BGP相关资料：</p>
<p>华为：<a href="https://support.huawei.com/hedex/hdx.do?docid=EDOC1100101225&amp;lang=zh&amp;idPath=24030814%7C21782165%7C21782236%7C22318638%7C7542409" target="_blank" rel="noopener">https://support.huawei.com/hedex/hdx.do?docid=EDOC1100101225&amp;lang=zh&amp;idPath=24030814%7C21782165%7C21782236%7C22318638%7C7542409</a></p>
<p>华三：<a href="http://www.h3c.com/cn/d_201601/909969_30005_0.htm" target="_blank" rel="noopener">http://www.h3c.com/cn/d_201601/909969_30005_0.htm</a></p>
<p>思科：<a href="https://www.cisco.com/c/en/us/tech/ip/ip-routing/index.html" target="_blank" rel="noopener">https://www.cisco.com/c/en/us/tech/ip/ip-routing/index.html</a></p>
</blockquote>
<hr>

      
    </div>

    
      


    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/微信.png" alt="曹世宏 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/支付宝.jpg" alt="曹世宏 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>曹世宏</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/" title="BGP知识手册(华为,华三,思科)">https://cshihong.github.io/2020/04/18/BGP知识手册-华为-华三-思科/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
<br>
  <li class="post-copyright-link">
    <strong>字节跳动社招内推：<a href="https://job.toutiao.com/s/Jy89E4s">https://job.toutiao.com/s/Jy89E4s</a></strong><br>
    <strong>字节跳动校招内推码：<a href="https://job.toutiao.com/s/Jy8BSv6">YYG5KEY</a></strong><br>
    <strong>字节跳动校招投递链接:<a href="https://job.toutiao.com/s/Jy8BSv6">https://job.toutiao.com/s/Jy8BSv6</a></strong><br>
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/BGP/" rel="tag"># BGP</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
               <div>
                 
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>

               </div>
            
            
               <div id="needsharebutton-postbottom">
                 <span class="btn">
                    <i class="fa fa-share-alt" aria-hidden="true"></i>
                 </span>
               </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/29/python通过nmap扫描在线设备并尝试AAA登录/" rel="next" title="python通过nmap扫描在线设备并尝试AAA登录">
                <i class="fa fa-chevron-left"></i> python通过nmap扫描在线设备并尝试AAA登录
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/18/BGP-in-the-datacenter-数据中心的BGP-数据中心网络架构-Clos网络架构/" rel="prev" title="(BGP in the datacenter)数据中心的BGP,数据中心网络架构,Clos网络架构">
                (BGP in the datacenter)数据中心的BGP,数据中心网络架构,Clos网络架构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDc1NS83MzA3"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/touxiang.jpg" alt="曹世宏">
            
              <p class="site-author-name" itemprop="name">曹世宏</p>
              <p class="site-description motion-element" itemprop="description">你的责任就是你的方向，你的经历就是你的资本，你的性格就是你的命运。</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">264</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">135</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/cshihong/cshihong.github.io" title="GitHub &rarr; https://github.com/cshihong/cshihong.github.io" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:cshihong96@gmail.com" title="E-Mail &rarr; mailto:cshihong96@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://user.qzone.qq.com/731507579?ptlang=2052&source=friendlist" title="qq &rarr; https://user.qzone.qq.com/731507579?ptlang=2052&source=friendlist" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>qq</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="http://blog.csdn.net/qq_38265137" title="CSDN &rarr; http://blog.csdn.net/qq_38265137" rel="noopener" target="_blank"><i class="fa fa-fw fa-meh-o"></i>CSDN</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/qq_38265137" title="http://blog.csdn.net/qq_38265137" rel="noopener" target="_blank">我的CSDN</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://support.huawei.com/learning/NavigationAction!createNavi?navId=MW000001_term1000025144&lang=zh" title="http://support.huawei.com/learning/NavigationAction!createNavi?navId=MW000001_term1000025144&lang=zh" rel="noopener" target="_blank">华为培训认证</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://bbs.hh010.com/" title="http://bbs.hh010.com/" rel="noopener" target="_blank">鸿鹄论坛</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://m.blog.csdn.net/home/index" title="http://m.blog.csdn.net/home/index" rel="noopener" target="_blank">CSDN博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.cnblogs.com/" title="https://www.cnblogs.com/" rel="noopener" target="_blank">博客园</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.w3school.com.cn/index.html" title="http://www.w3school.com.cn/index.html" rel="noopener" target="_blank">w3cshool</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.51cto.com" title="http://www.51cto.com" rel="noopener" target="_blank">51cto</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#BGP介绍"><span class="nav-number">1.</span> <span class="nav-text">BGP介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义："><span class="nav-number">1.1.</span> <span class="nav-text">定义：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目的："><span class="nav-number">1.2.</span> <span class="nav-text">目的：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#受益："><span class="nav-number">1.3.</span> <span class="nav-text">受益：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP特点"><span class="nav-number">1.4.</span> <span class="nav-text">BGP特点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BGP原理描述"><span class="nav-number">2.</span> <span class="nav-text">BGP原理描述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP基本概念"><span class="nav-number">2.1.</span> <span class="nav-text">BGP基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自治系统AS（Autonomous-System）"><span class="nav-number">2.1.1.</span> <span class="nav-text">自治系统AS（Autonomous System）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AS号规划："><span class="nav-number">2.2.</span> <span class="nav-text">AS号规划：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP分类"><span class="nav-number">2.2.1.</span> <span class="nav-text">BGP分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP报文交互中的角色"><span class="nav-number">2.2.2.</span> <span class="nav-text">BGP报文交互中的角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP的路由器号（Router-ID）"><span class="nav-number">2.2.3.</span> <span class="nav-text">BGP的路由器号（Router ID）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP工作原理"><span class="nav-number">2.3.</span> <span class="nav-text">BGP工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP的报文"><span class="nav-number">2.3.1.</span> <span class="nav-text">BGP的报文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP状态机"><span class="nav-number">2.3.2.</span> <span class="nav-text">BGP状态机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP对等体之间的交互原则"><span class="nav-number">2.3.3.</span> <span class="nav-text">BGP对等体之间的交互原则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#华为设备："><span class="nav-number">2.3.3.1.</span> <span class="nav-text">华为设备：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#华三设备发布路由的策略"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">华三设备发布路由的策略</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP与IGP进行交互"><span class="nav-number">2.4.</span> <span class="nav-text">BGP与IGP进行交互</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP引入IGP路由"><span class="nav-number">2.4.1.</span> <span class="nav-text">BGP引入IGP路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IGP引入BGP路由"><span class="nav-number">2.4.2.</span> <span class="nav-text">IGP引入BGP路由</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP安全性"><span class="nav-number">2.5.</span> <span class="nav-text">BGP安全性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP认证"><span class="nav-number">2.5.1.</span> <span class="nav-text">BGP认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP-GTSM"><span class="nav-number">2.5.2.</span> <span class="nav-text">BGP GTSM</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP的路由优选规则和负载分担"><span class="nav-number">2.6.</span> <span class="nav-text">BGP的路由优选规则和负载分担</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP属性"><span class="nav-number">2.6.1.</span> <span class="nav-text">BGP属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Origin属性"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">Origin属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AS-Path属性"><span class="nav-number">2.6.1.2.</span> <span class="nav-text">AS_Path属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Next-Hop属性"><span class="nav-number">2.6.1.3.</span> <span class="nav-text">Next_Hop属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Local-Pref属性"><span class="nav-number">2.6.1.4.</span> <span class="nav-text">Local_Pref属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MED属性"><span class="nav-number">2.6.1.5.</span> <span class="nav-text">MED属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#团体属性"><span class="nav-number">2.6.1.6.</span> <span class="nav-text">团体属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#扩展团体属性"><span class="nav-number">2.6.1.7.</span> <span class="nav-text">扩展团体属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Originator-ID属性"><span class="nav-number">2.6.1.8.</span> <span class="nav-text">Originator_ID属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cluster-list属性"><span class="nav-number">2.6.1.9.</span> <span class="nav-text">Cluster_list属性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP选择路由的策略"><span class="nav-number">2.6.2.</span> <span class="nav-text">BGP选择路由的策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#华为设备BGP选路原则："><span class="nav-number">2.6.2.1.</span> <span class="nav-text">华为设备BGP选路原则：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#华三BGP选路原则"><span class="nav-number">2.6.2.2.</span> <span class="nav-text">华三BGP选路原则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#思科BGP选路原则："><span class="nav-number">2.6.2.3.</span> <span class="nav-text">思科BGP选路原则：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP负载分担"><span class="nav-number">2.6.3.</span> <span class="nav-text">BGP负载分担</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由反射器"><span class="nav-number">2.7.</span> <span class="nav-text">路由反射器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#路由反射器相关角色"><span class="nav-number">2.7.1.</span> <span class="nav-text">路由反射器相关角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由反射器原理"><span class="nav-number">2.7.2.</span> <span class="nav-text">路由反射器原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cluster-List属性"><span class="nav-number">2.7.3.</span> <span class="nav-text">Cluster_List属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#备份路由反射器"><span class="nav-number">2.7.4.</span> <span class="nav-text">备份路由反射器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多集群路由反射器"><span class="nav-number">2.7.5.</span> <span class="nav-text">多集群路由反射器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分级的路由反射器"><span class="nav-number">2.7.5.1.</span> <span class="nav-text">分级的路由反射器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#同级路由反射器"><span class="nav-number">2.7.5.2.</span> <span class="nav-text">同级路由反射器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP联盟"><span class="nav-number">2.8.</span> <span class="nav-text">BGP联盟</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#路由反射器和联盟的比较"><span class="nav-number">2.8.1.</span> <span class="nav-text">路由反射器和联盟的比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由聚合"><span class="nav-number">2.9.</span> <span class="nav-text">路由聚合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由衰减"><span class="nav-number">2.10.</span> <span class="nav-text">路由衰减</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BMP"><span class="nav-number">2.11.</span> <span class="nav-text">BMP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BMP消息类型"><span class="nav-number">2.11.1.</span> <span class="nav-text">BMP消息类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BMP工作原理"><span class="nav-number">2.11.2.</span> <span class="nav-text">BMP工作原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP与BFD联动"><span class="nav-number">2.12.</span> <span class="nav-text">BGP与BFD联动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP-Auto-FRR"><span class="nav-number">2.13.</span> <span class="nav-text">BGP Auto FRR</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#应用"><span class="nav-number">2.13.1.</span> <span class="nav-text">应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP-GR和NSR"><span class="nav-number">2.14.</span> <span class="nav-text">BGP GR和NSR</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP-GR"><span class="nav-number">2.14.1.</span> <span class="nav-text">BGP GR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP-NSR"><span class="nav-number">2.14.2.</span> <span class="nav-text">BGP NSR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#有无GR、NSR技术的比较"><span class="nav-number">2.14.3.</span> <span class="nav-text">有无GR、NSR技术的比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP-ORF"><span class="nav-number">2.15.</span> <span class="nav-text">BGP ORF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#应用："><span class="nav-number">2.15.1.</span> <span class="nav-text">应用：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP按组打包"><span class="nav-number">2.16.</span> <span class="nav-text">BGP按组打包</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#应用-1"><span class="nav-number">2.16.1.</span> <span class="nav-text">应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在国际关口局场景"><span class="nav-number">2.16.1.1.</span> <span class="nav-text">在国际关口局场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#路由反射器场景"><span class="nav-number">2.16.1.2.</span> <span class="nav-text">路由反射器场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ASBR场景"><span class="nav-number">2.16.1.3.</span> <span class="nav-text">ASBR场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MP-BGP"><span class="nav-number">2.17.</span> <span class="nav-text">MP-BGP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展属性"><span class="nav-number">2.17.1.</span> <span class="nav-text">扩展属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#地址族"><span class="nav-number">2.17.2.</span> <span class="nav-text">地址族</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP多进程（华三）"><span class="nav-number">2.18.</span> <span class="nav-text">BGP多进程（华三）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#华为设备BGP相关配置"><span class="nav-number">3.</span> <span class="nav-text">华为设备BGP相关配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP配置任务概览"><span class="nav-number">3.1.</span> <span class="nav-text">BGP配置任务概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#华为CE系列交换机BGP默认参数"><span class="nav-number">3.2.</span> <span class="nav-text">华为CE系列交换机BGP默认参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP的基本功能"><span class="nav-number">3.3.</span> <span class="nav-text">配置BGP的基本功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#（可选）配置BGP-4字节AS号的显示格式"><span class="nav-number">3.3.1.</span> <span class="nav-text">（可选）配置BGP 4字节AS号的显示格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动BGP进程"><span class="nav-number">3.3.2.</span> <span class="nav-text">启动BGP进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP对等体"><span class="nav-number">3.3.3.</span> <span class="nav-text">配置BGP对等体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP对等体组"><span class="nav-number">3.3.4.</span> <span class="nav-text">配置BGP对等体组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP引入路由"><span class="nav-number">3.3.5.</span> <span class="nav-text">配置BGP引入路由</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP安全性"><span class="nav-number">3.4.</span> <span class="nav-text">配置BGP安全性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置MD5认证"><span class="nav-number">3.4.1.</span> <span class="nav-text">配置MD5认证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP路由选路和负载负担"><span class="nav-number">3.5.</span> <span class="nav-text">配置BGP路由选路和负载负担</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP协议优先级"><span class="nav-number">3.5.1.</span> <span class="nav-text">配置BGP协议优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Next-Hop属性"><span class="nav-number">3.5.2.</span> <span class="nav-text">配置Next_Hop属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP路由信息的首选值"><span class="nav-number">3.5.3.</span> <span class="nav-text">配置BGP路由信息的首选值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置本机缺省Local-Pref属性"><span class="nav-number">3.5.4.</span> <span class="nav-text">配置本机缺省Local_Pref属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置AS-Path属性"><span class="nav-number">3.5.5.</span> <span class="nav-text">配置AS_Path属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#apply-as-path"><span class="nav-number">3.5.5.1.</span> <span class="nav-text">apply as-path</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bestroute-as-path-ignore"><span class="nav-number">3.5.5.2.</span> <span class="nav-text">bestroute as-path-ignore</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置MED属性"><span class="nav-number">3.5.6.</span> <span class="nav-text">配置MED属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP团体属性"><span class="nav-number">3.5.7.</span> <span class="nav-text">配置BGP团体属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP负载分担"><span class="nav-number">3.5.8.</span> <span class="nav-text">配置BGP负载分担</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制BGP路由的发布和接收"><span class="nav-number">3.6.</span> <span class="nav-text">控制BGP路由的发布和接收</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#控制BGP路由信息的发布"><span class="nav-number">3.6.1.</span> <span class="nav-text">控制BGP路由信息的发布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制BGP路由信息的接收"><span class="nav-number">3.6.2.</span> <span class="nav-text">控制BGP路由信息的接收</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP软复位"><span class="nav-number">3.6.3.</span> <span class="nav-text">配置BGP软复位</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置调整BGP网络的收敛速度"><span class="nav-number">3.7.</span> <span class="nav-text">配置调整BGP网络的收敛速度</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP连接重传定时器"><span class="nav-number">3.7.1.</span> <span class="nav-text">配置BGP连接重传定时器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP存活时间和保持时间定时器"><span class="nav-number">3.7.2.</span> <span class="nav-text">配置BGP存活时间和保持时间定时器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置更新报文定时器"><span class="nav-number">3.7.3.</span> <span class="nav-text">配置更新报文定时器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置EBGP连接快速复位"><span class="nav-number">3.7.4.</span> <span class="nav-text">配置EBGP连接快速复位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP路由震荡抑制"><span class="nav-number">3.7.5.</span> <span class="nav-text">配置BGP路由震荡抑制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP可靠性"><span class="nav-number">3.8.</span> <span class="nav-text">配置BGP可靠性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BFD-For-BGP"><span class="nav-number">3.8.1.</span> <span class="nav-text">配置BFD For BGP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP-Auto-FRR-1"><span class="nav-number">3.8.2.</span> <span class="nav-text">BGP Auto FRR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP-GR"><span class="nav-number">3.8.3.</span> <span class="nav-text">配置BGP GR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP路由聚合"><span class="nav-number">3.9.</span> <span class="nav-text">配置BGP路由聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP自动聚合"><span class="nav-number">3.9.1.</span> <span class="nav-text">配置BGP自动聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP手动聚合"><span class="nav-number">3.9.2.</span> <span class="nav-text">配置BGP手动聚合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置向对等体发送缺省路由"><span class="nav-number">3.10.</span> <span class="nav-text">配置向对等体发送缺省路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BMP"><span class="nav-number">3.11.</span> <span class="nav-text">配置BMP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#维护BGP"><span class="nav-number">3.12.</span> <span class="nav-text">维护BGP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#复位BGP连接"><span class="nav-number">3.12.1.</span> <span class="nav-text">复位BGP连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#清除BGP统计信息"><span class="nav-number">3.12.2.</span> <span class="nav-text">清除BGP统计信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#华三设备BGP相关配置"><span class="nav-number">4.</span> <span class="nav-text">华三设备BGP相关配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP基本功能"><span class="nav-number">4.1.</span> <span class="nav-text">配置BGP基本功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#动态创建BGP对等体"><span class="nav-number">4.1.1.</span> <span class="nav-text">动态创建BGP对等体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置EBGP对等体组"><span class="nav-number">4.1.2.</span> <span class="nav-text">配置EBGP对等体组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置建立TCP连接使用的源地址"><span class="nav-number">4.1.3.</span> <span class="nav-text">配置建立TCP连接使用的源地址</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制BGP路由信息的发布与接收"><span class="nav-number">4.2.</span> <span class="nav-text">控制BGP路由信息的发布与接收</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP路由聚合-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">配置BGP路由聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置发布IP路由表中的最优路由"><span class="nav-number">4.2.2.</span> <span class="nav-text">配置发布IP路由表中的最优路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置优先发送缺省路由的更新信息"><span class="nav-number">4.2.3.</span> <span class="nav-text">配置优先发送缺省路由的更新信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#限制从BGP对等体-对等体组接收的路由数量"><span class="nav-number">4.2.4.</span> <span class="nav-text">限制从BGP对等体/对等体组接收的路由数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP路由信息的发布接收策略"><span class="nav-number">4.2.5.</span> <span class="nav-text">配置BGP路由信息的发布接收策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP新增路由发布速率"><span class="nav-number">4.2.6.</span> <span class="nav-text">配置BGP新增路由发布速率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP延迟发布"><span class="nav-number">4.2.7.</span> <span class="nav-text">配置BGP延迟发布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置设备启动时为BGP路由应用启动策略"><span class="nav-number">4.2.8.</span> <span class="nav-text">配置设备启动时为BGP路由应用启动策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP路径的选择"><span class="nav-number">4.3.</span> <span class="nav-text">配置BGP路径的选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置MED属性-1"><span class="nav-number">4.3.1.</span> <span class="nav-text">配置MED属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置AS-Path属性-1"><span class="nav-number">4.3.2.</span> <span class="nav-text">配置AS_Path属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP在选择最优路由时忽略IGP-Metric的比较"><span class="nav-number">4.3.3.</span> <span class="nav-text">配置BGP在选择最优路由时忽略IGP Metric的比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置SoO属性"><span class="nav-number">4.3.4.</span> <span class="nav-text">配置SoO属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调整和优化BGP网络"><span class="nav-number">4.4.</span> <span class="nav-text">调整和优化BGP网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP会话的存活时间间隔与保持时间"><span class="nav-number">4.4.1.</span> <span class="nav-text">配置BGP会话的存活时间间隔与保持时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置重新建立BGP会话的时间间隔"><span class="nav-number">4.4.2.</span> <span class="nav-text">配置重新建立BGP会话的时间间隔</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置发布同一路由的时间间隔"><span class="nav-number">4.4.3.</span> <span class="nav-text">配置发布同一路由的时间间隔</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使能直连EBGP会话快速复位功能"><span class="nav-number">4.4.4.</span> <span class="nav-text">使能直连EBGP会话快速复位功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使能4字节AS号抑制功能"><span class="nav-number">4.4.5.</span> <span class="nav-text">使能4字节AS号抑制功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP的MD5认证"><span class="nav-number">4.4.6.</span> <span class="nav-text">配置BGP的MD5认证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP负载分担-1"><span class="nav-number">4.5.</span> <span class="nav-text">配置BGP负载分担</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#禁止与对等体建立会话"><span class="nav-number">4.6.</span> <span class="nav-text">禁止与对等体建立会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP-NSR"><span class="nav-number">4.7.</span> <span class="nav-text">配置BGP NSR</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP功能特性"><span class="nav-number">4.7.1.</span> <span class="nav-text">BGP功能特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启告警功能"><span class="nav-number">4.7.2.</span> <span class="nav-text">开启告警功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使能BGP日志功能"><span class="nav-number">4.7.3.</span> <span class="nav-text">使能BGP日志功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使能BGP的路由抖动日志记录功能"><span class="nav-number">4.7.4.</span> <span class="nav-text">使能BGP的路由抖动日志记录功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP与BFD联动"><span class="nav-number">4.7.5.</span> <span class="nav-text">配置BGP与BFD联动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置BGP快速重路由"><span class="nav-number">4.7.6.</span> <span class="nav-text">配置BGP快速重路由</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#思科BGP相关配置"><span class="nav-number">5.</span> <span class="nav-text">思科BGP相关配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置BGP基础功能"><span class="nav-number">5.1.</span> <span class="nav-text">配置BGP基础功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP的Loopback接口和EBGP多跳："><span class="nav-number">5.1.1.</span> <span class="nav-text">BGP的Loopback接口和EBGP多跳：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP中控制路由的接收与发送"><span class="nav-number">5.2.</span> <span class="nav-text">BGP中控制路由的接收与发送</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP宣告网络"><span class="nav-number">5.2.1.</span> <span class="nav-text">BGP宣告网络</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#思科设备BGP选路原则"><span class="nav-number">5.3.</span> <span class="nav-text">思科设备BGP选路原则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#思科路由协议的默认管理距离："><span class="nav-number">5.3.1.</span> <span class="nav-text">思科路由协议的默认管理距离：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP与IGP同步配置"><span class="nav-number">5.3.2.</span> <span class="nav-text">BGP与IGP同步配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Weight（权重）属性（思科私有属性）"><span class="nav-number">5.3.3.</span> <span class="nav-text">Weight（权重）属性（思科私有属性）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Local-preference-本地优先级"><span class="nav-number">5.3.4.</span> <span class="nav-text">Local-preference,本地优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Metric（MED）-属性"><span class="nav-number">5.3.5.</span> <span class="nav-text">Metric（MED） 属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Community属性"><span class="nav-number">5.3.6.</span> <span class="nav-text">Community属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP路由过滤"><span class="nav-number">5.4.</span> <span class="nav-text">BGP路由过滤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP对等体组"><span class="nav-number">5.5.</span> <span class="nav-text">BGP对等体组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由聚合-1"><span class="nav-number">5.6.</span> <span class="nav-text">路由聚合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP联盟-1"><span class="nav-number">5.7.</span> <span class="nav-text">BGP联盟</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP反射器"><span class="nav-number">5.8.</span> <span class="nav-text">BGP反射器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP路由震荡"><span class="nav-number">5.9.</span> <span class="nav-text">BGP路由震荡</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">曹世宏</span>

  

  
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">全站共 1.1m 字</span>
</div>











        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>






  <script>
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=66140664";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script src="//cdn.jsdelivr.net/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script src="//cdn.jsdelivr.net/velocity/1.2.1/velocity.ui.min.js"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.6.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.6.0"></script>
<script src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  
    <script>
      window.livereOptions = {
        refer: '2020/04/18/BGP知识手册-华为-华三-思科/'
      };
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  
  
    
  
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1.0.0/needsharebutton.min.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook,Mailto";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook,";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  
  <script src="/js/src/js.cookie.js?v=6.6.0"></script>
  <script src="/js/src/scroll-cookie.js?v=6.6.0"></script>


  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  
  

  
  

  


</body>
</html>
